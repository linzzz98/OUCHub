

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>EPnP &mdash; OUCHub  文档</title>
  

  
  <link rel="stylesheet" href="../../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../_static/twemoji.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../_static/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../../" src="../../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../../_static/jquery.js"></script>
        <script src="../../../../../../_static/underscore.js"></script>
        <script src="../../../../../../_static/doctools.js"></script>
        <script src="../../../../../../_static/language_data.js"></script>
        <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js"></script>
        <script src="../../../../../../_static/twemoji.js"></script>
        <script src="../../../../../../_static/translations.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../../../../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../../../../search.html" />
    <link rel="next" title="P3P" href="../P3P/P3P.html" />
    <link rel="prev" title="3. PnP" href="../PnP.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: black" >
          

          
            <a href="../../../../../../index.html" class="icon icon-home"> OUCHub
          

          
            
            <img src="../../../../../../_static/logo_2.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">基础知识</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../knowledge/k_MH.html">💊 Math</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../knowledge/k_CV.html">🍤 Computer Vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../knowledge/k_ML.html">🍎 Machine Learning</a></li>
</ul>
<p class="caption"><span class="caption-text">论文学习</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../paper/p_sfm.html">🍊 Structure from Motion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../paper/p_pointcloud.html">🍋 Point Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../paper/p_others.html">🍒 Others</a></li>
</ul>
<p class="caption"><span class="caption-text">源码解析</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../../colmap.html">🍑 Colmap</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../c_base.html">Base</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../c_estimator.html">Estimator</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../Pose/Pose.html">1. Pose</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Utils/Utils.html">2. Utils</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="../PnP.html">3. PnP</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">EPnP</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id1">论文解读</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id3">成员变量</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id4">成员函数</a><ul>
<li class="toctree-l6"><a class="reference internal" href="#estimate">Estimate</a></li>
<li class="toctree-l6"><a class="reference internal" href="#computepose">ComputePose</a></li>
<li class="toctree-l6"><a class="reference internal" href="#choosecontrolpoints">ChooseControlPoints</a></li>
<li class="toctree-l6"><a class="reference internal" href="#computebarycentriccoordinates">ComputeBarycentricCoordinates</a></li>
<li class="toctree-l6"><a class="reference internal" href="#computem">ComputeM</a></li>
<li class="toctree-l6"><a class="reference internal" href="#computel6x10">ComputeL6x10</a></li>
<li class="toctree-l6"><a class="reference internal" href="#computerho">ComputeRho</a></li>
<li class="toctree-l6"><a class="reference internal" href="#findbetasapprox1">FindBetasApprox1</a></li>
<li class="toctree-l6"><a class="reference internal" href="#findbetasapprox2">FindBetasApprox2</a></li>
<li class="toctree-l6"><a class="reference internal" href="#findbetasapprox3">FindBetasApprox3</a></li>
<li class="toctree-l6"><a class="reference internal" href="#rungaussnewton">RunGaussNewton</a></li>
<li class="toctree-l6"><a class="reference internal" href="#computert">ComputeRT</a></li>
<li class="toctree-l6"><a class="reference internal" href="#estimatert">EstimateRT</a></li>
<li class="toctree-l6"><a class="reference internal" href="#computetotalreprojectionerror">ComputeTotalReprojectionError</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../P3P/P3P.html">P3P</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../Matrix/Matrix.html">4. Matrix</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Triangulation/Triangulation.html">5. Triangulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Transform/AffineTransform/AffineTransform.html">6. AffineTransform</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Transform/SimilarityTransform/SimilarityTransform.html">7. SimilarityTransform</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Transform/TranslationTransform/TranslationTransform.html">8. TranslationTransform</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../TwoViewGeometry/TwoViewGeometry.html">9. TwoViewGeometry</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../Generalized/Generalized_Relative_Pose/Generalized_Relative_Pose.html">10. Generalized_RelativePose</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../c_sfm.html">SfM Pipeline</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../theiasfm.html">🍑 TheiaSfM</a></li>
</ul>
<p class="caption"><span class="caption-text">杂七杂八</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../others/o_others.html">🍺 Others</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">OUCHub</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../../colmap.html">🍑 Colmap</a> &raquo;</li>
        
          <li><a href="../../../c_estimator.html">Estimator</a> &raquo;</li>
        
          <li><a href="../PnP.html"><span class="section-number">3. </span>PnP</a> &raquo;</li>
        
      <li>EPnP</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../../../../_sources/pages/code/colmap/estimator/PnP/EPnP/EPnP.rst.txt" rel="nofollow"> 查看页面源码</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="epnp">
<h1>EPnP<a class="headerlink" href="#epnp" title="永久链接至标题">¶</a></h1>
<p>EPNP求解器，用于解决PNP(Perspective-n-Point)问题。 求解器至少需要4个2D-3D对应关系（对于共面的情况只需要3对）。</p>
<pre class="literal-block"><a class="reference external" href="http://www.iri.upc.edu/people/fmoreno/Publications/2009/pdf/Lepetit_ijcv2009.pdf">Epnp: An accurate o (n) solution to the pnp problem</a></pre>
<div class="section" id="id1">
<h2>论文解读<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<div class="admonition attention">
<p class="admonition-title">注意</p>
<p>本章参考自 👉    <a class="reference external" href="https://blog.csdn.net/jessecw79/article/details/82945918">《深入EPnP算法》</a></p>
</div>
<p>在论文中，采用上标 <span class="math notranslate nohighlight">\(^w\)</span> 和 <span class="math notranslate nohighlight">\(^c\)</span> 表示在世界坐标系和摄像头坐标系中的坐标。那么：</p>
<dl class="field-list simple">
<dt class="field-odd">3D参考点</dt>
<dd class="field-odd"><p></p></dd>
</dl>
<ul class="simple">
<li><p>在世界坐标系中的坐标为 <span class="math notranslate nohighlight">\(p_i^w, ~~~i = 1,...,n\)</span></p></li>
<li><p>在相机参考坐标系中的坐标为 <span class="math notranslate nohighlight">\(p_i^c, ~~~i = 1,...,n\)</span></p></li>
</ul>
<dl class="field-list simple">
<dt class="field-odd">4个控制点</dt>
<dd class="field-odd"><p></p></dd>
</dl>
<ul class="simple">
<li><p>在世界坐标系的坐标为 <span class="math notranslate nohighlight">\(c_j^w, ~~~j = 1,...,4\)</span></p></li>
<li><p>在相机参考坐标系中的坐标为 <span class="math notranslate nohighlight">\(p_j^c, ~~~j = 1,...,4\)</span></p></li>
</ul>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>在EPnP论文中，以上坐标均为非齐次坐标。</p>
</div>
<p>EPnP算法将参考点的坐标表示为控制点坐标的加权和：</p>
<blockquote>
<div><div class="math notranslate nohighlight">
\[p_i^w = \sum\limits_{j=1}^4 \alpha_{ij}c_j^w, ~~~ with \sum\limits_{j=1}^4 \alpha_{ij} = 1\]</div>
</div></blockquote>
<p>其中 <span class="math notranslate nohighlight">\(\alpha_{ij}\)</span> 是 <code class="docutils literal notranslate"><span class="pre">齐次的barycentric坐标</span></code></p>
<p>一旦虚拟控制点确定后，且满足4个控制点不共面的前提， <span class="math notranslate nohighlight">\(\alpha_{ij}\)</span> 唯一被确定。</p>
<p>在相机坐标系中存在同样的加权关系：</p>
<div class="math notranslate nohighlight">
\[p_i^c = \sum\limits_{j=1}^4 \alpha_{ij}c_j^c\]</div>
<p>假设相机的外参为 <span class="math notranslate nohighlight">\([R, t]\)</span>， 那么虚拟控制点 <span class="math notranslate nohighlight">\(c_j^w\)</span> 和 <span class="math notranslate nohighlight">\(c_j^c\)</span> 之间存在关系：</p>
<div class="math notranslate nohighlight">
\[\begin{split}c_j^c = [R~~~t]\left[
\begin{matrix}
c_j^w \\ 1
\end{matrix}
\right]\end{split}\]</div>
<p>考虑到EPnP算法将参考点坐标表示为控制点坐标的加权和，可以得到：</p>
<div class="math notranslate nohighlight">
\[\begin{split}p_i^c = [R~~~t] \left[
\begin{matrix}
p_j^w \\ 1
\end{matrix}
\right] = [R~~~t] \left[
\begin{matrix}
\sum\limits_{j=1}^4 \alpha_{ij}c_j^w \\ 1
\end{matrix}
\right]\end{split}\]</div>
<p>进而 👇 ：</p>
<div class="math notranslate nohighlight">
\[\begin{split}p_i^c = [R~~~t]\left[
\begin{matrix}
\sum\limits_{j=1}^4 \alpha_{ij}c_j^w \\ \sum\limits_{j=1}^4 \alpha_{ij}
\end{matrix}
\right] = \sum\limits_{j=1}^4 \alpha_{ij}[R~~~t]\left[
\begin{matrix}
c_j^w \\ 1
\end{matrix}
\right] = \sum\limits_{j=1}^4 \alpha_{ij}c_j^c\end{split}\]</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>在上述推导过程中，用到了EPnP对权重 <span class="math notranslate nohighlight">\(\alpha_{ij}\)</span> 的重要约束条件 <span class="math notranslate nohighlight">\(\sum\limits_{j=1}^4 \alpha_{ij} = 1\)</span></p>
</div>
<div class="admonition attention">
<p class="admonition-title">注意</p>
<p>注意：在上面的推导中不难发现，同一3D点在世界坐标系下的 <strong>齐次重心坐标</strong> 与其在相机坐标系下的相同。这意味着，可以预先在世界坐标系下求取齐次重心坐标的 <span class="math notranslate nohighlight">\(a_{ij}\)</span> ，然后将其作为已知量拿到相机坐标系下使用。</p>
</div>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>当四个控制点堆叠在一起时：</p>
<div class="math notranslate nohighlight">
\[\begin{split}\left[
\begin{matrix}
p_i^w\\1
\end{matrix}
\right] = C \left[
\begin{matrix}
\alpha_{i1}\\ \alpha_{i2} \\ \alpha_{i3} \\ \alpha_{i4}
\end{matrix}
\right] = \left[
\begin{matrix}
c_1^w &amp; c_2^w &amp; c_3^w &amp; c_4^w\\
1 &amp; 1 &amp; 1 &amp; 1
\end{matrix}
\right]\left[
\begin{matrix}
\alpha_{i1} \\ \alpha_{i2} \\ \alpha_{i3} \\ \alpha_{i4}
\end{matrix}
\right]\end{split}\]</div>
<p>⭐ 也就论证了论文中之前提到的</p>
<div class="math notranslate nohighlight">
\[p_i^w = \sum\limits_{j=1}^4 \alpha_{ij}c_j^w, ~~~ with \sum\limits_{j=1}^4 \alpha_{ij} = 1\]</div>
<p>本质上说明了3D参考的的齐次坐标是控制点齐次坐标的线性组合。</p>
</div>
</div>
<div class="section" id="id3">
<h2>成员变量<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<ol class="arabic">
<li><p>2D图像特征观察值</p>
<blockquote>
<div><p><a class="reference internal" href="../PnP.html#_CPPv43X_t" title="X_t"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">X_t</span></code></a></p>
</div></blockquote>
</li>
<li><p>世界框架中观察到的3D特征</p>
<blockquote>
<div><p><a class="reference internal" href="../PnP.html#_CPPv43Y_t" title="Y_t"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">Y_t</span></code></a></p>
</div></blockquote>
</li>
<li><p>从世界到相机框架的转变</p>
<blockquote>
<div><p><a class="reference internal" href="../PnP.html#_CPPv43M_t" title="M_t"><code class="xref cpp cpp-type docutils literal notranslate"><span class="pre">M_t</span></code></a></p>
</div></blockquote>
</li>
<li><p>估计模型所需的最少样本数</p>
<blockquote>
<div><p><a class="reference internal" href="../PnP.html#_CPPv414kMinNumSamples" title="kMinNumSamples"><code class="xref cpp cpp-member docutils literal notranslate"><span class="pre">kMinNumSamples</span></code></a></p>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="id4">
<h2>成员函数<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<div class="section" id="estimate">
<h3>Estimate<a class="headerlink" href="#estimate" title="永久链接至标题">¶</a></h3>
<p>从一组三个2D-3D点对应关系中估计EPnP问题的最可能解决方案。</p>
<ul class="simple">
<li><p>&#64;param points2D Normalized 2D image points as 3x2 matrix.</p></li>
<li><p>&#64;param points3D 3D world points as 3x3 matrix.</p></li>
<li><p>&#64;return Most probable pose as length-1 vector of a 3x4 matrix.</p></li>
</ul>
<dl class="cpp function">
<dt id="_CPPv48EstimateRKNSt6vectorI3X_tEERKNSt6vectorI3Y_tEE">
<span id="_CPPv38EstimateRKNSt6vectorI3X_tEERKNSt6vectorI3Y_tEE"></span><span id="_CPPv28EstimateRKNSt6vectorI3X_tEERKNSt6vectorI3Y_tEE"></span><span id="Estimate__std::vector:X_t:CR.std::vector:Y_t:CR"></span><em class="property">static</em> std::vector&lt;<a class="reference internal" href="../PnP.html#_CPPv43M_t" title="M_t">M_t</a>&gt; <code class="sig-name descname">Estimate</code><span class="sig-paren">(</span><em class="property">const</em> std::vector&lt;<a class="reference internal" href="../PnP.html#_CPPv43X_t" title="X_t">X_t</a>&gt; &amp;<em>points2D</em>, <em class="property">const</em> std::vector&lt;<a class="reference internal" href="../PnP.html#_CPPv43Y_t" title="Y_t">Y_t</a>&gt; &amp;<em>points3D</em><span class="sig-paren">)</span>;<a class="headerlink" href="#_CPPv48EstimateRKNSt6vectorI3X_tEERKNSt6vectorI3Y_tEE" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">EPNPEstimator</span><span class="o">::</span><span class="n">M_t</span><span class="o">&gt;</span> <span class="n">EPNPEstimator</span><span class="o">::</span><span class="n">Estimate</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">X_t</span><span class="o">&gt;&amp;</span> <span class="n">points2D</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Y_t</span><span class="o">&gt;&amp;</span> <span class="n">points3D</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">CHECK_GE</span><span class="p">(</span><span class="n">points2D</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="mi">4</span><span class="p">);</span>
  <span class="n">CHECK_EQ</span><span class="p">(</span><span class="n">points2D</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">points3D</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>

  <span class="n">EPNPEstimator</span> <span class="n">epnp</span><span class="p">;</span>
  <span class="n">M_t</span> <span class="n">proj_matrix</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">epnp</span><span class="p">.</span><span class="n">ComputePose</span><span class="p">(</span><span class="n">points2D</span><span class="p">,</span> <span class="n">points3D</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proj_matrix</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">EPNPEstimator</span><span class="o">::</span><span class="n">M_t</span><span class="o">&gt;</span><span class="p">({});</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">EPNPEstimator</span><span class="o">::</span><span class="n">M_t</span><span class="o">&gt;</span><span class="p">({</span><span class="n">proj_matrix</span><span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="computepose">
<h3>ComputePose<a class="headerlink" href="#computepose" title="永久链接至标题">¶</a></h3>
<dl class="cpp function">
<dt id="_CPPv411ComputePoseRKNSt6vectorIN5Eigen8Vector2dEEERKNSt6vectorIN5Eigen8Vector3dEEEPN5Eigen10Matrix3x4dE">
<span id="_CPPv311ComputePoseRKNSt6vectorIN5Eigen8Vector2dEEERKNSt6vectorIN5Eigen8Vector3dEEEPN5Eigen10Matrix3x4dE"></span><span id="_CPPv211ComputePoseRKNSt6vectorIN5Eigen8Vector2dEEERKNSt6vectorIN5Eigen8Vector3dEEEPN5Eigen10Matrix3x4dE"></span><span id="ComputePose__std::vector:Eigen::Vector2d:CR.std::vector:Eigen::Vector3d:CR.Eigen::Matrix3x4dP"></span>bool <code class="sig-name descname">ComputePose</code><span class="sig-paren">(</span><em class="property">const</em> std::vector&lt;Eigen::Vector2d&gt; &amp;<em>points2D</em>, <em class="property">const</em> std::vector&lt;Eigen::Vector3d&gt; &amp;<em>points3D</em>, Eigen::Matrix3x4d *<em>proj_matrix</em><span class="sig-paren">)</span>;<a class="headerlink" href="#_CPPv411ComputePoseRKNSt6vectorIN5Eigen8Vector2dEEERKNSt6vectorIN5Eigen8Vector3dEEEPN5Eigen10Matrix3x4dE" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">EPNPEstimator</span><span class="o">::</span><span class="n">ComputePose</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector2d</span><span class="o">&gt;&amp;</span> <span class="n">points2D</span><span class="p">,</span>
                                <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="o">&gt;&amp;</span> <span class="n">points3D</span><span class="p">,</span>
                                <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3x4d</span><span class="o">*</span> <span class="n">proj_matrix</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">points2D_</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">points2D</span><span class="p">;</span>
  <span class="n">points3D_</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">points3D</span><span class="p">;</span>

  <span class="n">ChooseControlPoints</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ComputeBarycentricCoordinates</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Dynamic</span><span class="p">,</span> <span class="mi">12</span><span class="o">&gt;</span> <span class="n">M</span> <span class="o">=</span> <span class="n">ComputeM</span><span class="p">();</span>
  <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="o">&gt;</span> <span class="n">MtM</span> <span class="o">=</span> <span class="n">M</span><span class="p">.</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">M</span><span class="p">;</span>

  <span class="n">Eigen</span><span class="o">::</span><span class="n">JacobiSVD</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="o">&gt;&gt;</span> <span class="n">svd</span><span class="p">(</span>
      <span class="n">MtM</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullV</span> <span class="o">|</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullU</span><span class="p">);</span>
  <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="o">&gt;</span> <span class="n">Ut</span> <span class="o">=</span> <span class="n">svd</span><span class="p">.</span><span class="n">matrixU</span><span class="p">().</span><span class="n">transpose</span><span class="p">();</span>

  <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="o">&gt;</span> <span class="n">L6x10</span> <span class="o">=</span> <span class="n">ComputeL6x10</span><span class="p">(</span><span class="n">Ut</span><span class="p">);</span>
  <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="n">rho</span> <span class="o">=</span> <span class="n">ComputeRho</span><span class="p">();</span>

  <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector4d</span> <span class="n">betas</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span> <span class="n">reproj_errors</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3d</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span> <span class="n">Rs</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span> <span class="n">ts</span><span class="p">;</span>

  <span class="n">FindBetasApprox1</span><span class="p">(</span><span class="n">L6x10</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">betas</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="n">RunGaussNewton</span><span class="p">(</span><span class="n">L6x10</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">betas</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="n">reproj_errors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ComputeRT</span><span class="p">(</span><span class="n">Ut</span><span class="p">,</span> <span class="n">betas</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">Rs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

  <span class="n">FindBetasApprox2</span><span class="p">(</span><span class="n">L6x10</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">betas</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
  <span class="n">RunGaussNewton</span><span class="p">(</span><span class="n">L6x10</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">betas</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
  <span class="n">reproj_errors</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ComputeRT</span><span class="p">(</span><span class="n">Ut</span><span class="p">,</span> <span class="n">betas</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">Rs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

  <span class="n">FindBetasApprox3</span><span class="p">(</span><span class="n">L6x10</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">betas</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
  <span class="n">RunGaussNewton</span><span class="p">(</span><span class="n">L6x10</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">betas</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
  <span class="n">reproj_errors</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ComputeRT</span><span class="p">(</span><span class="n">Ut</span><span class="p">,</span> <span class="n">betas</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">Rs</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

  <span class="kt">int</span> <span class="n">best_idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">reproj_errors</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">reproj_errors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
    <span class="n">best_idx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">reproj_errors</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">reproj_errors</span><span class="p">[</span><span class="n">best_idx</span><span class="p">])</span> <span class="p">{</span>
    <span class="n">best_idx</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">proj_matrix</span><span class="o">-&gt;</span><span class="n">leftCols</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="p">()</span> <span class="o">=</span> <span class="n">Rs</span><span class="p">[</span><span class="n">best_idx</span><span class="p">];</span>
  <span class="n">proj_matrix</span><span class="o">-&gt;</span><span class="n">rightCols</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">()</span> <span class="o">=</span> <span class="n">ts</span><span class="p">[</span><span class="n">best_idx</span><span class="p">];</span>

  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="choosecontrolpoints">
<h3>ChooseControlPoints<a class="headerlink" href="#choosecontrolpoints" title="永久链接至标题">¶</a></h3>
<dl class="cpp function">
<dt id="_CPPv4N13EPNPEstimator19ChooseControlPointsEv">
<span id="_CPPv3N13EPNPEstimator19ChooseControlPointsEv"></span><span id="_CPPv2N13EPNPEstimator19ChooseControlPointsEv"></span><span id="EPNPEstimator::ChooseControlPoints"></span>void <code class="sig-prename descclassname">EPNPEstimator<code class="sig-prename descclassname">::</code></code><code class="sig-name descname">ChooseControlPoints</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N13EPNPEstimator19ChooseControlPointsEv" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">EPNPEstimator</span><span class="o">::</span><span class="n">ChooseControlPoints</span><span class="p">()</span> <span class="p">{</span>

  <span class="c1">// 以C0作为质心参考点</span>
  <span class="n">cws_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">setZero</span><span class="p">();</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">points3D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cws_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">points3D_</span><span class="p">)[</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="n">cws_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="n">points3D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>

  <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Dynamic</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span> <span class="n">PW0</span><span class="p">(</span><span class="n">points3D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">(),</span> <span class="mi">3</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">points3D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PW0</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">points3D_</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cws_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3d</span> <span class="n">PW0tPW0</span> <span class="o">=</span> <span class="n">PW0</span><span class="p">.</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">PW0</span><span class="p">;</span>

  <span class="n">Eigen</span><span class="o">::</span><span class="n">JacobiSVD</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3d</span><span class="o">&gt;</span> <span class="n">svd</span><span class="p">(</span>
      <span class="n">PW0tPW0</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullV</span> <span class="o">|</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullU</span><span class="p">);</span>

  <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span> <span class="n">D</span> <span class="o">=</span> <span class="n">svd</span><span class="p">.</span><span class="n">singularValues</span><span class="p">();</span>

  <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3d</span> <span class="n">Ut</span> <span class="o">=</span> <span class="n">svd</span><span class="p">.</span><span class="n">matrixU</span><span class="p">().</span><span class="n">transpose</span><span class="p">();</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">double</span> <span class="n">k</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">D</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">points3D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">());</span>

    <span class="n">cws_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cws_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">k</span> <span class="o">*</span> <span class="n">Ut</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">).</span><span class="n">transpose</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>为了系统的稳定性，采用如下策略进行控制点的选取。第一个控制点选择在所有3D点的质心位置</p>
<div class="math notranslate nohighlight">
\[c_1^w = \frac{1}{n} \sum\limits_{i=1}^n p_i^w\]</div>
<p>其余点选择在数据的主方向上。具体操作如下，计算矩阵</p>
<div class="math notranslate nohighlight">
\[\begin{split}A = \left[
\begin{matrix}
(p_1^w)^T-(c_1^w)^T\\
\dots\\
(p_n^w)^T-(c_1^w)^T
\end{matrix}
\right]\end{split}\]</div>
<p>计算 <span class="math notranslate nohighlight">\(A^TA\)</span> 的3个特征值为  <span class="math notranslate nohighlight">\(\lambda_1,\lambda_2,\lambda_3\)</span>， 对应的特征向量为 <span class="math notranslate nohighlight">\(v_1,v_2,v_3\)</span>，那么剩下的三个控制点为：</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{cases}
c_2^w = c_1^w + \sqrt{ \frac{\lambda_1}{n} } v_1 \\
c_3^w = c_1^w + \sqrt{ \frac{\lambda_2}{n} } v_2 \\
c_4^w = c_1^w + \sqrt{ \frac{\lambda_3}{n} } v_3 \\
\end{cases}\end{split}\]</div>
<p>上述操作实际上是找到点云的重心，以及点云的三个主方向。<a class="reference external" href="https://en.wikipedia.org/wiki/Principal_component_analysis">主成分分析(PCA)</a></p>
<div class="align-center figure align-default">
<img alt="../../../../../../_images/0.jpg" src="../../../../../../_images/0.jpg" />
</div>
<p>到目前为止，已知可以知道4个控制点在世界坐标系下的坐标  <span class="math notranslate nohighlight">\(c_j\)</span> ，每一个3D点的坐标  <span class="math notranslate nohighlight">\(\alpha_{ij}\)</span>  。如果能把4个控制点在相机坐标系下的坐标求解出来，就可以计算出3D点在相机坐标系下的坐标，就可以求解出外参数  <span class="math notranslate nohighlight">\([R|t]\)</span> 。</p>
</div>
</div>
<div class="section" id="computebarycentriccoordinates">
<h3>ComputeBarycentricCoordinates<a class="headerlink" href="#computebarycentriccoordinates" title="永久链接至标题">¶</a></h3>
<blockquote>
<div><p>计算barycentric coodinates</p>
<dl class="cpp function">
<dt id="_CPPv4N13EPNPEstimator29ComputeBarycentricCoordinatesEv">
<span id="_CPPv3N13EPNPEstimator29ComputeBarycentricCoordinatesEv"></span><span id="_CPPv2N13EPNPEstimator29ComputeBarycentricCoordinatesEv"></span><span id="EPNPEstimator::ComputeBarycentricCoordinates"></span>bool <code class="sig-prename descclassname">EPNPEstimator<code class="sig-prename descclassname">::</code></code><code class="sig-name descname">ComputeBarycentricCoordinates</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N13EPNPEstimator29ComputeBarycentricCoordinatesEv" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">EPNPEstimator</span><span class="o">::</span><span class="n">ComputeBarycentricCoordinates</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3d</span> <span class="n">CC</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">CC</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">cws_</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cws_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">CC</span><span class="p">.</span><span class="n">colPivHouseholderQr</span><span class="p">().</span><span class="n">rank</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3d</span> <span class="n">CC_inv</span> <span class="o">=</span> <span class="n">CC</span><span class="p">.</span><span class="n">inverse</span><span class="p">();</span>

  <span class="n">alphas_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">points2D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">());</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">points3D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">alphas_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">CC_inv</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">points3D_</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cws_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                          <span class="n">CC_inv</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">points3D_</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cws_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                          <span class="n">CC_inv</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">points3D_</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">cws_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="n">alphas_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">alphas_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">alphas_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">alphas_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">CC</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">cws_</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cws_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>假设上一步得到的控制点为 <span class="math notranslate nohighlight">\(c_i^w = (x_i, y_i, z_i)^T ~~~(i =  1, 2, 3, 4)\)</span>， 则：经过变换后（将第一个控制点移动到原点）的控制点坐标组成的矩阵为</p>
<div class="math notranslate nohighlight">
\[\begin{split}CC = \left[
\begin{matrix}
x_2 - x_1 &amp; x_3-x_1 &amp; x_4-x_1\\
y_2 - y_1 &amp; y_3-y_1 &amp; y_4-y_1\\
z_2 - z_1 &amp; z_3-z_1 &amp; z_4-z_1
\end{matrix}
\right]\end{split}\]</div>
<p>其中 <span class="math notranslate nohighlight">\(x_1\)</span> 为世界坐标系下的中心控制点， <span class="math notranslate nohighlight">\(x_2,x_3,x_4\)</span> 为世界坐标系下的其他控制点</p>
<p>如果QR分解的矩阵的秩 &lt; 3，则返回false</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span> <span class="k">if</span> <span class="p">(</span><span class="n">CC</span><span class="p">.</span><span class="n">colPivHouseholderQr</span><span class="p">().</span><span class="n">rank</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>barycentric coodinates的计算公式为：</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{eqnarray}
\left[
\begin{matrix}
\alpha_{i2}\\ \alpha_{i3}\\ \alpha_{i4}\\
\end{matrix}
\right] &amp;=&amp; (CC)^{-1}
\left[
\begin{matrix}
p_{ix}^w - c_{ix}^w\\p_{iy}^w - c_{iy}^w\\p_{iz}^w - c_{iz}^w
\end{matrix}
\right]\\\\
\alpha_{i1} &amp;=&amp; 1 - \alpha_{i2} - \alpha_{i3} - \alpha_{i4} \\\\
\end{eqnarray}\end{split}\]</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">alphas_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">points2D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">());</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">points3D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">alphas_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">CC_inv</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">points3D_</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cws_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
                        <span class="n">CC_inv</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">points3D_</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cws_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                        <span class="n">CC_inv</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">points3D_</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">cws_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">alphas_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">alphas_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">alphas_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">alphas_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div></blockquote>
</div>
<div class="section" id="computem">
<h3>ComputeM<a class="headerlink" href="#computem" title="永久链接至标题">¶</a></h3>
<blockquote>
<div><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Dynamic</span><span class="p">,</span> <span class="mi">12</span><span class="o">&gt;</span> <span class="n">EPNPEstimator</span><span class="o">::</span><span class="n">ComputeM</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Dynamic</span><span class="p">,</span> <span class="mi">12</span><span class="o">&gt;</span> <span class="n">M</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">points2D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">(),</span> <span class="mi">12</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">points3D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">M</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">alphas_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
      <span class="n">M</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
      <span class="n">M</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">alphas_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">points2D_</span><span class="p">)[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span><span class="p">();</span>

      <span class="n">M</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
      <span class="n">M</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">alphas_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
      <span class="n">M</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">alphas_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">points2D_</span><span class="p">)[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">M</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>设 <span class="math notranslate nohighlight">\(K\)</span> 是摄像头的内参矩阵，可以通过标定获得 <span class="math notranslate nohighlight">\(\{u_i\}_{i=1,...,n}\)</span> 是参考点 <span class="math notranslate nohighlight">\(\{p_i\}_{i=1,...,n}\)</span> 的2D投影，那么有</p>
<div class="math notranslate nohighlight">
\[\begin{split}\forall i, w_i \left[
\begin{matrix}
u_i\\1
\end{matrix}
\right] = Kp_i^c = K \sum\limits_{j=1}^4 \alpha_{ij} c_j^c\end{split}\]</div>
<p>用 <span class="math notranslate nohighlight">\(c_j^c = [x_j^c, y_j^c, z_j^c]^T\)</span> 带入上式，把 <span class="math notranslate nohighlight">\(K\)</span> 展开：</p>
<div class="math notranslate nohighlight">
\[\begin{split}\forall i, w_i \left[
\begin{matrix}
u_i\\v_i\\1
\end{matrix}
\right] = \left[
\begin{matrix}
f_u &amp; 0 &amp; u_c\\0 &amp; f_v &amp; v_c \\ 0 &amp; 0 &amp; 1
\end{matrix}
\right] \sum\limits_{j=1}^4 \alpha_{ij} \left[
\begin{matrix}
x_j^c\\ y_j^c \\ z_j^c
\end{matrix}
\right]\end{split}\]</div>
<p>从上式可以得到两个线性方程：</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{cases}
\sum\limits_{j=1}^4 \alpha_{ij}f_ux_j^c + \alpha_{ij}(u_c-u_i)z_j^c = 0\\
\sum\limits_{j=1}^4 \alpha_{ij}f_vy_j^c + \alpha_{ij}(v_c-v_j)z_j^c = 0
\end{cases}\end{split}\]</div>
<p>把所有 <span class="math notranslate nohighlight">\(n\)</span> 个点串联起来，我们可以得到一个线性方程组：</p>
<div class="math notranslate nohighlight">
\[Mx = 0\]</div>
<p>已知变量： 控制参数 <span class="math notranslate nohighlight">\(a_{ij}\)</span> ，相机内参数 <span class="math notranslate nohighlight">\(f_x, f_y, c_x, c_y\)</span> ，  2D点坐标 <span class="math notranslate nohighlight">\(u_i,v_i\)</span></p>
<p>未知变量： 4个控制点在相机坐标系下的坐标 <span class="math notranslate nohighlight">\(x_j^c, y_j^c, z_j^c\)</span></p>
<p>因此  <span class="math notranslate nohighlight">\(x\)</span> 是待求的12个位置参数， <span class="math notranslate nohighlight">\(M\)</span> 的大小为 <span class="math notranslate nohighlight">\(2n \times 12\)</span> ， <span class="math notranslate nohighlight">\(Mx = 0\)</span> 的解即为 <span class="math notranslate nohighlight">\(M\)</span> 的零空间。</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>直接对 <span class="math notranslate nohighlight">\(Mx = 0\)</span> 使用SVD分解，其复杂度为 <span class="math notranslate nohighlight">\(O(n^3)\)</span></p>
<p>对上式左右同乘 <span class="math notranslate nohighlight">\(M^T\)</span> ，转换为对 <span class="math notranslate nohighlight">\(M^TMx = 0\)</span> 进行奇异值分解，此时 <span class="math notranslate nohighlight">\(M^TM\)</span> 为方阵，复杂度降为 <span class="math notranslate nohighlight">\(O(n)\)</span></p>
</div>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>其中 <span class="math notranslate nohighlight">\(x\)</span> 可以表示为 <span class="math notranslate nohighlight">\(x = \sum\limits_{k = 1} ^N \beta_k v_k\)</span></p>
<p>这样表示的原因在于，由于 <span class="math notranslate nohighlight">\(M\)</span> 的维数为 <span class="math notranslate nohighlight">\(2 n * 12\)</span> ，则方程 <span class="math notranslate nohighlight">\(Mx = 0\)</span> 的解的个数是根据 <span class="math notranslate nohighlight">\(n\)</span> 来决定。</p>
<p>如果 <span class="math notranslate nohighlight">\(n &gt;=6\)</span> 则方程在没有噪声的情况下有唯一解。</p>
<p>如果 <span class="math notranslate nohighlight">\(n &lt; 6\)</span> 则方程有多个解，则此时 <span class="math notranslate nohighlight">\(x\)</span> 由这些解的线性组合所决定，所以 <span class="math notranslate nohighlight">\(x\)</span> 表示为：</p>
<div class="math notranslate nohighlight">
\[x = \sum\limits_{k = 1} ^N \beta_k v_k\]</div>
<p>这里的 <span class="math notranslate nohighlight">\(v_k\)</span> 是指的对矩阵 <span class="math notranslate nohighlight">\(M^TM\)</span> 进行奇异值分解后，最小奇异值对应的特征向量，需要进行求解的是 <span class="math notranslate nohighlight">\(\beta_k\)</span></p>
<p>经过作者的证明， <span class="math notranslate nohighlight">\(N\)</span> 最多为 <span class="math notranslate nohighlight">\(4\)</span> ，因此只需要考虑 <span class="math notranslate nohighlight">\(N = 1,2,3,4\)</span> 这四种情况即可。</p>
<p>（ <span class="math notranslate nohighlight">\(N = 4\)</span> 时，方程为欠定方程组，在本章仅考虑 <span class="math notranslate nohighlight">\(n = 1,2,3\)</span> 的情况）</p>
</div>
</div>
<div class="admonition error">
<p class="admonition-title">错误</p>
<p>这里作者的代码忽略了内参，没看懂为什么？</p>
</div>
</div></blockquote>
</div>
<div class="section" id="computel6x10">
<h3>ComputeL6x10<a class="headerlink" href="#computel6x10" title="永久链接至标题">¶</a></h3>
<blockquote>
<div><dl class="cpp function">
<dt id="_CPPv4N13EPNPEstimator12ComputeL6x10ERKN5Eigen6MatrixIdXL12EEXL12EEEE">
<span id="_CPPv3N13EPNPEstimator12ComputeL6x10ERKN5Eigen6MatrixIdXL12EEXL12EEEE"></span><span id="_CPPv2N13EPNPEstimator12ComputeL6x10ERKN5Eigen6MatrixIdX12EX12EEE"></span><span id="EPNPEstimator::ComputeL6x10__Eigen::Matrix:double.12.12:CR"></span>Eigen::Matrix&lt;double, 6, 10&gt; <code class="sig-prename descclassname">EPNPEstimator<code class="sig-prename descclassname">::</code></code><code class="sig-name descname">ComputeL6x10</code><span class="sig-paren">(</span><em class="property">const</em> Eigen::Matrix&lt;double, 12, 12&gt; &amp;<em>Ut</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N13EPNPEstimator12ComputeL6x10ERKN5Eigen6MatrixIdXL12EEXL12EEEE" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="o">&gt;</span> <span class="n">EPNPEstimator</span><span class="o">::</span><span class="n">ComputeL6x10</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="o">&gt;&amp;</span> <span class="n">Ut</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="o">&gt;</span> <span class="n">L6x10</span><span class="p">;</span>

   <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="p">,</span> <span class="mi">6</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span> <span class="n">dv</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">dv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ut</span><span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="n">Ut</span><span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">b</span><span class="p">);</span>
         <span class="n">dv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ut</span><span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">Ut</span><span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
         <span class="n">dv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ut</span><span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">Ut</span><span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

         <span class="n">b</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">a</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
         <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

   <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">dv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
      <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
      <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">dv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
      <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
      <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
      <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">dv</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
      <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
      <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
      <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
      <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">=</span> <span class="n">dv</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="n">L6x10</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>由于控制点 <span class="math notranslate nohighlight">\(c_i\)</span> 之间的距离是不随着坐标系的改变而改变的，因此有</p>
<div class="math notranslate nohighlight">
\[||c_i^c - c_j^c||^2 = ||c_i^w - c_j^w||^2\]</div>
<p>注意，上面一节的等式 <span class="math notranslate nohighlight">\(Mx = 0\)</span> 中的 <span class="math notranslate nohighlight">\(x\)</span> 是  <span class="math notranslate nohighlight">\(c_i^c\)</span> ，因此上式转换为：</p>
<div class="math notranslate nohighlight">
\[||\sum\limits_{k=1}^N \beta_k v_k^{[i]} - \sum\limits_{k=1}^N \beta_k v_k^{[j]}||^2 = ||c_i^w - c_j^w||^2\]</div>
<p>这是一个关于 <span class="math notranslate nohighlight">\(\{ \beta_k \}_{k=1,...,N}\)</span> 的二次方程，没有关于 <span class="math notranslate nohighlight">\(\{ \beta_k \}_{k=1,...,N}\)</span> 的一次项。</p>
<p>将二次项 <span class="math notranslate nohighlight">\(\beta_i \beta_j\)</span> 替换为 <span class="math notranslate nohighlight">\(\beta_{ij}\)</span> ，那么该方程就是 <span class="math notranslate nohighlight">\(\{\beta_{ij}\}_{i,j=1,...,N}\)</span> 的线性方程。</p>
<p>对于  <span class="math notranslate nohighlight">\(v_j^{[i]}\)</span> ：</p>
<ul class="simple">
<li><p>下标 <span class="math notranslate nohighlight">\(j\)</span> 表示该 <span class="math notranslate nohighlight">\(v\)</span> 向量是 <span class="math notranslate nohighlight">\(M^TM\)</span> 奇异值分解后的右奇异值矩阵的（ <span class="math notranslate nohighlight">\(U\)</span> 矩阵）的倒数第 <span class="math notranslate nohighlight">\(j\)</span> 列。</p></li>
<li><p>上标 <span class="math notranslate nohighlight">\(i\)</span> 是第 <span class="math notranslate nohighlight">\(j\)</span> 列里的第 <span class="math notranslate nohighlight">\(i\)</span> 个控制点。</p></li>
</ul>
<div class="align-center figure align-default">
<a class="reference internal image-reference" href="../../../../../../_images/1.jpg"><img alt="../../../../../../_images/1.jpg" src="../../../../../../_images/1.jpg" style="width: 184.2px; height: 247.2px;" /></a>
</div>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>对于4个控制点，可以得到 <span class="math notranslate nohighlight">\(C_4^2 = 6\)</span> 个方程</p>
<p>当 <span class="math notranslate nohighlight">\(N\)</span> 取不同的值时，线性未知数的个数为：</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(N = 1\)</span> ，线性未知数的个数为1，方程为变为 <span class="math notranslate nohighlight">\(x = \beta v\)</span></p></li>
</ul>
<div class="math notranslate nohighlight">
\[|| \beta v^{[i]} - \beta v^{[j]} ||^2 = ||c_i^w - c_j^w||^2\]</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(N = 2\)</span> ，线性未知数的个数为3，方程为变为 <span class="math notranslate nohighlight">\(x = \beta_1 v_1 + \beta_2 v_2\)</span></p></li>
</ul>
<div class="math notranslate nohighlight">
\[|| (\beta_1 v_1^{[i]} + \beta_2 v_2^{[i]}) - (\beta_1 v_1^{[j]} + \beta_2 v_2^{[j]})||^2 = ||c_i^w - c_j^w||^2\]</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(N = 3\)</span> ，线性未知数的个数为6，方程为变为 <span class="math notranslate nohighlight">\(x = \beta_1 v_1 + \beta_2 v_2 + \beta_3 v_3\)</span></p></li>
</ul>
<div class="math notranslate nohighlight">
\[|| (\beta_1 v_1^{[i]} + \beta_2 v_2^{[i]} + \beta_3 v_3^{[i]}) - (\beta_1 v_1^{[j]} + \beta_2 v_2^{[j]} + \beta_3 v_3^{[j]})||^2 = ||c_i^w - c_j^w||^2\]</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(N = 4\)</span> ，线性未知数的个数为10，此时未知数个数多于方程个数（欠定方程）</p></li>
</ul>
<div class="math notranslate nohighlight">
\[|| (\beta_1 v_1^{[i]} + \beta_2 v_2^{[i]} + \beta_3 v_3^{[i]} + \beta_4 v_4^{[i]}) - (...) || = ||c_i^w - c_j^w||^2\]</div>
</div>
<p>如何求解 <span class="math notranslate nohighlight">\(\beta_k\)</span> 呢？</p>
<ul>
<li><p><span class="math notranslate nohighlight">\(N = 1\)</span> 时， <span class="math notranslate nohighlight">\(\beta\)</span> 为：</p>
<div class="math notranslate nohighlight">
\[\beta = \frac{ \sum\limits_{\{i,j\}\in [1,4]}  ||v^{[i]} - v^{[j]} || · || c_i^w - c_j^w || }  {\sum\limits_{\{i,j\}\in[1,4] } || v^{[i]} - v^{[j]} ||^2 }\]</div>
</li>
<li><p><span class="math notranslate nohighlight">\(N = 2\)</span> 时，将方程展开：</p>
<div class="math notranslate nohighlight">
\[\begin{split}|| \beta_1 \underbrace{ (v_1^{[i]} - v_1^{[j]}) }_{S_1} + \beta_2 \underbrace{ (v_2^{[i]} - v_2^{[j]}) }_{S_2}||^2 = \underbrace{ || c_i^w - c_j^w ||^2 }_c\\\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\Downarrow\]</div>
<div class="math notranslate nohighlight">
\[\beta_1^2S_1^T S_1 + 2\beta_1\beta_2 S_2 + \beta_2^2 S_2^T S_2 = c\]</div>
<p>根据之前定义的 <span class="math notranslate nohighlight">\(\beta_{ij} = \beta_i \beta_j\)</span> ，从而 <span class="math notranslate nohighlight">\(\beta_{11} = \beta_1 ^2, ~~\beta_{12} = \beta_1 * \beta_2, ~~\beta_{22} = \beta_2^2\)</span></p>
<p>进而方程变为：</p>
<div class="math notranslate nohighlight">
\[L \beta = \rho\]</div>
<p>其中 <span class="math notranslate nohighlight">\(\beta = [\beta_{11},\beta_{12},\beta_{22}]^T\)</span> ， <span class="math notranslate nohighlight">\(L\)</span> 为 <span class="math notranslate nohighlight">\(6\times 3\)</span> 的矩阵， <span class="math notranslate nohighlight">\(\rho\)</span> 为 <span class="math notranslate nohighlight">\(6 \times 1\)</span> 的矩阵。</p>
<div class="figure align-default">
<a class="reference internal image-reference" href="../../../../../../_images/2.jpg"><img alt="../../../../../../_images/2.jpg" src="../../../../../../_images/2.jpg" style="width: 573.0px; height: 100.2px;" /></a>
</div>
<p>此时， <span class="math notranslate nohighlight">\(\beta\)</span> 为：</p>
<div class="math notranslate nohighlight">
\[\beta = (L^TL)^{-1}L^T \rho\]</div>
<p>解出 <span class="math notranslate nohighlight">\(\beta\)</span> 后可以获得两组 <span class="math notranslate nohighlight">\(\beta_1, \beta_2\)</span> 的解，再根据控制点在相机前端，即 <span class="math notranslate nohighlight">\(c_j^c \)</span> ， 从而唯一确定 <span class="math notranslate nohighlight">\(\beta_1, \beta_2\)</span></p>
</li>
<li><p><span class="math notranslate nohighlight">\(N = 3\)</span> 时，与 <span class="math notranslate nohighlight">\(N = 2\)</span> 解法相同：</p>
<p>此时 <span class="math notranslate nohighlight">\(\beta = [\beta_{11},\beta_{12},\beta_{13},\beta_{22},\beta_{23},\beta_{33}]^T\)</span> ， <span class="math notranslate nohighlight">\(L\)</span> 的大小为 <span class="math notranslate nohighlight">\(6 \times 6\)</span></p>
<div class="figure align-default">
<a class="reference internal image-reference" href="../../../../../../_images/3.jpg"><img alt="../../../../../../_images/3.jpg" src="../../../../../../_images/3.jpg" style="width: 763.8px; height: 128.4px;" /></a>
</div>
<p>此时， <span class="math notranslate nohighlight">\(\beta\)</span> 为：</p>
<div class="math notranslate nohighlight">
\[\beta = L^{-1}\rho\]</div>
</li>
<li><p><span class="math notranslate nohighlight">\(N = 4\)</span> 时，未知数的个数多于方程的个数</p>
<p>论文中提到， <span class="math notranslate nohighlight">\(\beta_{ab}\beta_{cd} = \beta_{a}\beta_{b}\beta_{c}\beta_{d} = \beta_{a'b'}\beta_{c'd'}\)</span></p>
<p>其中 <span class="math notranslate nohighlight">\(\{a',b',c',d'\}\)</span> 是  <span class="math notranslate nohighlight">\(\{a,b,c,d\}\)</span> 的一个排列。这样就可以减少未知数的个数。例如：</p>
<p>例如：求出了 <span class="math notranslate nohighlight">\(\beta_{11},\beta_{12},\beta_{13}\)</span> 那么就可以得到 <span class="math notranslate nohighlight">\(\beta_{23} = \frac{\beta_{12}\beta_{13}}{\beta_{11}}\)</span> ，这样就可以求出 <span class="math notranslate nohighlight">\(\{\beta_{ij}\}_{i,j = 1,...,N}\)</span> 了</p>
<div class="admonition attention">
<p class="admonition-title">注意</p>
<p>注意：此时beta 是 <span class="math notranslate nohighlight">\(6 \times 10\)</span> 的（ <span class="math notranslate nohighlight">\(\beta_{11} ··· \beta{44}\)</span> ），由于 <span class="math notranslate nohighlight">\(\rho\)</span> 必须是 <span class="math notranslate nohighlight">\(6\times 1\)</span> 因此 <span class="math notranslate nohighlight">\(L\)</span> 的大小为 <span class="math notranslate nohighlight">\(6 \times 10\)</span> 也就是代码中的 <span class="math notranslate nohighlight">\(L6x10\)</span></p>
</div>
</li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>回到代码，可以明显看到 <span class="math notranslate nohighlight">\(N = 2,3,4\)</span> 的时候， <span class="math notranslate nohighlight">\(L\)</span> 矩阵是 <span class="math notranslate nohighlight">\(N = 4\)</span> 的情况下的 <span class="math notranslate nohighlight">\(L\)</span> 矩阵的子集，因此直接构造  <span class="math notranslate nohighlight">\(N = 4\)</span> 时的 <span class="math notranslate nohighlight">\(L\)</span> 矩阵。</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>因为是 <span class="math notranslate nohighlight">\(U^T\)</span> ，所以这里特征向量为 <code class="docutils literal notranslate"><span class="pre">行向量</span></code></p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{eqnarray}
&amp;Ut&amp;(11,&amp;[0,1,2]&amp;) &amp;\longrightarrow&amp; ~~ v_1^{[1]}~~~~~~~~Ut(11,[9,10,11]) \longrightarrow  v_1^{[4]}\\
&amp;Ut&amp;(10,&amp;[0,1,2]&amp;) &amp;\longrightarrow&amp; ~~ v_2^{[1]}\\
&amp;Ut&amp;(9,&amp;[0,1,2]&amp;)  &amp;\longrightarrow&amp; ~~ v_3^{[1]}\\
&amp;Ut&amp;(8,&amp;[0,1,2]&amp;)  &amp;\longrightarrow&amp; ~~ v_4^{[1]}
\end{eqnarray}\end{split}\]</div>
<div class="align-center figure align-default">
<a class="reference internal image-reference" href="../../../../../../_images/4.jpg"><img alt="../../../../../../_images/4.jpg" src="../../../../../../_images/4.jpg" style="width: 254.39999999999998px; height: 208.2px;" /></a>
</div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="o">&gt;</span> <span class="n">L6x10</span><span class="p">;</span>

<span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="p">,</span> <span class="mi">6</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span> <span class="n">dv</span><span class="p">;</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
   <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">dv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ut</span><span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="n">Ut</span><span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">b</span><span class="p">);</span>
      <span class="n">dv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ut</span><span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">Ut</span><span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">dv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ut</span><span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">Ut</span><span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

      <span class="n">b</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">a</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
         <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>则</p>
<div class="math notranslate nohighlight">
\[\begin{split}dv[i][0] = v_i^{[1]} - v_i^{[2]}~~~~~~~~dv[i][1] = v_i^{[1]} - v_i^{[3]}~~~~~~~~dv[i][2] = v_i^{[1]} - v_i^{[4]}\\
dv[i][3] = v_i^{[2]} - v_i^{[3]}~~~~~~~~dv[i][4] = v_i^{[2]} - v_i^{[4]}~~~~~~~~dv[i][5] = v_i^{[3]} - v_i^{[4]}\end{split}\]</div>
<p>接下来需要构造的是 <span class="math notranslate nohighlight">\(L\)</span> 矩阵</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                <span class="n">L</span> <span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span>                       <span class="o">*</span>   <span class="n">betas</span> <span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="mi">1</span><span class="p">)</span>    <span class="o">=</span>  <span class="n">rho</span> <span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="mi">1</span><span class="p">)</span>

<span class="o">|</span> <span class="o">||</span><span class="n">v1i</span><span class="o">-</span><span class="n">v1j</span><span class="o">||^</span><span class="mi">2</span>  <span class="mi">2</span><span class="o">*|</span><span class="p">(</span><span class="n">v1i</span><span class="o">-</span><span class="n">v1j</span><span class="p">)(</span><span class="n">v2i</span><span class="o">-</span><span class="n">v2j</span><span class="p">)</span><span class="o">|</span>    <span class="o">..|</span>   <span class="o">|</span> <span class="n">betas1</span><span class="o">*</span><span class="n">betas1</span> <span class="o">|</span>   <span class="o">|</span> <span class="n">dcw0_1</span> <span class="o">|</span>
<span class="o">|</span>      <span class="o">..</span>                                    <span class="o">|</span>   <span class="o">|</span> <span class="n">betas1</span><span class="o">*</span><span class="n">betas2</span> <span class="o">|</span>   <span class="o">|</span> <span class="n">dcw0_2</span> <span class="o">|</span>
<span class="o">|</span>      <span class="o">..</span>                                    <span class="o">|</span>   <span class="o">|</span> <span class="n">betas2</span><span class="o">*</span><span class="n">betas2</span> <span class="o">|</span>   <span class="o">|</span> <span class="n">dcw0_3</span> <span class="o">|</span>
<span class="o">|</span>      <span class="o">..</span>                                    <span class="o">|</span> <span class="o">*</span> <span class="o">|</span> <span class="n">betas1</span><span class="o">*</span><span class="n">betas3</span> <span class="o">|</span> <span class="o">=</span> <span class="o">|</span> <span class="n">dcw1_2</span> <span class="o">|</span>
<span class="o">|</span>      <span class="o">..</span>                                    <span class="o">|</span>   <span class="o">|</span> <span class="n">betas2</span><span class="o">*</span><span class="n">betas3</span> <span class="o">|</span>   <span class="o">|</span> <span class="n">dcw1_3</span> <span class="o">|</span>
<span class="o">|</span>      <span class="o">..</span>                                    <span class="o">|</span>   <span class="o">|</span> <span class="n">betas3</span><span class="o">*</span><span class="n">betas3</span> <span class="o">|</span>   <span class="o">|</span> <span class="n">dcw2_3</span> <span class="o">|</span>
                                                 <span class="o">|</span> <span class="n">betas1</span><span class="o">*</span><span class="n">betas4</span> <span class="o">|</span>
                                                 <span class="o">|</span> <span class="n">betas2</span><span class="o">*</span><span class="n">betas4</span> <span class="o">|</span>
                                                 <span class="o">|</span> <span class="n">betas3</span><span class="o">*</span><span class="n">betas4</span> <span class="o">|</span>
                                                 <span class="o">|</span> <span class="n">betas4</span><span class="o">*</span><span class="n">betas4</span> <span class="o">|</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">dv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
   <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
   <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">dv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
   <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
   <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
   <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">dv</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
   <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
   <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
   <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
   <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">=</span> <span class="n">dv</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">transpose</span><span class="p">()</span> <span class="o">*</span> <span class="n">dv</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div></blockquote>
</div>
<div class="section" id="computerho">
<h3>ComputeRho<a class="headerlink" href="#computerho" title="永久链接至标题">¶</a></h3>
<blockquote>
<div><p>构造 <span class="math notranslate nohighlight">\(6 \times 1\)</span> 的距离矩阵 <span class="math notranslate nohighlight">\(\rho\)</span> ，记录4个控制点之间各自的距离</p>
<dl class="cpp function">
<dt id="_CPPv4N13EPNPEstimator10ComputeRhoEv">
<span id="_CPPv3N13EPNPEstimator10ComputeRhoEv"></span><span id="_CPPv2N13EPNPEstimator10ComputeRhoEv"></span><span id="EPNPEstimator::ComputeRho"></span>Eigen::Matrix&lt;double, 6, 1&gt; <code class="sig-prename descclassname">EPNPEstimator<code class="sig-prename descclassname">::</code></code><code class="sig-name descname">ComputeRho</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N13EPNPEstimator10ComputeRhoEv" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="n">EPNPEstimator</span><span class="o">::</span><span class="n">ComputeRho</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="n">rho</span><span class="p">;</span>
  <span class="n">rho</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cws_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cws_</span><span class="p">[</span><span class="mi">1</span><span class="p">]).</span><span class="n">squaredNorm</span><span class="p">();</span>
  <span class="n">rho</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cws_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cws_</span><span class="p">[</span><span class="mi">2</span><span class="p">]).</span><span class="n">squaredNorm</span><span class="p">();</span>
  <span class="n">rho</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cws_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">cws_</span><span class="p">[</span><span class="mi">3</span><span class="p">]).</span><span class="n">squaredNorm</span><span class="p">();</span>
  <span class="n">rho</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cws_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cws_</span><span class="p">[</span><span class="mi">2</span><span class="p">]).</span><span class="n">squaredNorm</span><span class="p">();</span>
  <span class="n">rho</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cws_</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cws_</span><span class="p">[</span><span class="mi">3</span><span class="p">]).</span><span class="n">squaredNorm</span><span class="p">();</span>
  <span class="n">rho</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cws_</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">cws_</span><span class="p">[</span><span class="mi">3</span><span class="p">]).</span><span class="n">squaredNorm</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">rho</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="findbetasapprox1">
<h3>FindBetasApprox1<a class="headerlink" href="#findbetasapprox1" title="永久链接至标题">¶</a></h3>
<blockquote>
<div><p>求解 <span class="math notranslate nohighlight">\(N = 4\)</span> 时的 <span class="math notranslate nohighlight">\(\beta\)</span></p>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>注意！这里的程序，包括Opencv里的EPnP，都没有按照正确的方法去求解，而是选择了近似的方法。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">betas10</span>        <span class="o">=</span> <span class="p">[</span><span class="n">B11</span> <span class="n">B12</span> <span class="n">B22</span> <span class="n">B13</span> <span class="n">B23</span> <span class="n">B33</span> <span class="n">B14</span> <span class="n">B24</span> <span class="n">B34</span> <span class="n">B44</span><span class="p">]</span>

<span class="n">betas_approx_1</span> <span class="o">=</span> <span class="p">[</span><span class="n">B11</span> <span class="n">B12</span>     <span class="n">B13</span>         <span class="n">B14</span><span class="p">]</span>
</pre></div>
</div>
<p>将应该求的参数 <span class="math notranslate nohighlight">\(betas \_10\)</span> 由10个减少到了4个 <span class="math notranslate nohighlight">\(betas\_approx\_1\)</span> ， 然后求解的线性方程组。</p>
</div>
<dl class="cpp function">
<dt id="_CPPv4N13EPNPEstimator16FindBetasApprox1ERKN5Eigen6MatrixIdXL6EEXL10EEEERKN5Eigen6MatrixIdXL6EEXL1EEEEPN5Eigen8Vector4dE">
<span id="_CPPv3N13EPNPEstimator16FindBetasApprox1ERKN5Eigen6MatrixIdXL6EEXL10EEEERKN5Eigen6MatrixIdXL6EEXL1EEEEPN5Eigen8Vector4dE"></span><span id="_CPPv2N13EPNPEstimator16FindBetasApprox1ERKN5Eigen6MatrixIdX6EX10EEERKN5Eigen6MatrixIdX6EX1EEEPN5Eigen8Vector4dE"></span><span id="EPNPEstimator::FindBetasApprox1__Eigen::Matrix:double.6.10:CR.Eigen::Matrix:double.6.1:CR.Eigen::Vector4dP"></span>void <code class="sig-prename descclassname">EPNPEstimator<code class="sig-prename descclassname">::</code></code><code class="sig-name descname">FindBetasApprox1</code><span class="sig-paren">(</span><em class="property">const</em> Eigen::Matrix&lt;double, 6, 10&gt; &amp;<em>L6x10</em>, <em class="property">const</em> Eigen::Matrix&lt;double, 6, 1&gt; &amp;<em>rho</em>, Eigen::Vector4d *<em>betas</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N13EPNPEstimator16FindBetasApprox1ERKN5Eigen6MatrixIdXL6EEXL10EEEERKN5Eigen6MatrixIdXL6EEXL1EEEEPN5Eigen8Vector4dE" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">EPNPEstimator</span><span class="o">::</span><span class="n">FindBetasApprox1</span><span class="p">(</span><span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="o">&gt;&amp;</span> <span class="n">L6x10</span><span class="p">,</span>
                                     <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;&amp;</span> <span class="n">rho</span><span class="p">,</span>
                                     <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector4d</span><span class="o">*</span> <span class="n">betas</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span> <span class="n">L_6x4</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">L_6x4</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="n">L_6x4</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">L_6x4</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      <span class="n">L_6x4</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">Eigen</span><span class="o">::</span><span class="n">JacobiSVD</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;&gt;</span> <span class="n">svd</span><span class="p">(</span>
         <span class="n">L_6x4</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullV</span> <span class="o">|</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullU</span><span class="p">);</span>
   <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="n">Rho_temp</span> <span class="o">=</span> <span class="n">rho</span><span class="p">;</span>
   <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="n">b4</span> <span class="o">=</span> <span class="n">svd</span><span class="p">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Rho_temp</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">b4</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="n">b4</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">b4</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">b4</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">b4</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b4</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b4</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b4</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b4</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>求解线性方程组，求出 <span class="math notranslate nohighlight">\(\beta_{11}, \beta_{12}, \beta_{13}, \beta_{14}\)</span></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Eigen</span><span class="o">::</span><span class="n">JacobiSVD</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;&gt;</span> <span class="n">svd</span><span class="p">(</span>
      <span class="n">L_6x4</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullV</span> <span class="o">|</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullU</span><span class="p">);</span>

<span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="n">Rho_temp</span> <span class="o">=</span> <span class="n">rho</span><span class="p">;</span>

<span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="n">b4</span> <span class="o">=</span> <span class="n">svd</span><span class="p">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Rho_temp</span><span class="p">);</span>
</pre></div>
</div>
<p>然后求出 <span class="math notranslate nohighlight">\(\beta_1, \beta_2, \beta_3, \beta_4\)</span></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">b4</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
   <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="n">b4</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
   <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">b4</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
   <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">b4</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
   <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">b4</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">else</span> <span class="p">{</span>
   <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b4</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
   <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b4</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
   <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b4</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
   <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b4</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div></blockquote>
</div>
<div class="section" id="findbetasapprox2">
<h3>FindBetasApprox2<a class="headerlink" href="#findbetasapprox2" title="永久链接至标题">¶</a></h3>
<blockquote>
<div><p>求解 <span class="math notranslate nohighlight">\(N = 2\)</span> 时的 <span class="math notranslate nohighlight">\(\beta\)</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">betas10</span>        <span class="o">=</span> <span class="p">[</span><span class="n">B11</span> <span class="n">B12</span> <span class="n">B22</span> <span class="n">B13</span> <span class="n">B23</span> <span class="n">B33</span> <span class="n">B14</span> <span class="n">B24</span> <span class="n">B34</span> <span class="n">B44</span><span class="p">]</span>

<span class="n">betas_approx_2</span> <span class="o">=</span> <span class="p">[</span><span class="n">B11</span> <span class="n">B12</span> <span class="n">B22</span>                            <span class="p">]</span>
</pre></div>
</div>
<dl class="cpp function">
<dt id="_CPPv4N13EPNPEstimator16FindBetasApprox2ERKN5Eigen6MatrixIdXL6EEXL10EEEERKN5Eigen6MatrixIdXL6EEXL1EEEEPN5Eigen8Vector4dE">
<span id="_CPPv3N13EPNPEstimator16FindBetasApprox2ERKN5Eigen6MatrixIdXL6EEXL10EEEERKN5Eigen6MatrixIdXL6EEXL1EEEEPN5Eigen8Vector4dE"></span><span id="_CPPv2N13EPNPEstimator16FindBetasApprox2ERKN5Eigen6MatrixIdX6EX10EEERKN5Eigen6MatrixIdX6EX1EEEPN5Eigen8Vector4dE"></span><span id="EPNPEstimator::FindBetasApprox2__Eigen::Matrix:double.6.10:CR.Eigen::Matrix:double.6.1:CR.Eigen::Vector4dP"></span>void <code class="sig-prename descclassname">EPNPEstimator<code class="sig-prename descclassname">::</code></code><code class="sig-name descname">FindBetasApprox2</code><span class="sig-paren">(</span><em class="property">const</em> Eigen::Matrix&lt;double, 6, 10&gt; &amp;<em>L6x10</em>, <em class="property">const</em> Eigen::Matrix&lt;double, 6, 1&gt; &amp;<em>rho</em>, Eigen::Vector4d *<em>betas</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N13EPNPEstimator16FindBetasApprox2ERKN5Eigen6MatrixIdXL6EEXL10EEEERKN5Eigen6MatrixIdXL6EEXL1EEEEPN5Eigen8Vector4dE" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">EPNPEstimator</span><span class="o">::</span><span class="n">FindBetasApprox2</span><span class="p">(</span><span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="o">&gt;&amp;</span> <span class="n">L6x10</span><span class="p">,</span>
                               <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;&amp;</span> <span class="n">rho</span><span class="p">,</span>
                               <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector4d</span><span class="o">*</span> <span class="n">betas</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span> <span class="n">L_6x3</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">L_6x3</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">L_6x3</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">L_6x3</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">Eigen</span><span class="o">::</span><span class="n">JacobiSVD</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;&gt;</span> <span class="n">svd</span><span class="p">(</span>
      <span class="n">L_6x3</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullV</span> <span class="o">|</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullU</span><span class="p">);</span>
  <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="n">Rho_temp</span> <span class="o">=</span> <span class="n">rho</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="n">b3</span> <span class="o">=</span> <span class="n">svd</span><span class="p">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Rho_temp</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">b3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="n">b3</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">b3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="n">b3</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">:</span> <span class="mf">0.0</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b3</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">b3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b3</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">:</span> <span class="mf">0.0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">b3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
  <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>解线性方程组 求出 <span class="math notranslate nohighlight">\(\beta_{11}, \beta_{12}, \beta_{22}\)</span></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Eigen</span><span class="o">::</span><span class="n">JacobiSVD</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;&gt;</span> <span class="n">svd</span><span class="p">(</span>
      <span class="n">L_6x3</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullV</span> <span class="o">|</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullU</span><span class="p">);</span>

<span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="n">Rho_temp</span> <span class="o">=</span> <span class="n">rho</span><span class="p">;</span>

<span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="n">b3</span> <span class="o">=</span> <span class="n">svd</span><span class="p">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Rho_temp</span><span class="p">);</span>
</pre></div>
</div>
<p>然后再求出  <span class="math notranslate nohighlight">\(\beta_1, \beta_2\)</span> （ <span class="math notranslate nohighlight">\(\beta_3, \beta_4 = 0\)</span> ）</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">b3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
   <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="n">b3</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
   <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">b3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="n">b3</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">:</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">else</span> <span class="p">{</span>
   <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b3</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
   <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">b3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b3</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">:</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">b3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
   <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div></blockquote>
</div>
<div class="section" id="findbetasapprox3">
<h3>FindBetasApprox3<a class="headerlink" href="#findbetasapprox3" title="永久链接至标题">¶</a></h3>
<blockquote>
<div><p>求解 <span class="math notranslate nohighlight">\(N = 3\)</span> 时的 <span class="math notranslate nohighlight">\(\beta\)</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">betas10</span>        <span class="o">=</span> <span class="p">[</span><span class="n">B11</span> <span class="n">B12</span> <span class="n">B22</span> <span class="n">B13</span> <span class="n">B23</span> <span class="n">B33</span> <span class="n">B14</span> <span class="n">B24</span> <span class="n">B34</span> <span class="n">B44</span><span class="p">]</span>

<span class="n">betas_approx_3</span> <span class="o">=</span> <span class="p">[</span><span class="n">B11</span> <span class="n">B12</span> <span class="n">B22</span> <span class="n">B13</span> <span class="n">B23</span>                    <span class="p">]</span>
</pre></div>
</div>
<dl class="cpp function">
<dt id="_CPPv4N13EPNPEstimator16FindBetasApprox3ERKN5Eigen6MatrixIdXL6EEXL10EEEERKN5Eigen6MatrixIdXL6EEXL1EEEEPN5Eigen8Vector4dE">
<span id="_CPPv3N13EPNPEstimator16FindBetasApprox3ERKN5Eigen6MatrixIdXL6EEXL10EEEERKN5Eigen6MatrixIdXL6EEXL1EEEEPN5Eigen8Vector4dE"></span><span id="_CPPv2N13EPNPEstimator16FindBetasApprox3ERKN5Eigen6MatrixIdX6EX10EEERKN5Eigen6MatrixIdX6EX1EEEPN5Eigen8Vector4dE"></span><span id="EPNPEstimator::FindBetasApprox3__Eigen::Matrix:double.6.10:CR.Eigen::Matrix:double.6.1:CR.Eigen::Vector4dP"></span>void <code class="sig-prename descclassname">EPNPEstimator<code class="sig-prename descclassname">::</code></code><code class="sig-name descname">FindBetasApprox3</code><span class="sig-paren">(</span><em class="property">const</em> Eigen::Matrix&lt;double, 6, 10&gt; &amp;<em>L6x10</em>, <em class="property">const</em> Eigen::Matrix&lt;double, 6, 1&gt; &amp;<em>rho</em>, Eigen::Vector4d *<em>betas</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N13EPNPEstimator16FindBetasApprox3ERKN5Eigen6MatrixIdXL6EEXL10EEEERKN5Eigen6MatrixIdXL6EEXL1EEEEPN5Eigen8Vector4dE" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">EPNPEstimator</span><span class="o">::</span><span class="n">FindBetasApprox3</span><span class="p">(</span><span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="o">&gt;&amp;</span> <span class="n">L6x10</span><span class="p">,</span>
                                     <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;&amp;</span> <span class="n">rho</span><span class="p">,</span>
                                     <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector4d</span><span class="o">*</span> <span class="n">betas</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">Eigen</span><span class="o">::</span><span class="n">JacobiSVD</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="o">&gt;&gt;</span> <span class="n">svd</span><span class="p">(</span>
      <span class="n">L6x10</span><span class="p">.</span><span class="n">leftCols</span><span class="o">&lt;</span><span class="mi">5</span><span class="o">&gt;</span><span class="p">(),</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullV</span> <span class="o">|</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullU</span><span class="p">);</span>
   <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="n">Rho_temp</span> <span class="o">=</span> <span class="n">rho</span><span class="p">;</span>
   <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="n">b5</span> <span class="o">=</span> <span class="n">svd</span><span class="p">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Rho_temp</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">b5</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="n">b5</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">b5</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="n">b5</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">:</span> <span class="mf">0.0</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">else</span> <span class="p">{</span>
      <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b5</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">b5</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b5</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">:</span> <span class="mf">0.0</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">b5</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
   <span class="p">}</span>

   <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b5</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
   <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>解线性方程组 求出 <span class="math notranslate nohighlight">\(\beta_{11}, \beta_{12}, \beta_{22}, \beta_{13}, \beta_{23}\)</span></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Eigen</span><span class="o">::</span><span class="n">JacobiSVD</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="o">&gt;&gt;</span> <span class="n">svd</span><span class="p">(</span>
      <span class="n">L6x10</span><span class="p">.</span><span class="n">leftCols</span><span class="o">&lt;</span><span class="mi">5</span><span class="o">&gt;</span><span class="p">(),</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullV</span> <span class="o">|</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullU</span><span class="p">);</span>

<span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="n">Rho_temp</span> <span class="o">=</span> <span class="n">rho</span><span class="p">;</span>

<span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="n">b5</span> <span class="o">=</span> <span class="n">svd</span><span class="p">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Rho_temp</span><span class="p">);</span>
</pre></div>
</div>
<p>然后再求出  <span class="math notranslate nohighlight">\(\beta_1, \beta_2, \beta_3\)</span> （ <span class="math notranslate nohighlight">\(\beta_4 = 0\)</span> ）</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">b5</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
   <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="n">b5</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
   <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">b5</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="n">b5</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">:</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">else</span> <span class="p">{</span>
   <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b5</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
   <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">b5</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">b5</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">:</span> <span class="mf">0.0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">b5</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
   <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>

<span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b5</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div></blockquote>
</div>
<div class="section" id="rungaussnewton">
<h3>RunGaussNewton<a class="headerlink" href="#rungaussnewton" title="永久链接至标题">¶</a></h3>
<blockquote>
<div><p>在使用approx进行 <span class="math notranslate nohighlight">\(\beta\)</span> 的初值求解后，需要使用GaussNewton的方法进行参数 <span class="math notranslate nohighlight">\(\beta\)</span> 的优化。</p>
<p>记：</p>
<div class="math notranslate nohighlight">
\[Error(\beta) = \sum\limits_{(i,j)~s.t.~i &lt; j} (||c_i^c - c_j^c||^2 - ||c_i^w - c_j^w||^2)\]</div>
<div class="math notranslate nohighlight">
\[\Downarrow\]</div>
<div class="math notranslate nohighlight">
\[Error(\beta) = \sum\limits_{(i,j)~s.t.~i &lt; j} (\sum\limits_{k=1}^4 || \beta_k v_k^{[i]} - \beta_k v_k^{[j]} ||^2 - ||c_i^w - c_j^w||^2)\]</div>
<p>高斯牛顿法主要是要通过偏差对 <span class="math notranslate nohighlight">\(\beta_1,\beta_2,\beta_3,\beta_4\)</span> 进行求导，这是数对矩阵的求导。</p>
<div class="math notranslate nohighlight">
\[Error(\beta_0 + \Delta \beta) = Error(\beta_0) + Error'(\beta) \Delta \beta = 0\]</div>
<p>从而有等式：</p>
<div class="align-center figure align-default">
<a class="reference internal image-reference" href="../../../../../../_images/6.jpg"><img alt="../../../../../../_images/6.jpg" src="../../../../../../_images/6.jpg" style="width: 377.25px; height: 86.25px;" /></a>
</div>
<p>这里分开来看：</p>
<p><span class="math notranslate nohighlight">\(Error'(\beta)\)</span> ，称为 <span class="math notranslate nohighlight">\(A\)</span> 矩阵。 实际上是 <span class="math notranslate nohighlight">\(Error(\beta)\)</span> 分别对  <span class="math notranslate nohighlight">\(\beta_i\)</span> 求偏导：</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{eqnarray}
A &amp;=&amp; [\frac{\delta Error(\beta)}{\delta \beta_1}~~~\frac{\delta Error(\beta)}{\delta \beta_2}~~~\frac{\delta Error(\beta)}{\delta \beta_3}~~~\frac{\delta Error(\beta)}{\delta \beta_4}]\\\\
  &amp;=&amp; [2L_1\beta_1+L_2\beta_2+L_4\beta_3+L_7\beta_4~~~ L_2\beta_1+2L_3\beta_2+L_5\beta_3+L_8\beta_4~~~···~~~···]
\end{eqnarray}\end{split}\]</div>
<p>然后对 <span class="math notranslate nohighlight">\(A\)</span> 矩阵进行 <span class="math notranslate nohighlight">\(QR\)</span> 分解，得到：</p>
<div class="math notranslate nohighlight">
\[\Delta \beta = x = R^{-1} Q^{-1} b\]</div>
<p>进而进行迭代：</p>
<div class="math notranslate nohighlight">
\[\beta' = \beta_0 + \Delta \beta\]</div>
<dl class="cpp function">
<dt id="_CPPv4N13EPNPEstimator14RunGaussNewtonERKN5Eigen6MatrixIdXL6EEXL10EEEERKN5Eigen6MatrixIdXL6EEXL1EEEEPN5Eigen8Vector4dE">
<span id="_CPPv3N13EPNPEstimator14RunGaussNewtonERKN5Eigen6MatrixIdXL6EEXL10EEEERKN5Eigen6MatrixIdXL6EEXL1EEEEPN5Eigen8Vector4dE"></span><span id="_CPPv2N13EPNPEstimator14RunGaussNewtonERKN5Eigen6MatrixIdX6EX10EEERKN5Eigen6MatrixIdX6EX1EEEPN5Eigen8Vector4dE"></span><span id="EPNPEstimator::RunGaussNewton__Eigen::Matrix:double.6.10:CR.Eigen::Matrix:double.6.1:CR.Eigen::Vector4dP"></span>void <code class="sig-prename descclassname">EPNPEstimator<code class="sig-prename descclassname">::</code></code><code class="sig-name descname">RunGaussNewton</code><span class="sig-paren">(</span><em class="property">const</em> Eigen::Matrix&lt;double, 6, 10&gt; &amp;<em>L6x10</em>, <em class="property">const</em> Eigen::Matrix&lt;double, 6, 1&gt; &amp;<em>rho</em>, Eigen::Vector4d *<em>betas</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N13EPNPEstimator14RunGaussNewtonERKN5Eigen6MatrixIdXL6EEXL10EEEERKN5Eigen6MatrixIdXL6EEXL1EEEEPN5Eigen8Vector4dE" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">EPNPEstimator</span><span class="o">::</span><span class="n">RunGaussNewton</span><span class="p">(</span><span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="o">&gt;&amp;</span> <span class="n">L6x10</span><span class="p">,</span>
                             <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;&amp;</span> <span class="n">rho</span><span class="p">,</span>
                             <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector4d</span><span class="o">*</span> <span class="n">betas</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span> <span class="n">A</span><span class="p">;</span>
  <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="n">b</span><span class="p">;</span>

  <span class="k">const</span> <span class="kt">int</span> <span class="n">kNumIterations</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">kNumIterations</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">];</span>
         <span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">];</span>
         <span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                <span class="mi">2</span> <span class="o">*</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">];</span>
         <span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">];</span>

         <span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">rho</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                        <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                        <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                        <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                        <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                        <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                        <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span>
                        <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span>
                        <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span>
                        <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">]);</span>
      <span class="p">}</span>

      <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector4d</span> <span class="n">x</span> <span class="o">=</span> <span class="n">A</span><span class="p">.</span><span class="n">colPivHouseholderQr</span><span class="p">().</span><span class="n">solve</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>

      <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)</span> <span class="o">+=</span> <span class="n">x</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>结合代码来看，设定迭代次数为5次</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="kt">int</span> <span class="n">kNumIterations</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</pre></div>
</div>
<p>由于 <span class="math notranslate nohighlight">\(L\)</span> 是 <span class="math notranslate nohighlight">\(6 \times 10\)</span> 的矩阵，因此对每一行先进行求解。</p>
<div class="math notranslate nohighlight">
\[L(i,0) * b[0] + L(i,1) * b[1] + ... + L(i,9) * b[9] = r[i]\]</div>
<p>那么对于 <span class="math notranslate nohighlight">\(\beta_1\)</span> 求偏导，只有 <span class="math notranslate nohighlight">\(b[0],b[1],b[3],b[6]\)</span> 含有 <span class="math notranslate nohighlight">\(\beta_1\)</span> 项，剩下的项对 <span class="math notranslate nohighlight">\(\beta_1\)</span> 求偏导后均为 <span class="math notranslate nohighlight">\(0\)</span></p>
<p>因此  <span class="math notranslate nohighlight">\(A(i,0)\)</span> 是 <span class="math notranslate nohighlight">\(Error_{ij}(\beta)\)</span> 对 <span class="math notranslate nohighlight">\(\beta_1\)</span> 求偏导：</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{eqnarray}
A(i,0) &amp;=&amp; \frac{\delta L(i,0) * \beta_1^2}{\delta \beta_1} + \frac{\delta L(i,1) * \beta_1 \beta_2}{\delta \beta_1} + \frac{\delta L(i,3) * \beta_1\beta_3}{\delta \beta_1} + \frac{\delta L(i,6) * \beta_1\beta_4}{\delta \beta_1}
\\\\&amp;=&amp; 2 * L(i,0) * \beta_1 + L(i,1) * \beta_2 + L(i,3) * \beta_3 + L(i, 6) * \beta_4
\end{eqnarray}\end{split}\]</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                <span class="n">L</span> <span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="mi">10</span><span class="p">)</span>                       <span class="o">*</span>   <span class="n">betas</span> <span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="mi">1</span><span class="p">)</span>    <span class="o">=</span>  <span class="n">rho</span> <span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="mi">1</span><span class="p">)</span>

<span class="o">|</span> <span class="o">||</span><span class="n">v1i</span><span class="o">-</span><span class="n">v1j</span><span class="o">||^</span><span class="mi">2</span>  <span class="mi">2</span><span class="o">*|</span><span class="p">(</span><span class="n">v1i</span><span class="o">-</span><span class="n">v1j</span><span class="p">)(</span><span class="n">v2i</span><span class="o">-</span><span class="n">v2j</span><span class="p">)</span><span class="o">|</span>    <span class="o">..|</span>   <span class="o">|</span> <span class="n">betas1</span><span class="o">*</span><span class="n">betas1</span> <span class="o">|</span>   <span class="o">|</span> <span class="n">dcw0_1</span> <span class="o">|</span>
<span class="o">|</span>      <span class="o">..</span>                                    <span class="o">|</span>   <span class="o">|</span> <span class="n">betas1</span><span class="o">*</span><span class="n">betas2</span> <span class="o">|</span>   <span class="o">|</span> <span class="n">dcw0_2</span> <span class="o">|</span>
<span class="o">|</span>      <span class="o">..</span>                                    <span class="o">|</span>   <span class="o">|</span> <span class="n">betas2</span><span class="o">*</span><span class="n">betas2</span> <span class="o">|</span>   <span class="o">|</span> <span class="n">dcw0_3</span> <span class="o">|</span>
<span class="o">|</span>      <span class="o">..</span>                                    <span class="o">|</span> <span class="o">*</span> <span class="o">|</span> <span class="n">betas1</span><span class="o">*</span><span class="n">betas3</span> <span class="o">|</span> <span class="o">=</span> <span class="o">|</span> <span class="n">dcw1_2</span> <span class="o">|</span>
<span class="o">|</span>      <span class="o">..</span>                                    <span class="o">|</span>   <span class="o">|</span> <span class="n">betas2</span><span class="o">*</span><span class="n">betas3</span> <span class="o">|</span>   <span class="o">|</span> <span class="n">dcw1_3</span> <span class="o">|</span>
<span class="o">|</span>      <span class="o">..</span>                                    <span class="o">|</span>   <span class="o">|</span> <span class="n">betas3</span><span class="o">*</span><span class="n">betas3</span> <span class="o">|</span>   <span class="o">|</span> <span class="n">dcw2_3</span> <span class="o">|</span>
                                                 <span class="o">|</span> <span class="n">betas1</span><span class="o">*</span><span class="n">betas4</span> <span class="o">|</span>
                                                 <span class="o">|</span> <span class="n">betas2</span><span class="o">*</span><span class="n">betas4</span> <span class="o">|</span>
                                                 <span class="o">|</span> <span class="n">betas3</span><span class="o">*</span><span class="n">betas4</span> <span class="o">|</span>
                                                 <span class="o">|</span> <span class="n">betas4</span><span class="o">*</span><span class="n">betas4</span> <span class="o">|</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
         <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">];</span>

<span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
         <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">];</span>

<span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
         <span class="mi">2</span> <span class="o">*</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">];</span>

<span class="n">A</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
         <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">];</span>
</pre></div>
</div>
<p>方程 <span class="math notranslate nohighlight">\(Ax = b\)</span> 的右侧 <span class="math notranslate nohighlight">\(b\)</span> 为 <span class="math notranslate nohighlight">\(\rho - L \beta_0\)</span>，使用的是Approx求出的初值 <span class="math notranslate nohighlight">\(\beta_0\)</span></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">rho</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
               <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
               <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
               <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
               <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
               <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
               <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span>
               <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span>
               <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span>
               <span class="n">L6x10</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)[</span><span class="mi">3</span><span class="p">]);</span>
</pre></div>
</div>
<p>然后通过 <span class="math notranslate nohighlight">\(QR\)</span> 分解得到 <span class="math notranslate nohighlight">\(\Delta \beta\)</span> ，加到 <span class="math notranslate nohighlight">\(\beta\)</span> 上进行迭代</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector4d</span> <span class="n">x</span> <span class="o">=</span> <span class="n">A</span><span class="p">.</span><span class="n">colPivHouseholderQr</span><span class="p">().</span><span class="n">solve</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>

<span class="p">(</span><span class="o">*</span><span class="n">betas</span><span class="p">)</span> <span class="o">+=</span> <span class="n">x</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div></blockquote>
</div>
<div class="section" id="computert">
<h3>ComputeRT<a class="headerlink" href="#computert" title="永久链接至标题">¶</a></h3>
<blockquote>
<div><dl class="cpp function">
<dt id="_CPPv4N13EPNPEstimator9ComputeRTERKN5Eigen6MatrixIdXL12EEXL12EEEERKN5Eigen8Vector4dEPN5Eigen8Matrix3dEPN5Eigen8Vector3dE">
<span id="_CPPv3N13EPNPEstimator9ComputeRTERKN5Eigen6MatrixIdXL12EEXL12EEEERKN5Eigen8Vector4dEPN5Eigen8Matrix3dEPN5Eigen8Vector3dE"></span><span id="_CPPv2N13EPNPEstimator9ComputeRTERKN5Eigen6MatrixIdX12EX12EEERKN5Eigen8Vector4dEPN5Eigen8Matrix3dEPN5Eigen8Vector3dE"></span><span id="EPNPEstimator::ComputeRT__Eigen::Matrix:double.12.12:CR.Eigen::Vector4dCR.Eigen::Matrix3dP.Eigen::Vector3dP"></span>double <code class="sig-prename descclassname">EPNPEstimator<code class="sig-prename descclassname">::</code></code><code class="sig-name descname">ComputeRT</code><span class="sig-paren">(</span><em class="property">const</em> Eigen::Matrix&lt;double, 12, 12&gt; &amp;<em>Ut</em>, <em class="property">const</em> Eigen::Vector4d &amp;<em>betas</em>, Eigen::Matrix3d *<em>R</em>, Eigen::Vector3d *<em>t</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N13EPNPEstimator9ComputeRTERKN5Eigen6MatrixIdXL12EEXL12EEEERKN5Eigen8Vector4dEPN5Eigen8Matrix3dEPN5Eigen8Vector3dE" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">double</span> <span class="n">EPNPEstimator</span><span class="o">::</span><span class="n">ComputeRT</span><span class="p">(</span><span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="o">&gt;&amp;</span> <span class="n">Ut</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector4d</span><span class="o">&amp;</span> <span class="n">betas</span><span class="p">,</span>
                          <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3d</span><span class="o">*</span> <span class="n">R</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>

   <span class="c1">// 计算控制点在相机坐标系下的坐标</span>
   <span class="n">ComputeCcs</span><span class="p">(</span><span class="n">betas</span><span class="p">,</span> <span class="n">Ut</span><span class="p">);</span>

   <span class="c1">// 计算3D参考点在摄像头参考坐标系下的坐标</span>
   <span class="n">ComputePcs</span><span class="p">();</span>

   <span class="c1">// 保证pcs和ccs坐标非负</span>
   <span class="n">SolveForSign</span><span class="p">();</span>

   <span class="c1">//</span>
   <span class="n">EstimateRT</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>

   <span class="k">return</span> <span class="nf">ComputeTotalReprojectionError</span><span class="p">(</span><span class="o">*</span><span class="n">R</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>通过带入 <span class="math notranslate nohighlight">\(\beta\)</span> 的值到 <span class="math notranslate nohighlight">\(x = \sum\limits_{i=1}^N \beta_i v_i \)</span> ，然后通过控制点的系数 <span class="math notranslate nohighlight">\(\alpha_{ij}\)</span> 计算相机坐标系下参考点坐标 <span class="math notranslate nohighlight">\(p_i^c\)</span> 。</p>
<p>得到的坐标需要使深度值为正数所以得对符号进行处理。</p>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>有了相机坐标系和世界坐标系的对应点就是3D-3D，就可以使用ICP进行求解。</p>
<p>👉 <a class="reference internal" href="../../../../../paper/pointcloud/Least_Squares_Fitting/Least_Squares_Fitting.html"><span class="doc">SVD求解ICP方法</span></a></p>
</div>
<p>求解 <span class="math notranslate nohighlight">\(R, t\)</span> 的步骤为：</p>
<ol class="arabic">
<li><p>计算控制点在相机坐标系下的坐标</p>
<div class="math notranslate nohighlight">
\[c_i^c = \sum\limits_{j=1}^N \beta_k v_k^{[i]}, i = 1, ..., 4\]</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">EPNPEstimator</span><span class="o">::</span><span class="n">ComputeCcs</span><span class="p">(</span><span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector4d</span><span class="o">&amp;</span> <span class="n">betas</span><span class="p">,</span>
                   <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="o">&gt;&amp;</span> <span class="n">Ut</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ccs_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ccs_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ccs_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ccs_</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">betas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">Ut</span><span class="p">(</span><span class="mi">11</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="n">k</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>计算3d点在相机坐标系下的坐标</p>
<div class="math notranslate nohighlight">
\[p_i^c = \sum\limits_{j=1}^4 \alpha_{ij}c_j^c, i = 1,...,n\]</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">EPNPEstimator</span><span class="o">::</span><span class="n">ComputePcs</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">pcs_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">points2D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">());</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">points3D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">pcs_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">alphas_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ccs_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">alphas_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">ccs_</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span>
                   <span class="n">alphas_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">ccs_</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">alphas_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">ccs_</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>保证pcs和ccs坐标非负</p>
<p>检查第一个相机坐标系下的3d点，若发现深度为负，则调整所有ccs和所有pcs使其坐标非负。</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">EPNPEstimator</span><span class="o">::</span><span class="n">SolveForSign</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">pcs_</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ccs_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">ccs_</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">points3D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">pcs_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">pcs_</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>计算R和t</p>
<p>EstimateRT</p>
</li>
<li><p>计算重投影误差并返回其值</p>
<p>ComputeTotalReprojectionError</p>
</li>
</ol>
</div>
</div></blockquote>
</div>
<div class="section" id="estimatert">
<h3>EstimateRT<a class="headerlink" href="#estimatert" title="永久链接至标题">¶</a></h3>
<blockquote>
<div><p>该步骤是使用的ICP求解 <span class="math notranslate nohighlight">\(R,t\)</span></p>
<dl class="cpp function">
<dt id="_CPPv4N13EPNPEstimator10EstimateRTEPN5Eigen8Matrix3dEPN5Eigen8Vector3dE">
<span id="_CPPv3N13EPNPEstimator10EstimateRTEPN5Eigen8Matrix3dEPN5Eigen8Vector3dE"></span><span id="_CPPv2N13EPNPEstimator10EstimateRTEPN5Eigen8Matrix3dEPN5Eigen8Vector3dE"></span><span id="EPNPEstimator::EstimateRT__Eigen::Matrix3dP.Eigen::Vector3dP"></span>void <code class="sig-prename descclassname">EPNPEstimator<code class="sig-prename descclassname">::</code></code><code class="sig-name descname">EstimateRT</code><span class="sig-paren">(</span>Eigen::Matrix3d *<em>R</em>, Eigen::Vector3d *<em>t</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N13EPNPEstimator10EstimateRTEPN5Eigen8Matrix3dEPN5Eigen8Vector3dE" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">EPNPEstimator</span><span class="p">::</span><span class="n">EstimateRT</span><span class="p">(</span><span class="n">Eigen</span><span class="p">::</span><span class="n">Matrix3d</span><span class="o">*</span> <span class="n">R</span><span class="p">,</span> <span class="n">Eigen</span><span class="p">::</span><span class="n">Vector3d</span><span class="o">*</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Eigen</span><span class="p">::</span><span class="n">Vector3d</span> <span class="n">pc0</span> <span class="o">=</span> <span class="n">Eigen</span><span class="p">::</span><span class="n">Vector3d</span><span class="p">::</span><span class="n">Zero</span><span class="p">();</span>
  <span class="n">Eigen</span><span class="p">::</span><span class="n">Vector3d</span> <span class="n">pw0</span> <span class="o">=</span> <span class="n">Eigen</span><span class="p">::</span><span class="n">Vector3d</span><span class="p">::</span><span class="n">Zero</span><span class="p">();</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">points3D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">pc0</span> <span class="o">+=</span> <span class="n">pcs_</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">pw0</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">points3D_</span><span class="p">)[</span><span class="n">i</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="n">pc0</span> <span class="o">/=</span> <span class="n">points3D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>
  <span class="n">pw0</span> <span class="o">/=</span> <span class="n">points3D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>

  <span class="n">Eigen</span><span class="p">::</span><span class="n">Matrix3d</span> <span class="n">abt</span> <span class="o">=</span> <span class="n">Eigen</span><span class="p">::</span><span class="n">Matrix3d</span><span class="p">::</span><span class="n">Zero</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">points3D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">abt</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pcs_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">pc0</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">points3D_</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pw0</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="n">abt</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pcs_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">pc0</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">points3D_</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pw0</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="n">abt</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pcs_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">pc0</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">points3D_</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">pw0</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">Eigen</span><span class="p">::</span><span class="n">JacobiSVD</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="p">::</span><span class="n">Matrix3d</span><span class="o">&gt;</span> <span class="n">svd</span><span class="p">(</span>
      <span class="n">abt</span><span class="p">,</span> <span class="n">Eigen</span><span class="p">::</span><span class="n">ComputeFullV</span> <span class="o">|</span> <span class="n">Eigen</span><span class="p">::</span><span class="n">ComputeFullU</span><span class="p">);</span>
  <span class="n">const</span> <span class="n">Eigen</span><span class="p">::</span><span class="n">Matrix3d</span> <span class="n">abt_U</span> <span class="o">=</span> <span class="n">svd</span><span class="o">.</span><span class="n">matrixU</span><span class="p">();</span>
  <span class="n">const</span> <span class="n">Eigen</span><span class="p">::</span><span class="n">Matrix3d</span> <span class="n">abt_V</span> <span class="o">=</span> <span class="n">svd</span><span class="o">.</span><span class="n">matrixV</span><span class="p">();</span>

  <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">(</span><span class="o">*</span><span class="n">R</span><span class="p">)(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">abt_U</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">abt_V</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">R</span><span class="o">-&gt;</span><span class="n">determinant</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Eigen</span><span class="p">::</span><span class="n">Matrix3d</span> <span class="n">Abt_v_prime</span> <span class="o">=</span> <span class="n">abt_V</span><span class="p">;</span>
    <span class="n">Abt_v_prime</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">abt_V</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">(</span><span class="o">*</span><span class="n">R</span><span class="p">)(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">abt_U</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">Abt_v_prime</span><span class="o">.</span><span class="n">row</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">pc0</span> <span class="o">-</span> <span class="o">*</span><span class="n">R</span> <span class="o">*</span> <span class="n">pw0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<ol class="arabic">
<li><p>计算世界坐标系和相机坐标系下的质心坐标</p>
<div class="math notranslate nohighlight">
\[p_0^w = \frac{1}{n} \sum\limits_{i=1}^n p_i^w\]</div>
<div class="math notranslate nohighlight">
\[p_0^c = \frac{1}{n} \sum\limits_{i=1}^n p_i^c\]</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">points3D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">pc0</span> <span class="o">+=</span> <span class="n">pcs_</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
   <span class="n">pw0</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">points3D_</span><span class="p">)[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="n">pc0</span> <span class="o">/=</span> <span class="n">points3D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>
<span class="n">pw0</span> <span class="o">/=</span> <span class="n">points3D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>
</pre></div>
</div>
</li>
<li><p>计算世界坐标系和相机坐标系去除质心的矩阵 <span class="math notranslate nohighlight">\(A,B\)</span></p>
<div class="math notranslate nohighlight">
\[\begin{split}A = \left[
\begin{matrix}
p_1^{w^T} - p_0^{w^T}\\···\\p_n^{w^T} - p_0^{w^T}
\end{matrix}
\right]\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}B = \left[
\begin{matrix}
p_1^{c^T} - p_0^{c^T}\\···\\p_n^{c^T} - p_0^{c^T}
\end{matrix}
\right]\end{split}\]</div>
</li>
<li><p>计算 <span class="math notranslate nohighlight">\(W\)</span> 矩阵</p>
<div class="math notranslate nohighlight">
\[W = B^T A\]</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3d</span> <span class="n">abt</span> <span class="o">=</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3d</span><span class="o">::</span><span class="n">Zero</span><span class="p">();</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">points3D_</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">abt</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pcs_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">pc0</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">points3D_</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pw0</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="n">abt</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pcs_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">pc0</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">points3D_</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pw0</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="n">abt</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+=</span> <span class="p">(</span><span class="n">pcs_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">pc0</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="p">((</span><span class="o">*</span><span class="n">points3D_</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">pw0</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>对 <span class="math notranslate nohighlight">\(W\)</span> 进行SVD分解  <span class="math notranslate nohighlight">\(W = U \Sigma V^T\)</span></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">Eigen</span><span class="o">::</span><span class="n">JacobiSVD</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3d</span><span class="o">&gt;</span> <span class="n">svd</span><span class="p">(</span><span class="n">abt</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullV</span> <span class="o">|</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">ComputeFullU</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>计算旋转 <span class="math notranslate nohighlight">\(R\)</span></p>
<div class="math notranslate nohighlight">
\[R = UV^T\]</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3d</span> <span class="n">abt_U</span> <span class="o">=</span> <span class="n">svd</span><span class="p">.</span><span class="n">matrixU</span><span class="p">();</span>
<span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3d</span> <span class="n">abt_V</span> <span class="o">=</span> <span class="n">svd</span><span class="p">.</span><span class="n">matrixV</span><span class="p">();</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
   <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
      <span class="p">(</span><span class="o">*</span><span class="n">R</span><span class="p">)(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">abt_U</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">abt_V</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="n">j</span><span class="p">).</span><span class="n">transpose</span><span class="p">();</span>
</pre></div>
</div>
<p>如果 <span class="math notranslate nohighlight">\(|R| &lt; 0\)</span> ，则 <span class="math notranslate nohighlight">\(R(2,:) = -R(2:0)\)</span></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">R</span><span class="o">-&gt;</span><span class="n">determinant</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3d</span> <span class="n">Abt_v_prime</span> <span class="o">=</span> <span class="n">abt_V</span><span class="p">;</span>

   <span class="n">Abt_v_prime</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">abt_V</span><span class="p">.</span><span class="n">col</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

   <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
         <span class="p">(</span><span class="o">*</span><span class="n">R</span><span class="p">)(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">abt_U</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">Abt_v_prime</span><span class="p">.</span><span class="n">row</span><span class="p">(</span><span class="n">j</span><span class="p">).</span><span class="n">transpose</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>计算平移 <span class="math notranslate nohighlight">\(t\)</span> :</p>
<div class="math notranslate nohighlight">
\[t = p_0^c - Rp_0^w\]</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">pc0</span> <span class="o">-</span> <span class="o">*</span><span class="n">R</span> <span class="o">*</span> <span class="n">pw0</span><span class="p">;</span>
</pre></div>
</div>
</li>
</ol>
</div>
</div></blockquote>
</div>
<div class="section" id="computetotalreprojectionerror">
<h3>ComputeTotalReprojectionError<a class="headerlink" href="#computetotalreprojectionerror" title="永久链接至标题">¶</a></h3>
<blockquote>
<div><p>通过计算出的 <span class="math notranslate nohighlight">\(R,t\)</span> 组成位姿矩阵，来计算2D点和3D点之间的重投影平方误差</p>
<dl class="cpp function">
<dt id="_CPPv4N13EPNPEstimator29ComputeTotalReprojectionErrorERKN5Eigen8Matrix3dERKN5Eigen8Vector3dE">
<span id="_CPPv3N13EPNPEstimator29ComputeTotalReprojectionErrorERKN5Eigen8Matrix3dERKN5Eigen8Vector3dE"></span><span id="_CPPv2N13EPNPEstimator29ComputeTotalReprojectionErrorERKN5Eigen8Matrix3dERKN5Eigen8Vector3dE"></span><span id="EPNPEstimator::ComputeTotalReprojectionError__Eigen::Matrix3dCR.Eigen::Vector3dCR"></span>double <code class="sig-prename descclassname">EPNPEstimator<code class="sig-prename descclassname">::</code></code><code class="sig-name descname">ComputeTotalReprojectionError</code><span class="sig-paren">(</span><em class="property">const</em> Eigen::Matrix3d &amp;<em>R</em>, <em class="property">const</em> Eigen::Vector3d &amp;<em>t</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N13EPNPEstimator29ComputeTotalReprojectionErrorERKN5Eigen8Matrix3dERKN5Eigen8Vector3dE" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">double</span> <span class="n">EPNPEstimator</span><span class="o">::</span><span class="n">ComputeTotalReprojectionError</span><span class="p">(</span><span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3d</span><span class="o">&amp;</span> <span class="n">R</span><span class="p">,</span>
                                                    <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3x4d</span> <span class="n">proj_matrix</span><span class="p">;</span>
   <span class="n">proj_matrix</span><span class="p">.</span><span class="n">leftCols</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="p">()</span> <span class="o">=</span> <span class="n">R</span><span class="p">;</span>
   <span class="n">proj_matrix</span><span class="p">.</span><span class="n">rightCols</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">()</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>

   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">residuals</span><span class="p">;</span>
   <span class="n">ComputeSquaredReprojectionError</span><span class="p">(</span><span class="o">*</span><span class="n">points2D_</span><span class="p">,</span> <span class="o">*</span><span class="n">points3D_</span><span class="p">,</span> <span class="n">proj_matrix</span><span class="p">,</span>
                                  <span class="o">&amp;</span><span class="n">residuals</span><span class="p">);</span>

   <span class="kt">double</span> <span class="n">reproj_error</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="kt">double</span> <span class="nl">residual</span> <span class="p">:</span> <span class="n">residuals</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">reproj_error</span> <span class="o">+=</span> <span class="n">std</span><span class="o">::</span><span class="n">sqrt</span><span class="p">(</span><span class="n">residual</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="n">reproj_error</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../P3P/P3P.html" class="btn btn-neutral float-right" title="P3P" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../PnP.html" class="btn btn-neutral float-left" title="3. PnP" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; 版权所有 2021, linzzz.

    </p>
  </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
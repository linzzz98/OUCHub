

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>1. Incremental_Mapper &mdash; OUCHub  文档</title>
  

  
  <link rel="stylesheet" href="../../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../_static/twemoji.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../../_static/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../../" src="../../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../../_static/jquery.js"></script>
        <script src="../../../../../../_static/underscore.js"></script>
        <script src="../../../../../../_static/doctools.js"></script>
        <script src="../../../../../../_static/language_data.js"></script>
        <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js"></script>
        <script src="../../../../../../_static/twemoji.js"></script>
        <script src="../../../../../../_static/translations.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../../../../../../genindex.html" />
    <link rel="search" title="搜索" href="../../../../../../search.html" />
    <link rel="next" title="🍑 TheiaSfM" href="../../../../theiasfm.html" />
    <link rel="prev" title="SfM Pipeline" href="../../../c_sfm.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: black" >
          

          
            <a href="../../../../../../index.html" class="icon icon-home"> OUCHub
          

          
            
            <img src="../../../../../../_static/logo_2.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">基础知识</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../knowledge/k_MH.html">💊 Math</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../knowledge/k_CV.html">🍤 Computer Vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../knowledge/k_ML.html">🍎 Machine Learning</a></li>
</ul>
<p class="caption"><span class="caption-text">论文学习</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../paper/p_sfm.html">🍊 Structure from Motion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../paper/p_pointcloud.html">🍋 Point Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../paper/p_others.html">🍒 Others</a></li>
</ul>
<p class="caption"><span class="caption-text">源码解析</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../../colmap.html">🍑 Colmap</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../c_base.html">Base</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../c_estimator.html">Estimator</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../../c_sfm.html">SfM Pipeline</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">1. Incremental_Mapper</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">配置选项</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">结构体</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">成员变量</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">成员函数</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#incrementalmapper">IncrementalMapper</a></li>
<li class="toctree-l5"><a class="reference internal" href="#beginreconstruction">BeginReconstruction</a></li>
<li class="toctree-l5"><a class="reference internal" href="#endrestruction">EndRestruction</a></li>
<li class="toctree-l5"><a class="reference internal" href="#findinitialimagepair">FindInitialImagePair</a></li>
<li class="toctree-l5"><a class="reference internal" href="#findfirstinitialimage">FindFirstInitialImage</a></li>
<li class="toctree-l5"><a class="reference internal" href="#findsecondinitialimage">FindSecondInitialImage</a></li>
<li class="toctree-l5"><a class="reference internal" href="#findnextimages">FindNextImages</a></li>
<li class="toctree-l5"><a class="reference internal" href="#findlocalbundle">FindLocalBundle</a></li>
<li class="toctree-l5"><a class="reference internal" href="#estimateinitialtwoviewgeometry">EstimateInitialTwoViewGeometry</a></li>
<li class="toctree-l5"><a class="reference internal" href="#registerinitialimagepair">RegisterInitialImagePair</a></li>
<li class="toctree-l5"><a class="reference internal" href="#registernextimage">RegisterNextImage</a></li>
<li class="toctree-l5"><a class="reference internal" href="#triangulate">Triangulate</a></li>
<li class="toctree-l5"><a class="reference internal" href="#adjustlocalbundle">AdjustLocalBundle</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../theiasfm.html">🍑 TheiaSfM</a></li>
</ul>
<p class="caption"><span class="caption-text">杂七杂八</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../others/o_others.html">🍺 Others</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">OUCHub</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../../colmap.html">🍑 Colmap</a> &raquo;</li>
        
          <li><a href="../../../c_sfm.html">SfM Pipeline</a> &raquo;</li>
        
      <li><span class="section-number">1. </span>Incremental_Mapper</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../../../../_sources/pages/code/colmap/sfm/Incremental/Mapper/Mapper.rst.txt" rel="nofollow"> 查看页面源码</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="incremental-mapper">
<h1><span class="section-number">1. </span>Incremental_Mapper<a class="headerlink" href="#incremental-mapper" title="永久链接至标题">¶</a></h1>
<p>为增量重建过程提供所有功能的类</p>
<div class="admonition important">
<p class="admonition-title">重要</p>
<p>使用方法如下：</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// 构造一个IncrementalMapper，读取数据库的缓存数据（如果有）</span>
<span class="n">IncrementalMapper</span> <span class="nf">mapper</span><span class="p">(</span><span class="o">&amp;</span><span class="n">database_cache</span><span class="p">);</span>

<span class="c1">// 开始重建</span>
<span class="n">mapper</span><span class="p">.</span><span class="n">BeginReconstruction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reconstruction</span><span class="p">);</span>

<span class="c1">// 参数检测</span>
<span class="n">CHECK</span><span class="p">(</span><span class="n">mapper</span><span class="p">.</span><span class="n">FindInitialImagePair</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">image_id1</span><span class="p">,</span> <span class="n">image_id2</span><span class="p">));</span>
<span class="n">CHECK</span><span class="p">(</span><span class="n">mapper</span><span class="p">.</span><span class="n">RegisterInitialImagePair</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">image_id1</span><span class="p">,</span> <span class="n">image_id2</span><span class="p">));</span>

<span class="c1">// 增量式重建，循环添加新的图片</span>
<span class="k">while</span> <span class="p">(...)</span> <span class="p">{</span>

   <span class="c1">// 找到下一组添加的图片</span>
   <span class="k">const</span> <span class="k">auto</span> <span class="n">next_image_ids</span> <span class="o">=</span> <span class="n">mapper</span><span class="p">.</span><span class="n">FindNextImages</span><span class="p">(</span><span class="n">options</span><span class="p">);</span>

   <span class="c1">// 循环添加</span>
   <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="nl">image_id</span> <span class="p">:</span> <span class="n">next_image_ids</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">CHECK</span><span class="p">(</span><span class="n">mapper</span><span class="p">.</span><span class="n">RegisterNextImage</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">image_id</span><span class="p">));</span>

      <span class="c1">// 局部BA</span>
      <span class="k">if</span> <span class="p">(...)</span> <span class="p">{</span>
         <span class="n">mapper</span><span class="p">.</span><span class="n">AdjustLocalBundle</span><span class="p">(...);</span>
      <span class="p">}</span>

      <span class="c1">// 全局BA</span>
      <span class="k">else</span> <span class="p">{</span>
         <span class="n">mapper</span><span class="p">.</span><span class="n">AdjustGlobalBundle</span><span class="p">(...);</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 结束重建</span>
<span class="n">mapper</span><span class="p">.</span><span class="n">EndReconstruction</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
</pre></div>
</div>
</div>
<dl class="cpp class">
<dt id="_CPPv417IncrementalMapper">
<span id="_CPPv317IncrementalMapper"></span><span id="_CPPv217IncrementalMapper"></span><span id="IncrementalMapper"></span><em class="property">class </em><code class="sig-name descname">IncrementalMapper</code><a class="headerlink" href="#_CPPv417IncrementalMapper" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="section" id="id1">
<h2>配置选项<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<dl class="cpp struct">
<dt id="_CPPv4N17IncrementalMapper7OptionsE">
<span id="_CPPv3N17IncrementalMapper7OptionsE"></span><span id="_CPPv2N17IncrementalMapper7OptionsE"></span><span id="IncrementalMapper::Options"></span><em class="property">struct </em><code class="sig-prename descclassname"><a class="reference internal" href="#_CPPv417IncrementalMapper" title="IncrementalMapper">IncrementalMapper</a><code class="sig-prename descclassname">::</code></code><code class="sig-name descname">Options</code><a class="headerlink" href="#_CPPv4N17IncrementalMapper7OptionsE" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<dl class="cpp member">
<dt id="_CPPv420init_min_num_inliers">
<span id="_CPPv320init_min_num_inliers"></span><span id="_CPPv220init_min_num_inliers"></span><span id="init_min_num_inliers__i"></span>int <code class="sig-name descname">init_min_num_inliers</code> = 100;<a class="headerlink" href="#_CPPv420init_min_num_inliers" title="永久链接至目标">¶</a><br /></dt>
<dd><p>初始图像对的最小inliers数</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv414init_max_error">
<span id="_CPPv314init_max_error"></span><span id="_CPPv214init_max_error"></span><span id="init_max_error__double"></span>double <code class="sig-name descname">init_max_error</code> = 4.0;<a class="headerlink" href="#_CPPv414init_max_error" title="永久链接至目标">¶</a><br /></dt>
<dd><p>初始图像对的两视图几何估计的最大像素误差</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv423init_max_forward_motion">
<span id="_CPPv323init_max_forward_motion"></span><span id="_CPPv223init_max_forward_motion"></span><span id="init_max_forward_motion__double"></span>double <code class="sig-name descname">init_max_forward_motion</code> = 0.95;<a class="headerlink" href="#_CPPv423init_max_forward_motion" title="永久链接至目标">¶</a><br /></dt>
<dd><p>初始图像对的最大前移（Maximum forward motion for initial image pair）</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv418init_min_tri_angle">
<span id="_CPPv318init_min_tri_angle"></span><span id="_CPPv218init_min_tri_angle"></span><span id="init_min_tri_angle__double"></span>double <code class="sig-name descname">init_min_tri_angle</code> = 16.0;<a class="headerlink" href="#_CPPv418init_min_tri_angle" title="永久链接至目标">¶</a><br /></dt>
<dd><p>初始图像对的最小三角剖分角</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv419init_max_reg_trials">
<span id="_CPPv319init_max_reg_trials"></span><span id="_CPPv219init_max_reg_trials"></span><span id="init_max_reg_trials__i"></span>int <code class="sig-name descname">init_max_reg_trials</code> = 2;<a class="headerlink" href="#_CPPv419init_max_reg_trials" title="永久链接至目标">¶</a><br /></dt>
<dd><p>使用图像进行初始化的最大尝试次数</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv418abs_pose_max_error">
<span id="_CPPv318abs_pose_max_error"></span><span id="_CPPv218abs_pose_max_error"></span><span id="abs_pose_max_error__double"></span>double <code class="sig-name descname">abs_pose_max_error</code> = 12.0;<a class="headerlink" href="#_CPPv418abs_pose_max_error" title="永久链接至目标">¶</a><br /></dt>
<dd><p>绝对位姿估计中的最大重投影误差</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv424abs_pose_min_num_inliers">
<span id="_CPPv324abs_pose_min_num_inliers"></span><span id="_CPPv224abs_pose_min_num_inliers"></span><span id="abs_pose_min_num_inliers__i"></span>int <code class="sig-name descname">abs_pose_min_num_inliers</code> = 30;<a class="headerlink" href="#_CPPv424abs_pose_min_num_inliers" title="永久链接至目标">¶</a><br /></dt>
<dd><p>绝对位姿估计中的最小inliers数</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv425abs_pose_min_inlier_ratio">
<span id="_CPPv325abs_pose_min_inlier_ratio"></span><span id="_CPPv225abs_pose_min_inlier_ratio"></span><span id="abs_pose_min_inlier_ratio__double"></span>double <code class="sig-name descname">abs_pose_min_inlier_ratio</code> = 0.25;<a class="headerlink" href="#_CPPv425abs_pose_min_inlier_ratio" title="永久链接至目标">¶</a><br /></dt>
<dd><p>绝对位姿估计中的最小inliers比率</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv428abs_pose_refine_focal_length">
<span id="_CPPv328abs_pose_refine_focal_length"></span><span id="_CPPv228abs_pose_refine_focal_length"></span><span id="abs_pose_refine_focal_length__b"></span>bool <code class="sig-name descname">abs_pose_refine_focal_length</code> = true;<a class="headerlink" href="#_CPPv428abs_pose_refine_focal_length" title="永久链接至目标">¶</a><br /></dt>
<dd><p>是否在绝对位姿估计中估计焦距</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv428abs_pose_refine_extra_params">
<span id="_CPPv328abs_pose_refine_extra_params"></span><span id="_CPPv228abs_pose_refine_extra_params"></span><span id="abs_pose_refine_extra_params__b"></span>bool <code class="sig-name descname">abs_pose_refine_extra_params</code> = true;<a class="headerlink" href="#_CPPv428abs_pose_refine_extra_params" title="永久链接至目标">¶</a><br /></dt>
<dd><p>是否在绝对位姿估计中估计额外参数</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv419local_ba_num_images">
<span id="_CPPv319local_ba_num_images"></span><span id="_CPPv219local_ba_num_images"></span><span id="local_ba_num_images__i"></span>int <code class="sig-name descname">local_ba_num_images</code> = 6;<a class="headerlink" href="#_CPPv419local_ba_num_images" title="永久链接至目标">¶</a><br /></dt>
<dd><p>在局部BA调整中要优化的图像数</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv422local_ba_min_tri_angle">
<span id="_CPPv322local_ba_min_tri_angle"></span><span id="_CPPv222local_ba_min_tri_angle"></span><span id="local_ba_min_tri_angle__double"></span>double <code class="sig-name descname">local_ba_min_tri_angle</code> = 6;<a class="headerlink" href="#_CPPv422local_ba_min_tri_angle" title="永久链接至目标">¶</a><br /></dt>
<dd><p>在局部BA调整中选择图像的最小三角剖分</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv422min_focal_length_ratio">
<span id="_CPPv322min_focal_length_ratio"></span><span id="_CPPv222min_focal_length_ratio"></span><span id="min_focal_length_ratio__double"></span>double <code class="sig-name descname">min_focal_length_ratio</code> = 0.1;<a class="headerlink" href="#_CPPv422min_focal_length_ratio" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<dl class="cpp member">
<dt id="_CPPv422max_focal_length_ratio">
<span id="_CPPv322max_focal_length_ratio"></span><span id="_CPPv222max_focal_length_ratio"></span><span id="max_focal_length_ratio__double"></span>double <code class="sig-name descname">max_focal_length_ratio</code> = 10;<a class="headerlink" href="#_CPPv422max_focal_length_ratio" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<dl class="cpp member">
<dt id="_CPPv415max_extra_param">
<span id="_CPPv315max_extra_param"></span><span id="_CPPv215max_extra_param"></span><span id="max_extra_param__double"></span>double <code class="sig-name descname">max_extra_param</code> = 1;<a class="headerlink" href="#_CPPv415max_extra_param" title="永久链接至目标">¶</a><br /></dt>
<dd><p>伪造相机参数的阈值。 带有伪造相机参数的图像在三角剖分中被过滤并被忽略</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv423filter_max_reproj_error">
<span id="_CPPv323filter_max_reproj_error"></span><span id="_CPPv223filter_max_reproj_error"></span><span id="filter_max_reproj_error__double"></span>double <code class="sig-name descname">filter_max_reproj_error</code> = 4.0;<a class="headerlink" href="#_CPPv423filter_max_reproj_error" title="永久链接至目标">¶</a><br /></dt>
<dd><p>用于观察的最大重投影误差（以像素为单位）</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv420filter_min_tri_angle">
<span id="_CPPv320filter_min_tri_angle"></span><span id="_CPPv220filter_min_tri_angle"></span><span id="filter_min_tri_angle__double"></span>double <code class="sig-name descname">filter_min_tri_angle</code> = 1.5;<a class="headerlink" href="#_CPPv420filter_min_tri_angle" title="永久链接至目标">¶</a><br /></dt>
<dd><p>稳定3D点的最小三角剖分角度（以度为单位）</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv414max_reg_trials">
<span id="_CPPv314max_reg_trials"></span><span id="_CPPv214max_reg_trials"></span><span id="max_reg_trials__i"></span>int <code class="sig-name descname">max_reg_trials</code> = 3;<a class="headerlink" href="#_CPPv414max_reg_trials" title="永久链接至目标">¶</a><br /></dt>
<dd><p>注册图像的最大尝试次数</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv419fix_existing_images">
<span id="_CPPv319fix_existing_images"></span><span id="_CPPv219fix_existing_images"></span><span id="fix_existing_images__b"></span>bool <code class="sig-name descname">fix_existing_images</code> = false;<a class="headerlink" href="#_CPPv419fix_existing_images" title="永久链接至目标">¶</a><br /></dt>
<dd><p>提供重建作为输入，是否修复现存的图像位姿</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv411num_threads">
<span id="_CPPv311num_threads"></span><span id="_CPPv211num_threads"></span><span id="num_threads__i"></span>int <code class="sig-name descname">num_threads</code> = -1;<a class="headerlink" href="#_CPPv411num_threads" title="永久链接至目标">¶</a><br /></dt>
<dd><p>线程数</p>
</dd></dl>

<dl class="cpp enum">
<dt id="_CPPv420ImageSelectionMethod">
<span id="_CPPv320ImageSelectionMethod"></span><span id="_CPPv220ImageSelectionMethod"></span><em class="property">enum </em><code class="sig-name descname">ImageSelectionMethod</code><a class="headerlink" href="#_CPPv420ImageSelectionMethod" title="永久链接至目标">¶</a><br /></dt>
<dd><p>查找并选择下一个最佳图像进行注册的方法</p>
<dl class="field-list simple">
<dt class="field-odd">ImageSelectionMethod</dt>
<dd class="field-odd"><ul class="simple">
<li><p>MAX_VISIBLE_POINTS_NUM</p></li>
<li><p>MAX_VISIBLE_POINTS_RATIO</p></li>
<li><p>MIN_UNCERTAINTY</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="id2">
<h2>结构体<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<dl class="cpp struct">
<dt id="_CPPv427LocalBundleAdjustmentReport">
<span id="_CPPv327LocalBundleAdjustmentReport"></span><span id="_CPPv227LocalBundleAdjustmentReport"></span><span id="LocalBundleAdjustmentReport"></span><em class="property">struct </em><code class="sig-name descname">LocalBundleAdjustmentReport</code><a class="headerlink" href="#_CPPv427LocalBundleAdjustmentReport" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">LocalBundleAdjustmentReport</span> <span class="p">{</span>
   <span class="kt">size_t</span> <span class="n">num_merged_observations</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">size_t</span> <span class="n">num_completed_observations</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">size_t</span> <span class="n">num_filtered_observations</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="kt">size_t</span> <span class="n">num_adjusted_observations</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2>成员变量<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<dl class="cpp member">
<dt id="_CPPv415database_cache_">
<span id="_CPPv315database_cache_"></span><span id="_CPPv215database_cache_"></span><span id="database_cache___DatabaseCacheCP"></span><em class="property">const</em> DatabaseCache *<code class="sig-name descname">database_cache_</code>;<a class="headerlink" href="#_CPPv415database_cache_" title="永久链接至目标">¶</a><br /></dt>
<dd><p>该类将数据库中所有必需的数据保存在内存中</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv415reconstruction_">
<span id="_CPPv315reconstruction_"></span><span id="_CPPv215reconstruction_"></span><span id="reconstruction___colmap::ReconstructionP"></span>colmap::Reconstruction *<code class="sig-name descname">reconstruction_</code>;<a class="headerlink" href="#_CPPv415reconstruction_" title="永久链接至目标">¶</a><br /></dt>
<dd><p>保存重建数据的类</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv413triangulator_">
<span id="_CPPv313triangulator_"></span><span id="_CPPv213triangulator_"></span><span id="triangulator___std::unique_ptr:IncrementalTriangulator:"></span>std::unique_ptr&lt;IncrementalTriangulator&gt; <code class="sig-name descname">triangulator_</code>;<a class="headerlink" href="#_CPPv413triangulator_" title="永久链接至目标">¶</a><br /></dt>
<dd><p>负责增量三角剖分的类</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv421num_total_reg_images_">
<span id="_CPPv321num_total_reg_images_"></span><span id="_CPPv221num_total_reg_images_"></span><span id="num_total_reg_images___s"></span>size_t <code class="sig-name descname">num_total_reg_images_</code>;<a class="headerlink" href="#_CPPv421num_total_reg_images_" title="永久链接至目标">¶</a><br /></dt>
<dd><p>至少在重建时注册的图像数量</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv422num_shared_reg_images_">
<span id="_CPPv322num_shared_reg_images_"></span><span id="_CPPv222num_shared_reg_images_"></span><span id="num_shared_reg_images___s"></span>size_t <code class="sig-name descname">num_shared_reg_images_</code>;<a class="headerlink" href="#_CPPv422num_shared_reg_images_" title="永久链接至目标">¶</a><br /></dt>
<dd><p>当前重建和所有其他先前重建之间共享图像的数量</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv424prev_init_image_pair_id_">
<span id="_CPPv324prev_init_image_pair_id_"></span><span id="_CPPv224prev_init_image_pair_id_"></span><span id="prev_init_image_pair_id___image_pair_t"></span>image_pair_t <code class="sig-name descname">prev_init_image_pair_id_</code>;<a class="headerlink" href="#_CPPv424prev_init_image_pair_id_" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<dl class="cpp member">
<dt id="_CPPv428prev_init_two_view_geometry_">
<span id="_CPPv328prev_init_two_view_geometry_"></span><span id="_CPPv228prev_init_two_view_geometry_"></span><span id="prev_init_two_view_geometry___TwoViewGeometry"></span><a class="reference internal" href="../../../estimator/TwoViewGeometry/TwoViewGeometry.html#_CPPv415TwoViewGeometry" title="TwoViewGeometry">TwoViewGeometry</a> <code class="sig-name descname">prev_init_two_view_geometry_</code>;<a class="headerlink" href="#_CPPv428prev_init_two_view_geometry_" title="永久链接至目标">¶</a><br /></dt>
<dd><p>上一次调用 <code class="docutils literal notranslate"><span class="pre">FindFirstInitialImage</span></code> 的估计两视图几何体，用作以后调用 <code class="docutils literal notranslate"><span class="pre">RegisterInitialImagePair</span></code> 的缓存。</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv420init_num_reg_trials_">
<span id="_CPPv320init_num_reg_trials_"></span><span id="_CPPv220init_num_reg_trials_"></span><span id="init_num_reg_trials___std::unordered_map:image_t.s:"></span>std::unordered_map&lt;image_t, size_t&gt; <code class="sig-name descname">init_num_reg_trials_</code>;<a class="headerlink" href="#_CPPv420init_num_reg_trials_" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<dl class="cpp member">
<dt id="_CPPv417init_image_pairs_">
<span id="_CPPv317init_image_pairs_"></span><span id="_CPPv217init_image_pairs_"></span><span id="init_image_pairs___std::unordered_set:image_pair_t:"></span>std::unordered_set&lt;image_pair_t&gt; <code class="sig-name descname">init_image_pairs_</code>;<a class="headerlink" href="#_CPPv417init_image_pairs_" title="永久链接至目标">¶</a><br /></dt>
<dd><p>已用于初始化的图像和图像对。 每个图像和图像对仅尝试一次进行初始化。</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv426num_reg_images_per_camera_">
<span id="_CPPv326num_reg_images_per_camera_"></span><span id="_CPPv226num_reg_images_per_camera_"></span><span id="num_reg_images_per_camera___std::unordered_map:camera_t.s:"></span>std::unordered_map&lt;camera_t, size_t&gt; <code class="sig-name descname">num_reg_images_per_camera_</code>;<a class="headerlink" href="#_CPPv426num_reg_images_per_camera_" title="永久链接至目标">¶</a><br /></dt>
<dd><p>每个摄像机的已注册图像数。</p>
<p>当多个图像共享内参时，此信息用于避免重复优化摄像机参数以及在局部BA调整中降低已优化摄像机参数的性能。</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv418num_registrations_">
<span id="_CPPv318num_registrations_"></span><span id="_CPPv218num_registrations_"></span><span id="num_registrations___std::unordered_map:image_t.s:"></span>std::unordered_map&lt;image_t, size_t&gt; <code class="sig-name descname">num_registrations_</code>;<a class="headerlink" href="#_CPPv418num_registrations_" title="永久链接至目标">¶</a><br /></dt>
<dd><p>注册图像的重建次数</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv416filtered_images_">
<span id="_CPPv316filtered_images_"></span><span id="_CPPv216filtered_images_"></span><span id="filtered_images___std::unordered_set:image_t:"></span>std::unordered_set&lt;image_t&gt; <code class="sig-name descname">filtered_images_</code>;<a class="headerlink" href="#_CPPv416filtered_images_" title="永久链接至目标">¶</a><br /></dt>
<dd><p>当前重建中已过滤的图像</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv415num_reg_trials_">
<span id="_CPPv315num_reg_trials_"></span><span id="_CPPv215num_reg_trials_"></span><span id="num_reg_trials___std::unordered_map:image_t.s:"></span>std::unordered_map&lt;image_t, size_t&gt; <code class="sig-name descname">num_reg_trials_</code>;<a class="headerlink" href="#_CPPv415num_reg_trials_" title="永久链接至目标">¶</a><br /></dt>
<dd><p>在当前重建中注册图像的试验次数。</p>
<p>用于设置注册图像的尝试次数的上限。</p>
</dd></dl>

<dl class="cpp member">
<dt id="_CPPv419existing_image_ids_">
<span id="_CPPv319existing_image_ids_"></span><span id="_CPPv219existing_image_ids_"></span><span id="existing_image_ids___std::unordered_set:image_t:"></span>std::unordered_set&lt;image_t&gt; <code class="sig-name descname">existing_image_ids_</code>;<a class="headerlink" href="#_CPPv419existing_image_ids_" title="永久链接至目标">¶</a><br /></dt>
<dd><p>开始重建之前已注册的图像。</p>
<p>如果从现有重建继续进行重建，则此图像列表将为非空。</p>
</dd></dl>

</div>
<div class="section" id="id4">
<h2>成员函数<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<div class="section" id="incrementalmapper">
<h3>IncrementalMapper<a class="headerlink" href="#incrementalmapper" title="永久链接至标题">¶</a></h3>
<blockquote>
<div><p>构造函数，创建增量映射器。 数据库缓存必须在增量映射器的整个生命周期中都有效。</p>
</div></blockquote>
<dl class="cpp function">
<dt id="_CPPv4N17IncrementalMapper17IncrementalMapperEPK13DatabaseCache">
<span id="_CPPv3N17IncrementalMapper17IncrementalMapperEPK13DatabaseCache"></span><span id="_CPPv2N17IncrementalMapper17IncrementalMapperEPK13DatabaseCache"></span><span id="IncrementalMapper::IncrementalMapper__DatabaseCacheCP"></span><em class="property">explicit</em> <code class="sig-prename descclassname"><a class="reference internal" href="#_CPPv4N17IncrementalMapper17IncrementalMapperEPK13DatabaseCache" title="IncrementalMapper::IncrementalMapper">IncrementalMapper</a><code class="sig-prename descclassname">::</code></code><code class="sig-name descname">IncrementalMapper</code><span class="sig-paren">(</span><em class="property">const</em> DatabaseCache *<em>database_cache</em><span class="sig-paren">)</span>;<a class="headerlink" href="#_CPPv4N17IncrementalMapper17IncrementalMapperEPK13DatabaseCache" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">IncrementalMapper</span><span class="o">::</span><span class="n">IncrementalMapper</span><span class="p">(</span><span class="k">const</span> <span class="n">DatabaseCache</span><span class="o">*</span> <span class="n">database_cache</span><span class="p">)</span>
 <span class="o">:</span> <span class="n">database_cache_</span><span class="p">(</span><span class="n">database_cache</span><span class="p">),</span>
   <span class="n">reconstruction_</span><span class="p">(</span><span class="k">nullptr</span><span class="p">),</span>
   <span class="n">triangulator_</span><span class="p">(</span><span class="k">nullptr</span><span class="p">),</span>
   <span class="n">num_total_reg_images_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
   <span class="n">num_shared_reg_images_</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
   <span class="n">prev_init_image_pair_id_</span><span class="p">(</span><span class="n">kInvalidImagePairId</span><span class="p">)</span> <span class="p">{}</span>
</pre></div>
</div>
</div>
<div class="section" id="beginreconstruction">
<h3>BeginReconstruction<a class="headerlink" href="#beginreconstruction" title="永久链接至标题">¶</a></h3>
<dl class="cpp function">
<dt id="_CPPv4N17IncrementalMapper19BeginReconstructionEP14Reconstruction">
<span id="_CPPv3N17IncrementalMapper19BeginReconstructionEP14Reconstruction"></span><span id="_CPPv2N17IncrementalMapper19BeginReconstructionEP14Reconstruction"></span><span id="IncrementalMapper::BeginReconstruction__ReconstructionP"></span>void <code class="sig-prename descclassname"><a class="reference internal" href="#_CPPv417IncrementalMapper" title="IncrementalMapper">IncrementalMapper</a><code class="sig-prename descclassname">::</code></code><code class="sig-name descname">BeginReconstruction</code><span class="sig-paren">(</span><a class="reference internal" href="../../../base/Reconstruction/Reconstruction.html#_CPPv414Reconstruction" title="Reconstruction">Reconstruction</a> *<em>reconstruction</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N17IncrementalMapper19BeginReconstructionEP14Reconstruction" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">IncrementalMapper</span><span class="o">::</span><span class="n">BeginReconstruction</span><span class="p">(</span><span class="n">Reconstruction</span><span class="o">*</span> <span class="n">reconstruction</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">CHECK</span><span class="p">(</span><span class="n">reconstruction_</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">);</span>
   <span class="n">reconstruction_</span> <span class="o">=</span> <span class="n">reconstruction</span><span class="p">;</span>

   <span class="c1">// 从数据库中加载缓存</span>
   <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Load</span><span class="p">(</span><span class="o">*</span><span class="n">database_cache_</span><span class="p">);</span>

   <span class="c1">// 开始构建重建</span>
   <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">SetUp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">database_cache_</span><span class="o">-&gt;</span><span class="n">CorrespondenceGraph</span><span class="p">());</span>

   <span class="c1">// 设置三角剖分类</span>
   <span class="n">triangulator_</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">IncrementalTriangulator</span><span class="p">(</span>
      <span class="o">&amp;</span><span class="n">database_cache_</span><span class="o">-&gt;</span><span class="n">CorrespondenceGraph</span><span class="p">(),</span> <span class="n">reconstruction</span><span class="p">));</span>

   <span class="n">num_shared_reg_images_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">num_reg_images_per_camera_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

   <span class="c1">// 注册图像</span>
   <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">image_t</span> <span class="nl">image_id</span> <span class="p">:</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">RegImageIds</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">RegisterImageEvent</span><span class="p">(</span><span class="n">image_id</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">// 设置已经存在于重建中的图像id</span>
   <span class="n">existing_image_ids_</span> <span class="o">=</span>
      <span class="n">std</span><span class="o">::</span><span class="n">unordered_set</span><span class="o">&lt;</span><span class="n">image_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">reconstruction</span><span class="o">-&gt;</span><span class="n">RegImageIds</span><span class="p">().</span><span class="n">begin</span><span class="p">(),</span>
                                  <span class="n">reconstruction</span><span class="o">-&gt;</span><span class="n">RegImageIds</span><span class="p">().</span><span class="n">end</span><span class="p">());</span>

   <span class="c1">// 设置上一次调用indFirstInitialImage的估计两视图几何体的id和两视图几何为空</span>
   <span class="n">prev_init_image_pair_id_</span> <span class="o">=</span> <span class="n">kInvalidImagePairId</span><span class="p">;</span>
   <span class="n">prev_init_two_view_geometry_</span> <span class="o">=</span> <span class="n">TwoViewGeometry</span><span class="p">();</span>

   <span class="n">filtered_images_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
   <span class="n">num_reg_trials_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="endrestruction">
<h3>EndRestruction<a class="headerlink" href="#endrestruction" title="永久链接至标题">¶</a></h3>
<blockquote>
<div><p>当前重建完成后，清理映射器。</p>
<p>如果丢弃该模型，则将相应更新总和共享注册图像的数量。</p>
</div></blockquote>
<dl class="cpp function">
<dt id="_CPPv4N17IncrementalMapper17EndReconstructionEKb">
<span id="_CPPv3N17IncrementalMapper17EndReconstructionEKb"></span><span id="_CPPv2N17IncrementalMapper17EndReconstructionEKb"></span><span id="IncrementalMapper::EndReconstruction__bC"></span>void <code class="sig-prename descclassname"><a class="reference internal" href="#_CPPv417IncrementalMapper" title="IncrementalMapper">IncrementalMapper</a><code class="sig-prename descclassname">::</code></code><code class="sig-name descname">EndReconstruction</code><span class="sig-paren">(</span><em class="property">const</em> bool <em>discard</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N17IncrementalMapper17EndReconstructionEKb" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">IncrementalMapper</span><span class="o">::</span><span class="n">EndReconstruction</span><span class="p">(</span><span class="k">const</span> <span class="kt">bool</span> <span class="n">discard</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">CHECK_NOTNULL</span><span class="p">(</span><span class="n">reconstruction_</span><span class="p">);</span>

   <span class="c1">// 如果丢弃模型</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">discard</span><span class="p">)</span> <span class="p">{</span>

      <span class="c1">// 解注册图像id</span>
      <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">image_t</span> <span class="nl">image_id</span> <span class="p">:</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">RegImageIds</span><span class="p">())</span> <span class="p">{</span>
         <span class="n">DeRegisterImageEvent</span><span class="p">(</span><span class="n">image_id</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="c1">// 清理重建映射器</span>
   <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">TearDown</span><span class="p">();</span>
   <span class="n">reconstruction_</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
   <span class="n">triangulator_</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="findinitialimagepair">
<h3>FindInitialImagePair<a class="headerlink" href="#findinitialimagepair" title="永久链接至标题">¶</a></h3>
<blockquote>
<div><p>查找初始图像对为增量重建提供种子。 图像对应该传递给 <code class="docutils literal notranslate"><span class="pre">RegisterInitialImagePair</span></code> 。</p>
<p>此函数会自动忽略先前无法注册的图像对。</p>
</div></blockquote>
<dl class="cpp function">
<dt id="_CPPv4N17IncrementalMapper20FindInitialImagePairERK7OptionsP7image_tP7image_t">
<span id="_CPPv3N17IncrementalMapper20FindInitialImagePairERK7OptionsP7image_tP7image_t"></span><span id="_CPPv2N17IncrementalMapper20FindInitialImagePairERK7OptionsP7image_tP7image_t"></span><span id="IncrementalMapper::FindInitialImagePair__OptionsCR.image_tP.image_tP"></span>bool <code class="sig-prename descclassname"><a class="reference internal" href="#_CPPv417IncrementalMapper" title="IncrementalMapper">IncrementalMapper</a><code class="sig-prename descclassname">::</code></code><code class="sig-name descname">FindInitialImagePair</code><span class="sig-paren">(</span><em class="property">const</em> <a class="reference internal" href="#_CPPv4N17IncrementalMapper7OptionsE" title="IncrementalMapper::Options">Options</a> &amp;<em>options</em>, image_t *<em>image_id1</em>, image_t *<em>image_id2</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N17IncrementalMapper20FindInitialImagePairERK7OptionsP7image_tP7image_t" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">IncrementalMapper</span><span class="o">::</span><span class="n">FindInitialImagePair</span><span class="p">(</span><span class="k">const</span> <span class="n">Options</span><span class="o">&amp;</span> <span class="n">options</span><span class="p">,</span>
                                             <span class="n">image_t</span><span class="o">*</span> <span class="n">image_id1</span><span class="p">,</span>
                                             <span class="n">image_t</span><span class="o">*</span> <span class="n">image_id2</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">CHECK</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">Check</span><span class="p">());</span>

   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">image_t</span><span class="o">&gt;</span> <span class="n">image_ids1</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">image_id1</span> <span class="o">!=</span> <span class="n">kInvalidImageId</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">image_id2</span> <span class="o">==</span> <span class="n">kInvalidImageId</span><span class="p">)</span> <span class="p">{</span>

     <span class="c1">// 仅提供* image_id1</span>
     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">database_cache_</span><span class="o">-&gt;</span><span class="n">ExistsImage</span><span class="p">(</span><span class="o">*</span><span class="n">image_id1</span><span class="p">))</span> <span class="p">{</span>
       <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
     <span class="p">}</span>
     <span class="n">image_ids1</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">*</span><span class="n">image_id1</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">image_id1</span> <span class="o">==</span> <span class="n">kInvalidImageId</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">image_id2</span> <span class="o">!=</span> <span class="n">kInvalidImageId</span><span class="p">)</span> <span class="p">{</span>
     <span class="c1">// 仅提供* image_id2</span>
     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">database_cache_</span><span class="o">-&gt;</span><span class="n">ExistsImage</span><span class="p">(</span><span class="o">*</span><span class="n">image_id2</span><span class="p">))</span> <span class="p">{</span>
       <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
     <span class="p">}</span>
     <span class="n">image_ids1</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">*</span><span class="n">image_id2</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="k">else</span> <span class="p">{</span>
     <span class="c1">// 没有提供初始种子图像</span>
     <span class="n">image_ids1</span> <span class="o">=</span> <span class="n">FindFirstInitialImage</span><span class="p">(</span><span class="n">options</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">// 尝试找到好的初始对</span>
   <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i1</span> <span class="o">&lt;</span> <span class="n">image_ids1</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i1</span><span class="p">)</span> <span class="p">{</span>
     <span class="o">*</span><span class="n">image_id1</span> <span class="o">=</span> <span class="n">image_ids1</span><span class="p">[</span><span class="n">i1</span><span class="p">];</span>

     <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">image_t</span><span class="o">&gt;</span> <span class="n">image_ids2</span> <span class="o">=</span>
         <span class="n">FindSecondInitialImage</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="o">*</span><span class="n">image_id1</span><span class="p">);</span>

     <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i2</span> <span class="o">&lt;</span> <span class="n">image_ids2</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i2</span><span class="p">)</span> <span class="p">{</span>
       <span class="o">*</span><span class="n">image_id2</span> <span class="o">=</span> <span class="n">image_ids2</span><span class="p">[</span><span class="n">i2</span><span class="p">];</span>

       <span class="k">const</span> <span class="n">image_pair_t</span> <span class="n">pair_id</span> <span class="o">=</span>
           <span class="n">Database</span><span class="o">::</span><span class="n">ImagePairToPairId</span><span class="p">(</span><span class="o">*</span><span class="n">image_id1</span><span class="p">,</span> <span class="o">*</span><span class="n">image_id2</span><span class="p">);</span>

       <span class="c1">// 每对仅尝试一次</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">init_image_pairs_</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">pair_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">continue</span><span class="p">;</span>
       <span class="p">}</span>

       <span class="n">init_image_pairs_</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pair_id</span><span class="p">);</span>

       <span class="k">if</span> <span class="p">(</span><span class="n">EstimateInitialTwoViewGeometry</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="o">*</span><span class="n">image_id1</span><span class="p">,</span> <span class="o">*</span><span class="n">image_id2</span><span class="p">))</span> <span class="p">{</span>
         <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
       <span class="p">}</span>
     <span class="p">}</span>
   <span class="p">}</span>

   <span class="c1">// 在整个数据集中找不到合适的对，返回错误</span>
   <span class="o">*</span><span class="n">image_id1</span> <span class="o">=</span> <span class="n">kInvalidImageId</span><span class="p">;</span>
   <span class="o">*</span><span class="n">image_id2</span> <span class="o">=</span> <span class="n">kInvalidImageId</span><span class="p">;</span>

   <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="findfirstinitialimage">
<h3>FindFirstInitialImage<a class="headerlink" href="#findfirstinitialimage" title="永久链接至标题">¶</a></h3>
<p>查找用于增量重建的种子图像。 合适的种子图像具有大量对应关系，并且具有相机校准先验。 返回列表的排序应使最合适的图像位于最前面。</p>
<dl class="cpp function">
<dt id="_CPPv4NK17IncrementalMapper21FindFirstInitialImageERK7Options">
<span id="_CPPv3NK17IncrementalMapper21FindFirstInitialImageERK7Options"></span><span id="_CPPv2NK17IncrementalMapper21FindFirstInitialImageERK7Options"></span><span id="IncrementalMapper::FindFirstInitialImage__OptionsCRC"></span>std::vector&lt;image_t&gt; <code class="sig-prename descclassname"><a class="reference internal" href="#_CPPv417IncrementalMapper" title="IncrementalMapper">IncrementalMapper</a><code class="sig-prename descclassname">::</code></code><code class="sig-name descname">FindFirstInitialImage</code><span class="sig-paren">(</span><em class="property">const</em> <a class="reference internal" href="#_CPPv4N17IncrementalMapper7OptionsE" title="IncrementalMapper::Options">Options</a> &amp;<em>options</em><span class="sig-paren">)</span> <em class="property">const</em>;<a class="headerlink" href="#_CPPv4NK17IncrementalMapper21FindFirstInitialImageERK7Options" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">image_t</span><span class="o">&gt;</span> <span class="n">IncrementalMapper</span><span class="o">::</span><span class="n">FindFirstInitialImage</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">Options</span><span class="o">&amp;</span> <span class="n">options</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>

  <span class="c1">// 保留元数据（meta-data）以对图像进行排名的结构</span>
  <span class="k">struct</span> <span class="n">ImageInfo</span> <span class="p">{</span>
    <span class="n">image_t</span> <span class="n">image_id</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">prior_focal_length</span><span class="p">;</span>
    <span class="n">image_t</span> <span class="n">num_correspondences</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">init_max_reg_trials</span> <span class="o">=</span>
      <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">init_max_reg_trials</span><span class="p">);</span>

  <span class="c1">// 收集所有尚未注册的图像的对应信息</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ImageInfo</span><span class="o">&gt;</span> <span class="n">image_infos</span><span class="p">;</span>
  <span class="n">image_infos</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">NumImages</span><span class="p">());</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">image</span> <span class="p">:</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Images</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// 只能注册具有对应关系的图像</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">NumCorrespondences</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 图像初始化的次数不能超过规定次数</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">init_num_reg_trials_</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">first</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="n">init_num_reg_trials_</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">first</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">init_max_reg_trials</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 仅使用未在任何其他重构中注册的图像进行初始化</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">num_registrations_</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">first</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
        <span class="n">num_registrations_</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">first</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">const</span> <span class="k">class</span> <span class="nc">Camera</span><span class="o">&amp;</span> <span class="n">camera</span> <span class="o">=</span>
        <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Camera</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">CameraId</span><span class="p">());</span>
    <span class="n">ImageInfo</span> <span class="n">image_info</span><span class="p">;</span>
    <span class="n">image_info</span><span class="p">.</span><span class="n">image_id</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
    <span class="n">image_info</span><span class="p">.</span><span class="n">prior_focal_length</span> <span class="o">=</span> <span class="n">camera</span><span class="p">.</span><span class="n">HasPriorFocalLength</span><span class="p">();</span>
    <span class="n">image_info</span><span class="p">.</span><span class="n">num_correspondences</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">NumCorrespondences</span><span class="p">();</span>
    <span class="n">image_infos</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">image_info</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// 对图像进行排序，使具有优先焦距和更多对应关系的图像成为首选，即它们出现在列表的前面</span>
  <span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span>
      <span class="n">image_infos</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">image_infos</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
      <span class="p">[](</span><span class="k">const</span> <span class="n">ImageInfo</span><span class="o">&amp;</span> <span class="n">image_info1</span><span class="p">,</span> <span class="k">const</span> <span class="n">ImageInfo</span><span class="o">&amp;</span> <span class="n">image_info2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">image_info1</span><span class="p">.</span><span class="n">prior_focal_length</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">image_info2</span><span class="p">.</span><span class="n">prior_focal_length</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">image_info1</span><span class="p">.</span><span class="n">prior_focal_length</span> <span class="o">&amp;&amp;</span>
                   <span class="n">image_info2</span><span class="p">.</span><span class="n">prior_focal_length</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="n">image_info1</span><span class="p">.</span><span class="n">num_correspondences</span> <span class="o">&gt;</span>
                 <span class="n">image_info2</span><span class="p">.</span><span class="n">num_correspondences</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">});</span>

  <span class="c1">// 按排序顺序提取图像标识符</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">image_t</span><span class="o">&gt;</span> <span class="n">image_ids</span><span class="p">;</span>
  <span class="n">image_ids</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">image_infos</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">ImageInfo</span><span class="o">&amp;</span> <span class="nl">image_info</span> <span class="p">:</span> <span class="n">image_infos</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">image_ids</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">image_info</span><span class="p">.</span><span class="n">image_id</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">image_ids</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<ol class="arabic">
<li><p>定义一个结构体用于存储图像的id、是否具有先验焦距、对应关系数</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">ImageInfo</span> <span class="p">{</span>
   <span class="n">image_t</span> <span class="n">image_id</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">prior_focal_length</span><span class="p">;</span>
   <span class="n">image_t</span> <span class="n">num_correspondences</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</li>
<li><p>定义尝试注册的最大次数</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="kt">size_t</span> <span class="n">init_max_reg_trials</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">init_max_reg_trials</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>遍历重建中的每张图像，将符合要求的图片加入到 <code class="docutils literal notranslate"><span class="pre">image_infos</span></code> 中</p>
<dl class="field-list">
<dt class="field-odd">要求</dt>
<dd class="field-odd"><p><strong>1. 对应关系</strong> ✔️</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">NumCorrespondences</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</pre></div>
</div>
<p><strong>2. 尝试次数少于阈值</strong> ✔️</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">init_num_reg_trials_</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">first</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
    <span class="n">init_num_reg_trials_</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">first</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">init_max_reg_trials</span><span class="p">)</span>

<span class="k">continue</span><span class="p">;</span>
</pre></div>
</div>
<p><strong>3. 未在其他重构中注册</strong> ✔️</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">num_registrations_</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">first</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
    <span class="n">num_registrations_</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">first</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">continue</span><span class="p">;</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><p>对 <code class="docutils literal notranslate"><span class="pre">image_infos</span></code> 中的图片进行排序，使具有优先焦距和更多对应关系的图像成为出现在列表的前面</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span>
   <span class="n">image_infos</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">image_infos</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
   <span class="p">[](</span><span class="k">const</span> <span class="n">ImageInfo</span><span class="o">&amp;</span> <span class="n">image_info1</span><span class="p">,</span> <span class="k">const</span> <span class="n">ImageInfo</span><span class="o">&amp;</span> <span class="n">image_info2</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">image_info1</span><span class="p">.</span><span class="n">prior_focal_length</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">image_info2</span><span class="p">.</span><span class="n">prior_focal_length</span><span class="p">)</span>
         <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

      <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">image_info1</span><span class="p">.</span><span class="n">prior_focal_length</span> <span class="o">&amp;&amp;</span> <span class="n">image_info2</span><span class="p">.</span><span class="n">prior_focal_length</span><span class="p">)</span>
         <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

      <span class="k">else</span>
         <span class="k">return</span> <span class="n">image_info1</span><span class="p">.</span><span class="n">num_correspondences</span> <span class="o">&gt;</span> <span class="n">image_info2</span><span class="p">.</span><span class="n">num_correspondences</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
</li>
<li><p>按排序顺序提取图像标识符（id）</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">ImageInfo</span><span class="o">&amp;</span> <span class="nl">image_info</span> <span class="p">:</span> <span class="n">image_infos</span><span class="p">)</span>
   <span class="n">image_ids</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">image_info</span><span class="p">.</span><span class="n">image_id</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="findsecondinitialimage">
<h3>FindSecondInitialImage<a class="headerlink" href="#findsecondinitialimage" title="永久链接至标题">¶</a></h3>
<dl class="cpp function">
<dt id="_CPPv4NK17IncrementalMapper22FindSecondInitialImageERK7OptionsK7image_t">
<span id="_CPPv3NK17IncrementalMapper22FindSecondInitialImageERK7OptionsK7image_t"></span><span id="_CPPv2NK17IncrementalMapper22FindSecondInitialImageERK7OptionsK7image_t"></span><span id="IncrementalMapper::FindSecondInitialImage__OptionsCR.image_tCC"></span>std::vector&lt;image_t&gt; <code class="sig-prename descclassname"><a class="reference internal" href="#_CPPv417IncrementalMapper" title="IncrementalMapper">IncrementalMapper</a><code class="sig-prename descclassname">::</code></code><code class="sig-name descname">FindSecondInitialImage</code><span class="sig-paren">(</span><em class="property">const</em> <a class="reference internal" href="#_CPPv4N17IncrementalMapper7OptionsE" title="IncrementalMapper::Options">Options</a> &amp;<em>options</em>, <em class="property">const</em> image_t <em>image_id1</em><span class="sig-paren">)</span> <em class="property">const</em>;<a class="headerlink" href="#_CPPv4NK17IncrementalMapper22FindSecondInitialImageERK7OptionsK7image_t" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">image_t</span><span class="o">&gt;</span> <span class="n">IncrementalMapper</span><span class="o">::</span><span class="n">FindSecondInitialImage</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">Options</span><span class="o">&amp;</span> <span class="n">options</span><span class="p">,</span> <span class="k">const</span> <span class="n">image_t</span> <span class="n">image_id1</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">const</span> <span class="n">CorrespondenceGraph</span><span class="o">&amp;</span> <span class="n">correspondence_graph</span> <span class="o">=</span>
      <span class="n">database_cache_</span><span class="o">-&gt;</span><span class="n">CorrespondenceGraph</span><span class="p">();</span>

  <span class="c1">// 收集连接到第一个种子图像且之前未在其他重建中注册的图像</span>
  <span class="k">const</span> <span class="k">class</span> <span class="nc">Image</span><span class="o">&amp;</span> <span class="n">image1</span> <span class="o">=</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Image</span><span class="p">(</span><span class="n">image_id1</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">image_t</span><span class="p">,</span> <span class="n">point2D_t</span><span class="o">&gt;</span> <span class="n">num_correspondences</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">point2D_t</span> <span class="n">point2D_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">point2D_idx</span> <span class="o">&lt;</span> <span class="n">image1</span><span class="p">.</span><span class="n">NumPoints2D</span><span class="p">();</span>
       <span class="o">++</span><span class="n">point2D_idx</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">corr</span> <span class="p">:</span>
         <span class="n">correspondence_graph</span><span class="p">.</span><span class="n">FindCorrespondences</span><span class="p">(</span><span class="n">image_id1</span><span class="p">,</span> <span class="n">point2D_idx</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">num_registrations_</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">corr</span><span class="p">.</span><span class="n">image_id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
          <span class="n">num_registrations_</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">corr</span><span class="p">.</span><span class="n">image_id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">num_correspondences</span><span class="p">[</span><span class="n">corr</span><span class="p">.</span><span class="n">image_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// 保留元数据（meta-data）以对图像进行排名的结构</span>
  <span class="k">struct</span> <span class="n">ImageInfo</span> <span class="p">{</span>
    <span class="n">image_t</span> <span class="n">image_id</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">prior_focal_length</span><span class="p">;</span>
    <span class="n">point2D_t</span> <span class="n">num_correspondences</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">const</span> <span class="kt">size_t</span> <span class="n">init_min_num_inliers</span> <span class="o">=</span>
      <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">init_min_num_inliers</span><span class="p">);</span>

  <span class="c1">// 以紧凑的形式组合图像信息以进行分类</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ImageInfo</span><span class="o">&gt;</span> <span class="n">image_infos</span><span class="p">;</span>
  <span class="n">image_infos</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">NumImages</span><span class="p">());</span>

  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="nl">elem</span> <span class="p">:</span> <span class="n">num_correspondences</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 如果点的数量大于最小内点数</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">elem</span><span class="p">.</span><span class="n">second</span> <span class="o">&gt;=</span> <span class="n">init_min_num_inliers</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">const</span> <span class="k">class</span> <span class="nc">Image</span><span class="o">&amp;</span> <span class="n">image</span> <span class="o">=</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Image</span><span class="p">(</span><span class="n">elem</span><span class="p">.</span><span class="n">first</span><span class="p">);</span>
      <span class="k">const</span> <span class="k">class</span> <span class="nc">Camera</span><span class="o">&amp;</span> <span class="n">camera</span> <span class="o">=</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Camera</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">CameraId</span><span class="p">());</span>
      <span class="n">ImageInfo</span> <span class="n">image_info</span><span class="p">;</span>
      <span class="n">image_info</span><span class="p">.</span><span class="n">image_id</span> <span class="o">=</span> <span class="n">elem</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
      <span class="n">image_info</span><span class="p">.</span><span class="n">prior_focal_length</span> <span class="o">=</span> <span class="n">camera</span><span class="p">.</span><span class="n">HasPriorFocalLength</span><span class="p">();</span>
      <span class="n">image_info</span><span class="p">.</span><span class="n">num_correspondences</span> <span class="o">=</span> <span class="n">elem</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
      <span class="n">image_infos</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">image_info</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// 对图像进行排序，使具有优先焦距和更多对应关系的图像成为首选，即它们出现在列表的前面</span>
  <span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span>
      <span class="n">image_infos</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">image_infos</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
      <span class="p">[](</span><span class="k">const</span> <span class="n">ImageInfo</span><span class="o">&amp;</span> <span class="n">image_info1</span><span class="p">,</span> <span class="k">const</span> <span class="n">ImageInfo</span><span class="o">&amp;</span> <span class="n">image_info2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">image_info1</span><span class="p">.</span><span class="n">prior_focal_length</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">image_info2</span><span class="p">.</span><span class="n">prior_focal_length</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">image_info1</span><span class="p">.</span><span class="n">prior_focal_length</span> <span class="o">&amp;&amp;</span>
                   <span class="n">image_info2</span><span class="p">.</span><span class="n">prior_focal_length</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="n">image_info1</span><span class="p">.</span><span class="n">num_correspondences</span> <span class="o">&gt;</span>
                 <span class="n">image_info2</span><span class="p">.</span><span class="n">num_correspondences</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">});</span>

  <span class="c1">// 按排序顺序提取图像标识符</span>
  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">image_t</span><span class="o">&gt;</span> <span class="n">image_ids</span><span class="p">;</span>
  <span class="n">image_ids</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">image_infos</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">ImageInfo</span><span class="o">&amp;</span> <span class="nl">image_info</span> <span class="p">:</span> <span class="n">image_infos</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">image_ids</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">image_info</span><span class="p">.</span><span class="n">image_id</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">image_ids</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<ol class="arabic">
<li><p>定义一个结构体用于存储图像的id、是否具有先验焦距、对应关系数</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">ImageInfo</span> <span class="p">{</span>
   <span class="n">image_t</span> <span class="n">image_id</span><span class="p">;</span>
   <span class="kt">bool</span> <span class="n">prior_focal_length</span><span class="p">;</span>
   <span class="n">image_t</span> <span class="n">num_correspondences</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
</li>
<li><p>得到内存缓存中的关系图</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="n">CorrespondenceGraph</span><span class="o">&amp;</span> <span class="n">correspondence_graph</span> <span class="o">=</span> <span class="n">database_cache_</span><span class="o">-&gt;</span><span class="n">CorrespondenceGraph</span><span class="p">();</span>
</pre></div>
</div>
</li>
<li><p>遍历图1中的每一个特征点，每个特征点都对应许多的图，如果对应的图没有被注册到其他重建中，则将图的id作为 <code class="docutils literal notranslate"><span class="pre">num_correspondences</span></code> 的下标+1，记录该图与图1的关联性</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="k">class</span> <span class="nc">Image</span><span class="o">&amp;</span> <span class="n">image1</span> <span class="o">=</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Image</span><span class="p">(</span><span class="n">image_id1</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">image_t</span><span class="p">,</span> <span class="n">point2D_t</span><span class="o">&gt;</span> <span class="n">num_correspondences</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="n">point2D_t</span> <span class="n">point2D_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">point2D_idx</span> <span class="o">&lt;</span> <span class="n">image1</span><span class="p">.</span><span class="n">NumPoints2D</span><span class="p">();</span>
    <span class="o">++</span><span class="n">point2D_idx</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">corr</span> <span class="p">:</span>
      <span class="n">correspondence_graph</span><span class="p">.</span><span class="n">FindCorrespondences</span><span class="p">(</span><span class="n">image_id1</span><span class="p">,</span> <span class="n">point2D_idx</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">num_registrations_</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">corr</span><span class="p">.</span><span class="n">image_id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
       <span class="n">num_registrations_</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">corr</span><span class="p">.</span><span class="n">image_id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">num_correspondences</span><span class="p">[</span><span class="n">corr</span><span class="p">.</span><span class="n">image_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>遍历与图1有关联的所有的图，如果图的特征点数量大于内点阈值，则将其加入到 <code class="docutils literal notranslate"><span class="pre">image_infos</span></code> 中</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ImageInfo</span><span class="o">&gt;</span> <span class="n">image_infos</span><span class="p">;</span>
<span class="n">image_infos</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">NumImages</span><span class="p">());</span>
<span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="nl">elem</span> <span class="p">:</span> <span class="n">num_correspondences</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">elem</span><span class="p">.</span><span class="n">second</span> <span class="o">&gt;=</span> <span class="n">init_min_num_inliers</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">const</span> <span class="k">class</span> <span class="nc">Image</span><span class="o">&amp;</span> <span class="n">image</span> <span class="o">=</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Image</span><span class="p">(</span><span class="n">elem</span><span class="p">.</span><span class="n">first</span><span class="p">);</span>
      <span class="k">const</span> <span class="k">class</span> <span class="nc">Camera</span><span class="o">&amp;</span> <span class="n">camera</span> <span class="o">=</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Camera</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">CameraId</span><span class="p">());</span>
      <span class="n">ImageInfo</span> <span class="n">image_info</span><span class="p">;</span>
      <span class="n">image_info</span><span class="p">.</span><span class="n">image_id</span> <span class="o">=</span> <span class="n">elem</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
      <span class="n">image_info</span><span class="p">.</span><span class="n">prior_focal_length</span> <span class="o">=</span> <span class="n">camera</span><span class="p">.</span><span class="n">HasPriorFocalLength</span><span class="p">();</span>
      <span class="n">image_info</span><span class="p">.</span><span class="n">num_correspondences</span> <span class="o">=</span> <span class="n">elem</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
      <span class="n">image_infos</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">image_info</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>对 <code class="docutils literal notranslate"><span class="pre">image_infos</span></code> 中的图片进行排序，使具有优先焦距和更多对应关系的图像成为出现在列表的前面</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span>
   <span class="n">image_infos</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">image_infos</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
   <span class="p">[](</span><span class="k">const</span> <span class="n">ImageInfo</span><span class="o">&amp;</span> <span class="n">image_info1</span><span class="p">,</span> <span class="k">const</span> <span class="n">ImageInfo</span><span class="o">&amp;</span> <span class="n">image_info2</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">image_info1</span><span class="p">.</span><span class="n">prior_focal_length</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">image_info2</span><span class="p">.</span><span class="n">prior_focal_length</span><span class="p">)</span>
         <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

      <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="o">!</span><span class="n">image_info1</span><span class="p">.</span><span class="n">prior_focal_length</span> <span class="o">&amp;&amp;</span> <span class="n">image_info2</span><span class="p">.</span><span class="n">prior_focal_length</span><span class="p">)</span>
         <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
      <span class="k">else</span>
       <span class="k">return</span> <span class="n">image_info1</span><span class="p">.</span><span class="n">num_correspondences</span> <span class="o">&gt;</span> <span class="n">image_info2</span><span class="p">.</span><span class="n">num_correspondences</span><span class="p">;</span>
   <span class="p">});</span>
</pre></div>
</div>
</li>
<li><p>按排序顺序提取图像标识符（id）</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">ImageInfo</span><span class="o">&amp;</span> <span class="nl">image_info</span> <span class="p">:</span> <span class="n">image_infos</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">image_ids</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">image_info</span><span class="p">.</span><span class="n">image_id</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="findnextimages">
<h3>FindNextImages<a class="headerlink" href="#findnextimages" title="永久链接至标题">¶</a></h3>
<p>查找最佳的下一组图像以注册到增量重建。</p>
<p>图像应传递到 <code class="docutils literal notranslate"><span class="pre">RegisterNextImag</span></code>。 此函数会自动忽略未注册 <code class="docutils literal notranslate"><span class="pre">max_reg_trial</span></code> 的图像。</p>
<dl class="cpp function">
<dt id="_CPPv4N17IncrementalMapper14FindNextImagesERK7Options">
<span id="_CPPv3N17IncrementalMapper14FindNextImagesERK7Options"></span><span id="_CPPv2N17IncrementalMapper14FindNextImagesERK7Options"></span><span id="IncrementalMapper::FindNextImages__OptionsCR"></span>std::vector&lt;image_t&gt; <code class="sig-prename descclassname"><a class="reference internal" href="#_CPPv417IncrementalMapper" title="IncrementalMapper">IncrementalMapper</a><code class="sig-prename descclassname">::</code></code><code class="sig-name descname">FindNextImages</code><span class="sig-paren">(</span><em class="property">const</em> <a class="reference internal" href="#_CPPv4N17IncrementalMapper7OptionsE" title="IncrementalMapper::Options">Options</a> &amp;<em>options</em><span class="sig-paren">)</span>;<a class="headerlink" href="#_CPPv4N17IncrementalMapper14FindNextImagesERK7Options" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">image_t</span><span class="o">&gt;</span> <span class="n">IncrementalMapper</span><span class="o">::</span><span class="n">FindNextImages</span><span class="p">(</span><span class="k">const</span> <span class="n">Options</span><span class="o">&amp;</span> <span class="n">options</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">CHECK_NOTNULL</span><span class="p">(</span><span class="n">reconstruction_</span><span class="p">);</span>
   <span class="n">CHECK</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">Check</span><span class="p">());</span>


   <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">(</span><span class="k">const</span> <span class="n">Image</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">rank_image_func</span><span class="p">;</span>

   <span class="c1">// 根据method决定选择下一张图像的函数</span>
   <span class="k">switch</span> <span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">image_selection_method</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">case</span> <span class="n">Options</span><span class="o">::</span><span class="n">ImageSelectionMethod</span><span class="o">::</span><span class="nl">MAX_VISIBLE_POINTS_NUM</span><span class="p">:</span>
       <span class="n">rank_image_func</span> <span class="o">=</span> <span class="n">RankNextImageMaxVisiblePointsNum</span><span class="p">;</span>
       <span class="k">break</span><span class="p">;</span>
     <span class="k">case</span> <span class="n">Options</span><span class="o">::</span><span class="n">ImageSelectionMethod</span><span class="o">::</span><span class="nl">MAX_VISIBLE_POINTS_RATIO</span><span class="p">:</span>
       <span class="n">rank_image_func</span> <span class="o">=</span> <span class="n">RankNextImageMaxVisiblePointsRatio</span><span class="p">;</span>
       <span class="k">break</span><span class="p">;</span>
     <span class="k">case</span> <span class="n">Options</span><span class="o">::</span><span class="n">ImageSelectionMethod</span><span class="o">::</span><span class="nl">MIN_UNCERTAINTY</span><span class="p">:</span>
       <span class="n">rank_image_func</span> <span class="o">=</span> <span class="n">RankNextImageMinUncertainty</span><span class="p">;</span>
       <span class="k">break</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">image_t</span><span class="p">,</span> <span class="kt">float</span><span class="o">&gt;&gt;</span> <span class="n">image_ranks</span><span class="p">;</span>
   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">image_t</span><span class="p">,</span> <span class="kt">float</span><span class="o">&gt;&gt;</span> <span class="n">other_image_ranks</span><span class="p">;</span>

   <span class="c1">// 附加之前没有失败注册的图像</span>
   <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">image</span> <span class="p">:</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Images</span><span class="p">())</span> <span class="p">{</span>
     <span class="c1">// 跳过已注册的图像</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">IsRegistered</span><span class="p">())</span> <span class="p">{</span>
       <span class="k">continue</span><span class="p">;</span>
     <span class="p">}</span>

     <span class="c1">// 仅考虑具有足够数量的可见点的图像</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">NumVisiblePoints3D</span><span class="p">()</span> <span class="o">&lt;</span>
         <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">abs_pose_min_num_inliers</span><span class="p">))</span> <span class="p">{</span>
       <span class="k">continue</span><span class="p">;</span>
     <span class="p">}</span>

     <span class="c1">// 只尝试注册最大次数</span>
     <span class="k">const</span> <span class="kt">size_t</span> <span class="n">num_reg_trials</span> <span class="o">=</span> <span class="n">num_reg_trials_</span><span class="p">[</span><span class="n">image</span><span class="p">.</span><span class="n">first</span><span class="p">];</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">num_reg_trials</span> <span class="o">&gt;=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">max_reg_trials</span><span class="p">))</span> <span class="p">{</span>
       <span class="k">continue</span><span class="p">;</span>
     <span class="p">}</span>

     <span class="c1">// 如果图像已被过滤或注册失败，将其放置在第二个存储桶中，并优先使用之前未尝试过的图像。</span>
     <span class="k">const</span> <span class="kt">float</span> <span class="n">rank</span> <span class="o">=</span> <span class="n">rank_image_func</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">filtered_images_</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">first</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">num_reg_trials</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">image_ranks</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">first</span><span class="p">,</span> <span class="n">rank</span><span class="p">);</span>
     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
       <span class="n">other_image_ranks</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">first</span><span class="p">,</span> <span class="n">rank</span><span class="p">);</span>
     <span class="p">}</span>
   <span class="p">}</span>

   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">image_t</span><span class="o">&gt;</span> <span class="n">ranked_images_ids</span><span class="p">;</span>
   <span class="n">SortAndAppendNextImages</span><span class="p">(</span><span class="n">image_ranks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ranked_images_ids</span><span class="p">);</span>
   <span class="n">SortAndAppendNextImages</span><span class="p">(</span><span class="n">other_image_ranks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ranked_images_ids</span><span class="p">);</span>

   <span class="k">return</span> <span class="n">ranked_images_ids</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<ol class="arabic">
<li><p>注意 <code class="docutils literal notranslate"><span class="pre">std::function&lt;float(const</span> <span class="pre">Image&amp;)&gt;</span> <span class="pre">rank_image_func</span></code> 实际上类似一个指针函数，代码中设置了三种不同的方法：</p>
<blockquote>
<div><p>1） 根据可见点数量</p>
<blockquote>
<div><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">float</span> <span class="nf">RankNextImageMaxVisiblePointsNum</span><span class="p">(</span><span class="k">const</span> <span class="n">Image</span><span class="o">&amp;</span> <span class="n">image</span><span class="p">)</span>
   <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">NumVisiblePoints3D</span><span class="p">());</span>
</pre></div>
</div>
</div></blockquote>
<p>2） 根据可见点的比率</p>
<blockquote>
<div><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">float</span> <span class="nf">RankNextImageMaxVisiblePointsRatio</span><span class="p">(</span><span class="k">const</span> <span class="n">Image</span><span class="o">&amp;</span> <span class="n">image</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">NumVisiblePoints3D</span><span class="p">())</span> <span class="o">/</span>
         <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">NumObservations</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>3） 根据得分金字塔</p>
<blockquote>
<div><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">float</span> <span class="nf">RankNextImageMinUncertainty</span><span class="p">(</span><span class="k">const</span> <span class="n">Image</span><span class="o">&amp;</span> <span class="n">image</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">Point3DVisibilityScore</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">SortAndAppendNextImages</span></code> 是根据上一步图像的得分对图像进行排序，并加入新的图像进去。</p></li>
</ol>
<blockquote>
<div><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">SortAndAppendNextImages</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">image_t</span><span class="p">,</span> <span class="kt">float</span><span class="o">&gt;&gt;</span> <span class="n">image_ranks</span><span class="p">,</span>
              <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">image_t</span><span class="o">&gt;*</span> <span class="n">sorted_images_ids</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="n">image_ranks</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">image_ranks</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
            <span class="p">[](</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">image_t</span><span class="p">,</span> <span class="kt">float</span><span class="o">&gt;&amp;</span> <span class="n">image1</span><span class="p">,</span>
               <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">image_t</span><span class="p">,</span> <span class="kt">float</span><span class="o">&gt;&amp;</span> <span class="n">image2</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="n">image1</span><span class="p">.</span><span class="n">second</span> <span class="o">&gt;</span> <span class="n">image2</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
            <span class="p">});</span>

   <span class="n">sorted_images_ids</span><span class="o">-&gt;</span><span class="n">reserve</span><span class="p">(</span><span class="n">sorted_images_ids</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="n">image_ranks</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
   <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">image</span> <span class="p">:</span> <span class="n">image_ranks</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">sorted_images_ids</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">first</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="n">image_ranks</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="findlocalbundle">
<h3>FindLocalBundle<a class="headerlink" href="#findlocalbundle" title="永久链接至标题">¶</a></h3>
<p>在重建中找到给定图像的局部bundle。</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>局部bundle定义为与给定图像的连接最多的图像，即最大共享3D点的数量。</p>
</div>
<dl class="cpp function">
<dt id="_CPPv4NK17IncrementalMapper15FindLocalBundleERK7OptionsK7image_t">
<span id="_CPPv3NK17IncrementalMapper15FindLocalBundleERK7OptionsK7image_t"></span><span id="_CPPv2NK17IncrementalMapper15FindLocalBundleERK7OptionsK7image_t"></span><span id="IncrementalMapper::FindLocalBundle__OptionsCR.image_tCC"></span>std::vector&lt;image_t&gt; <code class="sig-prename descclassname"><a class="reference internal" href="#_CPPv417IncrementalMapper" title="IncrementalMapper">IncrementalMapper</a><code class="sig-prename descclassname">::</code></code><code class="sig-name descname">FindLocalBundle</code><span class="sig-paren">(</span><em class="property">const</em> <a class="reference internal" href="#_CPPv4N17IncrementalMapper7OptionsE" title="IncrementalMapper::Options">Options</a> &amp;<em>options</em>, <em class="property">const</em> image_t <em>image_id</em><span class="sig-paren">)</span> <em class="property">const</em><a class="headerlink" href="#_CPPv4NK17IncrementalMapper15FindLocalBundleERK7OptionsK7image_t" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">image_t</span><span class="o">&gt;</span> <span class="n">IncrementalMapper</span><span class="o">::</span><span class="n">FindLocalBundle</span><span class="p">(</span>
      <span class="k">const</span> <span class="n">Options</span><span class="o">&amp;</span> <span class="n">options</span><span class="p">,</span> <span class="k">const</span> <span class="n">image_t</span> <span class="n">image_id</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
   <span class="n">CHECK</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">Check</span><span class="p">());</span>

   <span class="k">const</span> <span class="n">Image</span><span class="o">&amp;</span> <span class="n">image</span> <span class="o">=</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Image</span><span class="p">(</span><span class="n">image_id</span><span class="p">);</span>
   <span class="n">CHECK</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">IsRegistered</span><span class="p">());</span>

   <span class="c1">// 提取与查询的图片至少有一个共同的3D点的所有图片，同时计算公共3D点的数量</span>

   <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">image_t</span><span class="p">,</span> <span class="kt">size_t</span><span class="o">&gt;</span> <span class="n">shared_observations</span><span class="p">;</span>

   <span class="n">std</span><span class="o">::</span><span class="n">unordered_set</span><span class="o">&lt;</span><span class="n">point3D_t</span><span class="o">&gt;</span> <span class="n">point3D_ids</span><span class="p">;</span>
   <span class="n">point3D_ids</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">NumPoints3D</span><span class="p">());</span>

   <span class="c1">// 遍历图像中每一个2D特征点</span>
   <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">Point2D</span><span class="o">&amp;</span> <span class="nl">point2D</span> <span class="p">:</span> <span class="n">image</span><span class="p">.</span><span class="n">Points2D</span><span class="p">())</span> <span class="p">{</span>
      <span class="c1">// 如果2D点有对应的3D点</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">point2D</span><span class="p">.</span><span class="n">HasPoint3D</span><span class="p">())</span> <span class="p">{</span>
         <span class="c1">// 插入该3D点的id</span>
         <span class="n">point3D_ids</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">point2D</span><span class="p">.</span><span class="n">Point3DId</span><span class="p">());</span>
         <span class="c1">// 从重建中根据该id得到对应的3D点</span>
         <span class="k">const</span> <span class="n">Point3D</span><span class="o">&amp;</span> <span class="n">point3D</span> <span class="o">=</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Point3D</span><span class="p">(</span><span class="n">point2D</span><span class="p">.</span><span class="n">Point3DId</span><span class="p">());</span>
         <span class="c1">// 遍历该3D点的轨道的所有元素</span>
         <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">TrackElement</span><span class="o">&amp;</span> <span class="nl">track_el</span> <span class="p">:</span> <span class="n">point3D</span><span class="p">.</span><span class="n">Track</span><span class="p">().</span><span class="n">Elements</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">// 如果轨道的图像与观测图像不是一个图像，则将其加入到共享观测序列中</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">track_el</span><span class="p">.</span><span class="n">image_id</span> <span class="o">!=</span> <span class="n">image_id</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">shared_observations</span><span class="p">[</span><span class="n">track_el</span><span class="p">.</span><span class="n">image_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="c1">// 根据共享观测的数量对重叠的图像进行排序</span>
   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">image_t</span><span class="p">,</span> <span class="kt">size_t</span><span class="o">&gt;&gt;</span> <span class="n">overlapping_images</span><span class="p">(</span>
      <span class="n">shared_observations</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">shared_observations</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
   <span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="n">overlapping_images</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">overlapping_images</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
            <span class="p">[](</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">image_t</span><span class="p">,</span> <span class="kt">size_t</span><span class="o">&gt;&amp;</span> <span class="n">image1</span><span class="p">,</span>
               <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">image_t</span><span class="p">,</span> <span class="kt">size_t</span><span class="o">&gt;&amp;</span> <span class="n">image2</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="n">image1</span><span class="p">.</span><span class="n">second</span> <span class="o">&gt;</span> <span class="n">image2</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
            <span class="p">});</span>


   <span class="c1">// 局部bundle由给定图像及其连接最紧密的相邻图像组成，因此减去1 （为什么-1？）</span>

   <span class="k">const</span> <span class="kt">size_t</span> <span class="n">num_images</span> <span class="o">=</span>
         <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">local_ba_num_images</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
   <span class="k">const</span> <span class="kt">size_t</span> <span class="n">num_eff_images</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">num_images</span><span class="p">,</span> <span class="n">overlapping_images</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>

   <span class="c1">// 提取最多连接的图像，并确保足够的三角剖分角度</span>

   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">image_t</span><span class="o">&gt;</span> <span class="n">local_bundle_image_ids</span><span class="p">;</span>
   <span class="n">local_bundle_image_ids</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">num_eff_images</span><span class="p">);</span>

   <span class="c1">// 如果重叠图像的数量等于本地bundle中所需图像的数量，则只需复制图像标识符即可</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">overlapping_images</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="n">num_eff_images</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">overlapping_image</span> <span class="p">:</span> <span class="n">overlapping_images</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">local_bundle_image_ids</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">overlapping_image</span><span class="p">.</span><span class="n">first</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="n">local_bundle_image_ids</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="c1">// 在下面的迭代中，从重叠最多的图像开始，并检查其是否具有足够的三角剖分角度。</span>
   <span class="c1">// 如果没有一个重叠的图像具有足够的三角剖分角度，则放宽三角剖分阈值，然后从最重叠的图像重新开始。</span>
   <span class="c1">// 最后如果仍然找不到足够的图像，则仅使用重叠度最高的图像</span>

   <span class="k">const</span> <span class="kt">double</span> <span class="n">min_tri_angle_rad</span> <span class="o">=</span> <span class="n">DegToRad</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">local_ba_min_tri_angle</span><span class="p">);</span>

   <span class="c1">// 选择阈值（最小三角剖分，共享观测值的最小数量）被依次放宽</span>
   <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="kt">double</span><span class="o">&gt;</span><span class="p">,</span> <span class="mi">8</span><span class="o">&gt;</span> <span class="n">selection_thresholds</span> <span class="o">=</span> <span class="p">{{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">min_tri_angle_rad</span> <span class="o">/</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">image</span><span class="p">.</span><span class="n">NumPoints3D</span><span class="p">()),</span>
      <span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">min_tri_angle_rad</span> <span class="o">/</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">image</span><span class="p">.</span><span class="n">NumPoints3D</span><span class="p">()),</span>
      <span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">min_tri_angle_rad</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">image</span><span class="p">.</span><span class="n">NumPoints3D</span><span class="p">()),</span>
      <span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">min_tri_angle_rad</span> <span class="o">/</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">image</span><span class="p">.</span><span class="n">NumPoints3D</span><span class="p">()),</span>
      <span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">min_tri_angle_rad</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">image</span><span class="p">.</span><span class="n">NumPoints3D</span><span class="p">()),</span>
      <span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">min_tri_angle_rad</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">image</span><span class="p">.</span><span class="n">NumPoints3D</span><span class="p">()),</span>
      <span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">min_tri_angle_rad</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">image</span><span class="p">.</span><span class="n">NumPoints3D</span><span class="p">()),</span>
      <span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">min_tri_angle_rad</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">,</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">image</span><span class="p">.</span><span class="n">NumPoints3D</span><span class="p">()),</span>
   <span class="p">}};</span>

   <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span> <span class="n">proj_center</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">ProjectionCenter</span><span class="p">();</span>
   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="o">&gt;</span> <span class="n">shared_points3D</span><span class="p">;</span>
   <span class="n">shared_points3D</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">NumPoints3D</span><span class="p">());</span>
   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">tri_angles</span><span class="p">(</span><span class="n">overlapping_images</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">);</span>
   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="n">used_overlapping_images</span><span class="p">(</span><span class="n">overlapping_images</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="nb">false</span><span class="p">);</span>

   <span class="c1">// 遍历每个三角剖分阈值</span>
   <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">selection_threshold</span> <span class="p">:</span> <span class="n">selection_thresholds</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 遍历每个重叠的图像</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">overlapping_image_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="n">overlapping_image_idx</span> <span class="o">&lt;</span> <span class="n">overlapping_images</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
         <span class="o">++</span><span class="n">overlapping_image_idx</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// 检查图像是否有足够的重叠。 由于图像是根据重叠进行排序的，因此在重叠不够后可以跳过其余图像。</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">overlapping_images</span><span class="p">[</span><span class="n">overlapping_image_idx</span><span class="p">].</span><span class="n">second</span> <span class="o">&lt;</span>
            <span class="n">selection_threshold</span><span class="p">.</span><span class="n">second</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>

         <span class="c1">// 检查图像是否已经在本地bundle中</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">used_overlapping_images</span><span class="p">[</span><span class="n">overlapping_image_idx</span><span class="p">])</span>
           <span class="k">continue</span><span class="p">;</span>

         <span class="c1">// 得到重叠的图像</span>
         <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">overlapping_image</span> <span class="o">=</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Image</span><span class="p">(</span>
             <span class="n">overlapping_images</span><span class="p">[</span><span class="n">overlapping_image_idx</span><span class="p">].</span><span class="n">first</span><span class="p">);</span>

         <span class="c1">// 得到重叠图像的投影中心</span>
         <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span> <span class="n">overlapping_proj_center</span> <span class="o">=</span>
             <span class="n">overlapping_image</span><span class="p">.</span><span class="n">ProjectionCenter</span><span class="p">();</span>

         <span class="c1">// 在第一次迭代中，计算三角剖分角度。 在以后的迭代中，重用先前计算的值</span>
         <span class="kt">double</span><span class="o">&amp;</span> <span class="n">tri_angle</span> <span class="o">=</span> <span class="n">tri_angles</span><span class="p">[</span><span class="n">overlapping_image_idx</span><span class="p">];</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">tri_angle</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">{</span>
           <span class="c1">// 收集观察到的3D点</span>
           <span class="n">shared_points3D</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
           <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">Point2D</span><span class="o">&amp;</span> <span class="nl">point2D</span> <span class="p">:</span> <span class="n">image</span><span class="p">.</span><span class="n">Points2D</span><span class="p">())</span> <span class="p">{</span>
             <span class="k">if</span> <span class="p">(</span><span class="n">point2D</span><span class="p">.</span><span class="n">HasPoint3D</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">point3D_ids</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">point2D</span><span class="p">.</span><span class="n">Point3DId</span><span class="p">()))</span> <span class="p">{</span>
               <span class="n">shared_points3D</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span>
                   <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Point3D</span><span class="p">(</span><span class="n">point2D</span><span class="p">.</span><span class="n">Point3DId</span><span class="p">()).</span><span class="n">XYZ</span><span class="p">());</span>
               <span class="p">}</span>
            <span class="p">}</span>

           <span class="c1">// 计算一定百分比的三角剖分角度</span>
           <span class="k">const</span> <span class="kt">double</span> <span class="n">kTriangulationAnglePercentile</span> <span class="o">=</span> <span class="mi">75</span><span class="p">;</span>
           <span class="n">tri_angle</span> <span class="o">=</span> <span class="n">Percentile</span><span class="p">(</span>
               <span class="n">CalculateTriangulationAngles</span><span class="p">(</span><span class="n">proj_center</span><span class="p">,</span> <span class="n">overlapping_proj_center</span><span class="p">,</span>
                                            <span class="n">shared_points3D</span><span class="p">),</span>
               <span class="n">kTriangulationAnglePercentile</span><span class="p">);</span>
         <span class="p">}</span>

         <span class="c1">// 检查图像是否具有足够的三角剖分角度</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">tri_angle</span> <span class="o">&gt;=</span> <span class="n">selection_threshold</span><span class="p">.</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">local_bundle_image_ids</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">overlapping_image</span><span class="p">.</span><span class="n">ImageId</span><span class="p">());</span>
            <span class="n">used_overlapping_images</span><span class="p">[</span><span class="n">overlapping_image_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="c1">// 检查是否已经收集了足够的图像</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">local_bundle_image_ids</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">num_eff_images</span><span class="p">)</span>
               <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
         <span class="p">}</span>

      <span class="c1">// 检查是否已经收集了足够的图像</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">local_bundle_image_ids</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">num_eff_images</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="c1">// 如果没有足够的具有足够三角剖分角的图像，只需用最重叠的图像填充其余图像即可</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">local_bundle_image_ids</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">num_eff_images</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">overlapping_image_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
         <span class="n">overlapping_image_idx</span> <span class="o">&lt;</span> <span class="n">overlapping_images</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
         <span class="o">++</span><span class="n">overlapping_image_idx</span><span class="p">)</span> <span class="p">{</span>
         <span class="c1">// 收集图像（如果尚未在局部bundle中）</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">used_overlapping_images</span><span class="p">[</span><span class="n">overlapping_image_idx</span><span class="p">])</span> <span class="p">{</span>
            <span class="n">local_bundle_image_ids</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span>
               <span class="n">overlapping_images</span><span class="p">[</span><span class="n">overlapping_image_idx</span><span class="p">].</span><span class="n">first</span><span class="p">);</span>
            <span class="n">used_overlapping_images</span><span class="p">[</span><span class="n">overlapping_image_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

            <span class="c1">// 检测是否已经收集了足够的图像</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">local_bundle_image_ids</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">num_eff_images</span><span class="p">)</span>
               <span class="k">break</span><span class="p">;</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="c1">// 返回局部bundle的图像id序列</span>
   <span class="k">return</span> <span class="n">local_bundle_image_ids</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>该函数的要求是在重建中找到给定图像的局部bundle。</p>
<p>该函数的步骤为：</p>
<blockquote>
<div><p>遍历给定图像的所有2D特征点的3D轨道，每条轨道都会计算其所有经过的图像的序号，最终所有特征点的3D点的轨道经过的图像在次数上会进行排序，称为 <code class="docutils literal notranslate"><span class="pre">overlapping_images</span></code> ，
对该重叠图像的序列进行排序，通过控制三角剖分的阈值，从重叠最多的图像开始，并检查其是否具有足够的三角剖分角度，符合要求的加入到 <code class="docutils literal notranslate"><span class="pre">local_bundle_image_ids</span></code> 中，最后如果仍然找不到足够的图像，则仅使用重叠度最高的图像。
最终返回局部bundle的图像id序列。</p>
</div></blockquote>
</div>
</div>
<div class="section" id="estimateinitialtwoviewgeometry">
<h3>EstimateInitialTwoViewGeometry<a class="headerlink" href="#estimateinitialtwoviewgeometry" title="永久链接至标题">¶</a></h3>
<p>估计初始种子图像对的两视图几何</p>
<dl class="cpp function">
<dt id="_CPPv4N17IncrementalMapper30EstimateInitialTwoViewGeometryERK7OptionsK7image_tK7image_t">
<span id="_CPPv3N17IncrementalMapper30EstimateInitialTwoViewGeometryERK7OptionsK7image_tK7image_t"></span><span id="_CPPv2N17IncrementalMapper30EstimateInitialTwoViewGeometryERK7OptionsK7image_tK7image_t"></span><span id="IncrementalMapper::EstimateInitialTwoViewGeometry__OptionsCR.image_tC.image_tC"></span>bool <code class="sig-prename descclassname"><a class="reference internal" href="#_CPPv417IncrementalMapper" title="IncrementalMapper">IncrementalMapper</a><code class="sig-prename descclassname">::</code></code><code class="sig-name descname">EstimateInitialTwoViewGeometry</code><span class="sig-paren">(</span><em class="property">const</em> <a class="reference internal" href="#_CPPv4N17IncrementalMapper7OptionsE" title="IncrementalMapper::Options">Options</a> &amp;<em>options</em>, <em class="property">const</em> image_t <em>image_id1</em>, <em class="property">const</em> image_t <em>image_id2</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N17IncrementalMapper30EstimateInitialTwoViewGeometryERK7OptionsK7image_tK7image_t" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">IncrementalMapper</span><span class="o">::</span><span class="n">EstimateInitialTwoViewGeometry</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">Options</span><span class="o">&amp;</span> <span class="n">options</span><span class="p">,</span> <span class="k">const</span> <span class="n">image_t</span> <span class="n">image_id1</span><span class="p">,</span> <span class="k">const</span> <span class="n">image_t</span> <span class="n">image_id2</span><span class="p">)</span> <span class="p">{</span>

   <span class="c1">// 根据图像id得到图像对</span>
   <span class="k">const</span> <span class="n">image_pair_t</span> <span class="n">image_pair_id</span> <span class="o">=</span>
      <span class="n">Database</span><span class="o">::</span><span class="n">ImagePairToPairId</span><span class="p">(</span><span class="n">image_id1</span><span class="p">,</span> <span class="n">image_id2</span><span class="p">);</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">prev_init_image_pair_id_</span> <span class="o">==</span> <span class="n">image_pair_id</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="c1">// 得到图像、对应相机、关联图、匹配关系</span>
   <span class="k">const</span> <span class="n">Image</span><span class="o">&amp;</span> <span class="n">image1</span> <span class="o">=</span> <span class="n">database_cache_</span><span class="o">-&gt;</span><span class="n">Image</span><span class="p">(</span><span class="n">image_id1</span><span class="p">);</span>
   <span class="k">const</span> <span class="n">Camera</span><span class="o">&amp;</span> <span class="n">camera1</span> <span class="o">=</span> <span class="n">database_cache_</span><span class="o">-&gt;</span><span class="n">Camera</span><span class="p">(</span><span class="n">image1</span><span class="p">.</span><span class="n">CameraId</span><span class="p">());</span>

   <span class="k">const</span> <span class="n">Image</span><span class="o">&amp;</span> <span class="n">image2</span> <span class="o">=</span> <span class="n">database_cache_</span><span class="o">-&gt;</span><span class="n">Image</span><span class="p">(</span><span class="n">image_id2</span><span class="p">);</span>
   <span class="k">const</span> <span class="n">Camera</span><span class="o">&amp;</span> <span class="n">camera2</span> <span class="o">=</span> <span class="n">database_cache_</span><span class="o">-&gt;</span><span class="n">Camera</span><span class="p">(</span><span class="n">image2</span><span class="p">.</span><span class="n">CameraId</span><span class="p">());</span>

   <span class="k">const</span> <span class="n">CorrespondenceGraph</span><span class="o">&amp;</span> <span class="n">correspondence_graph</span> <span class="o">=</span>
      <span class="n">database_cache_</span><span class="o">-&gt;</span><span class="n">CorrespondenceGraph</span><span class="p">();</span>
   <span class="k">const</span> <span class="n">FeatureMatches</span> <span class="n">matches</span> <span class="o">=</span>
      <span class="n">correspondence_graph</span><span class="p">.</span><span class="n">FindCorrespondencesBetweenImages</span><span class="p">(</span><span class="n">image_id1</span><span class="p">,</span>
                                                            <span class="n">image_id2</span><span class="p">);</span>

   <span class="c1">// 将图1中的特征点加入points1</span>
   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector2d</span><span class="o">&gt;</span> <span class="n">points1</span><span class="p">;</span>
   <span class="n">points1</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">image1</span><span class="p">.</span><span class="n">NumPoints2D</span><span class="p">());</span>
   <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">point</span> <span class="p">:</span> <span class="n">image1</span><span class="p">.</span><span class="n">Points2D</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">points1</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">XY</span><span class="p">());</span>
   <span class="p">}</span>

   <span class="c1">// 将图2中的特征点加入points2</span>
   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector2d</span><span class="o">&gt;</span> <span class="n">points2</span><span class="p">;</span>
   <span class="n">points2</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">image2</span><span class="p">.</span><span class="n">NumPoints2D</span><span class="p">());</span>
   <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">point</span> <span class="p">:</span> <span class="n">image2</span><span class="p">.</span><span class="n">Points2D</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">points2</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">point</span><span class="p">.</span><span class="n">XY</span><span class="p">());</span>
   <span class="p">}</span>

   <span class="c1">// 两视图几何估计</span>
   <span class="n">TwoViewGeometry</span> <span class="n">two_view_geometry</span><span class="p">;</span>
   <span class="n">TwoViewGeometry</span><span class="o">::</span><span class="n">Options</span> <span class="n">two_view_geometry_options</span><span class="p">;</span>
   <span class="n">two_view_geometry_options</span><span class="p">.</span><span class="n">ransac_options</span><span class="p">.</span><span class="n">min_num_trials</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
   <span class="n">two_view_geometry_options</span><span class="p">.</span><span class="n">ransac_options</span><span class="p">.</span><span class="n">max_error</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">init_max_error</span><span class="p">;</span>
   <span class="n">two_view_geometry</span><span class="p">.</span><span class="n">EstimateCalibrated</span><span class="p">(</span><span class="n">camera1</span><span class="p">,</span> <span class="n">points1</span><span class="p">,</span> <span class="n">camera2</span><span class="p">,</span> <span class="n">points2</span><span class="p">,</span>
                                       <span class="n">matches</span><span class="p">,</span> <span class="n">two_view_geometry_options</span><span class="p">);</span>

   <span class="c1">// 估计两视图相对位姿</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">two_view_geometry</span><span class="p">.</span><span class="n">EstimateRelativePose</span><span class="p">(</span><span class="n">camera1</span><span class="p">,</span> <span class="n">points1</span><span class="p">,</span> <span class="n">camera2</span><span class="p">,</span>
                                              <span class="n">points2</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="c1">// 如果匹配内点数 &gt; 最小初始化内点数 且 z轴移动 &lt; 最大位移 且 三角剖分角 &gt; 最小三角剖分角，则估计成功</span>
   <span class="k">if</span> <span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">two_view_geometry</span><span class="p">.</span><span class="n">inlier_matches</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="o">&gt;=</span>
       <span class="n">options</span><span class="p">.</span><span class="n">init_min_num_inliers</span> <span class="o">&amp;&amp;</span>
       <span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">two_view_geometry</span><span class="p">.</span><span class="n">tvec</span><span class="p">.</span><span class="n">z</span><span class="p">())</span> <span class="o">&lt;</span> <span class="n">options</span><span class="p">.</span><span class="n">init_max_forward_motion</span> <span class="o">&amp;&amp;</span>
       <span class="n">two_view_geometry</span><span class="p">.</span><span class="n">tri_angle</span> <span class="o">&gt;</span> <span class="n">DegToRad</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">init_min_tri_angle</span><span class="p">))</span> <span class="p">{</span>
         <span class="n">prev_init_image_pair_id_</span> <span class="o">=</span> <span class="n">image_pair_id</span><span class="p">;</span>
         <span class="n">prev_init_two_view_geometry_</span> <span class="o">=</span> <span class="n">two_view_geometry</span><span class="p">;</span>
         <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="registerinitialimagepair">
<h3>RegisterInitialImagePair<a class="headerlink" href="#registerinitialimagepair" title="永久链接至标题">¶</a></h3>
<p>从种子图像对开始重建</p>
<dl class="cpp function">
<dt id="_CPPv4N17IncrementalMapper24RegisterInitialImagePairERK7OptionsK7image_tK7image_t">
<span id="_CPPv3N17IncrementalMapper24RegisterInitialImagePairERK7OptionsK7image_tK7image_t"></span><span id="_CPPv2N17IncrementalMapper24RegisterInitialImagePairERK7OptionsK7image_tK7image_t"></span><span id="IncrementalMapper::RegisterInitialImagePair__OptionsCR.image_tC.image_tC"></span>bool <code class="sig-prename descclassname"><a class="reference internal" href="#_CPPv417IncrementalMapper" title="IncrementalMapper">IncrementalMapper</a><code class="sig-prename descclassname">::</code></code><code class="sig-name descname">RegisterInitialImagePair</code><span class="sig-paren">(</span><em class="property">const</em> <a class="reference internal" href="#_CPPv4N17IncrementalMapper7OptionsE" title="IncrementalMapper::Options">Options</a> &amp;<em>options</em>, <em class="property">const</em> image_t <em>image_id1</em>, <em class="property">const</em> image_t <em>image_id2</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N17IncrementalMapper24RegisterInitialImagePairERK7OptionsK7image_tK7image_t" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">IncrementalMapper</span><span class="o">::</span><span class="n">RegisterInitialImagePair</span><span class="p">(</span><span class="k">const</span> <span class="n">Options</span><span class="o">&amp;</span> <span class="n">options</span><span class="p">,</span>
                                                 <span class="k">const</span> <span class="n">image_t</span> <span class="n">image_id1</span><span class="p">,</span>
                                                 <span class="k">const</span> <span class="n">image_t</span> <span class="n">image_id2</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">CHECK_NOTNULL</span><span class="p">(</span><span class="n">reconstruction_</span><span class="p">);</span>
   <span class="n">CHECK_EQ</span><span class="p">(</span><span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">NumRegImages</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>

   <span class="n">CHECK</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">Check</span><span class="p">());</span>

   <span class="n">init_num_reg_trials_</span><span class="p">[</span><span class="n">image_id1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
   <span class="n">init_num_reg_trials_</span><span class="p">[</span><span class="n">image_id2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
   <span class="n">num_reg_trials_</span><span class="p">[</span><span class="n">image_id1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
   <span class="n">num_reg_trials_</span><span class="p">[</span><span class="n">image_id2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

   <span class="c1">// 得到图像对</span>
   <span class="k">const</span> <span class="n">image_pair_t</span> <span class="n">pair_id</span> <span class="o">=</span>
         <span class="n">Database</span><span class="o">::</span><span class="n">ImagePairToPairId</span><span class="p">(</span><span class="n">image_id1</span><span class="p">,</span> <span class="n">image_id2</span><span class="p">);</span>
   <span class="n">init_image_pairs_</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pair_id</span><span class="p">);</span>

   <span class="c1">// 得到图像和对应相机</span>
   <span class="n">Image</span><span class="o">&amp;</span> <span class="n">image1</span> <span class="o">=</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Image</span><span class="p">(</span><span class="n">image_id1</span><span class="p">);</span>
   <span class="k">const</span> <span class="n">Camera</span><span class="o">&amp;</span> <span class="n">camera1</span> <span class="o">=</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Camera</span><span class="p">(</span><span class="n">image1</span><span class="p">.</span><span class="n">CameraId</span><span class="p">());</span>

   <span class="n">Image</span><span class="o">&amp;</span> <span class="n">image2</span> <span class="o">=</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Image</span><span class="p">(</span><span class="n">image_id2</span><span class="p">);</span>
   <span class="k">const</span> <span class="n">Camera</span><span class="o">&amp;</span> <span class="n">camera2</span> <span class="o">=</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Camera</span><span class="p">(</span><span class="n">image2</span><span class="p">.</span><span class="n">CameraId</span><span class="p">());</span>

   <span class="c1">//////////////////////////////////////////////////////////////////////////////</span>
   <span class="c1">// 估计两视图几何</span>
   <span class="c1">//////////////////////////////////////////////////////////////////////////////</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EstimateInitialTwoViewGeometry</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">image_id1</span><span class="p">,</span> <span class="n">image_id2</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="c1">// 设第一个图像的旋转为单位矩阵，位移为零向量</span>
   <span class="n">image1</span><span class="p">.</span><span class="n">Qvec</span><span class="p">()</span> <span class="o">=</span> <span class="n">ComposeIdentityQuaternion</span><span class="p">();</span>
   <span class="n">image1</span><span class="p">.</span><span class="n">Tvec</span><span class="p">()</span> <span class="o">=</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

   <span class="c1">// 第二个图像的R和t为从两视图几何中分解得到的相对旋转和位移</span>
   <span class="n">image2</span><span class="p">.</span><span class="n">Qvec</span><span class="p">()</span> <span class="o">=</span> <span class="n">prev_init_two_view_geometry_</span><span class="p">.</span><span class="n">qvec</span><span class="p">;</span>
   <span class="n">image2</span><span class="p">.</span><span class="n">Tvec</span><span class="p">()</span> <span class="o">=</span> <span class="n">prev_init_two_view_geometry_</span><span class="p">.</span><span class="n">tvec</span><span class="p">;</span>

   <span class="c1">// 得到两个图像的投影矩阵和投影中心</span>
   <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3x4d</span> <span class="n">proj_matrix1</span> <span class="o">=</span> <span class="n">image1</span><span class="p">.</span><span class="n">ProjectionMatrix</span><span class="p">();</span>
   <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix3x4d</span> <span class="n">proj_matrix2</span> <span class="o">=</span> <span class="n">image2</span><span class="p">.</span><span class="n">ProjectionMatrix</span><span class="p">();</span>
   <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span> <span class="n">proj_center1</span> <span class="o">=</span> <span class="n">image1</span><span class="p">.</span><span class="n">ProjectionCenter</span><span class="p">();</span>
   <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span> <span class="n">proj_center2</span> <span class="o">=</span> <span class="n">image2</span><span class="p">.</span><span class="n">ProjectionCenter</span><span class="p">();</span>

   <span class="c1">//////////////////////////////////////////////////////////////////////////////</span>
   <span class="c1">// 更新重建</span>
   <span class="c1">//////////////////////////////////////////////////////////////////////////////</span>

   <span class="c1">// 重建注册两个图片</span>
   <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">RegisterImage</span><span class="p">(</span><span class="n">image_id1</span><span class="p">);</span>
   <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">RegisterImage</span><span class="p">(</span><span class="n">image_id2</span><span class="p">);</span>
   <span class="n">RegisterImageEvent</span><span class="p">(</span><span class="n">image_id1</span><span class="p">);</span>
   <span class="n">RegisterImageEvent</span><span class="p">(</span><span class="n">image_id2</span><span class="p">);</span>

   <span class="c1">// 从数据库中得到关联图和特征匹配</span>
   <span class="k">const</span> <span class="n">CorrespondenceGraph</span><span class="o">&amp;</span> <span class="n">correspondence_graph</span> <span class="o">=</span>
         <span class="n">database_cache_</span><span class="o">-&gt;</span><span class="n">CorrespondenceGraph</span><span class="p">();</span>
   <span class="k">const</span> <span class="n">FeatureMatches</span><span class="o">&amp;</span> <span class="n">corrs</span> <span class="o">=</span>
         <span class="n">correspondence_graph</span><span class="p">.</span><span class="n">FindCorrespondencesBetweenImages</span><span class="p">(</span><span class="n">image_id1</span><span class="p">,</span>
                                                            <span class="n">image_id2</span><span class="p">);</span>

   <span class="c1">// 得到最小三角剖分角度</span>
   <span class="k">const</span> <span class="kt">double</span> <span class="n">min_tri_angle_rad</span> <span class="o">=</span> <span class="n">DegToRad</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">init_min_tri_angle</span><span class="p">);</span>

   <span class="c1">// 将3D点加入到Track中</span>
   <span class="n">Track</span> <span class="n">track</span><span class="p">;</span>
   <span class="n">track</span><span class="p">.</span><span class="n">Reserve</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
   <span class="n">track</span><span class="p">.</span><span class="n">AddElement</span><span class="p">(</span><span class="n">TrackElement</span><span class="p">());</span>
   <span class="n">track</span><span class="p">.</span><span class="n">AddElement</span><span class="p">(</span><span class="n">TrackElement</span><span class="p">());</span>
   <span class="n">track</span><span class="p">.</span><span class="n">Element</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">image_id</span> <span class="o">=</span> <span class="n">image_id1</span><span class="p">;</span>
   <span class="n">track</span><span class="p">.</span><span class="n">Element</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">image_id</span> <span class="o">=</span> <span class="n">image_id2</span><span class="p">;</span>

   <span class="c1">// 遍历所有的匹配点</span>
   <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">corr</span> <span class="p">:</span> <span class="n">corrs</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 将两幅图的特征匹配点从图像坐标系变换到世界坐标系</span>
      <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector2d</span> <span class="n">point1_N</span> <span class="o">=</span>
         <span class="n">camera1</span><span class="p">.</span><span class="n">ImageToWorld</span><span class="p">(</span><span class="n">image1</span><span class="p">.</span><span class="n">Point2D</span><span class="p">(</span><span class="n">corr</span><span class="p">.</span><span class="n">point2D_idx1</span><span class="p">).</span><span class="n">XY</span><span class="p">());</span>
      <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector2d</span> <span class="n">point2_N</span> <span class="o">=</span>
         <span class="n">camera2</span><span class="p">.</span><span class="n">ImageToWorld</span><span class="p">(</span><span class="n">image2</span><span class="p">.</span><span class="n">Point2D</span><span class="p">(</span><span class="n">corr</span><span class="p">.</span><span class="n">point2D_idx2</span><span class="p">).</span><span class="n">XY</span><span class="p">());</span>

      <span class="c1">// 三角化匹配点，得到3D点</span>
      <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="o">&amp;</span> <span class="n">xyz</span> <span class="o">=</span>
         <span class="n">TriangulatePoint</span><span class="p">(</span><span class="n">proj_matrix1</span><span class="p">,</span> <span class="n">proj_matrix2</span><span class="p">,</span> <span class="n">point1_N</span><span class="p">,</span> <span class="n">point2_N</span><span class="p">);</span>

      <span class="c1">// 根据投影矩阵和3D点计算三角剖分角</span>
      <span class="k">const</span> <span class="kt">double</span> <span class="n">tri_angle</span> <span class="o">=</span>
         <span class="n">CalculateTriangulationAngle</span><span class="p">(</span><span class="n">proj_center1</span><span class="p">,</span> <span class="n">proj_center2</span><span class="p">,</span> <span class="n">xyz</span><span class="p">);</span>

      <span class="c1">// 如果三角剖分角 &gt;= 最小三角剖分角度， 且投影之后的3D点的深度为正，则将该3D点加入重建</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">tri_angle</span> <span class="o">&gt;=</span> <span class="n">min_tri_angle_rad</span> <span class="o">&amp;&amp;</span>
         <span class="n">HasPointPositiveDepth</span><span class="p">(</span><span class="n">proj_matrix1</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
         <span class="n">HasPointPositiveDepth</span><span class="p">(</span><span class="n">proj_matrix2</span><span class="p">,</span> <span class="n">xyz</span><span class="p">))</span> <span class="p">{</span>
         <span class="n">track</span><span class="p">.</span><span class="n">Element</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">point2D_idx</span> <span class="o">=</span> <span class="n">corr</span><span class="p">.</span><span class="n">point2D_idx1</span><span class="p">;</span>
         <span class="n">track</span><span class="p">.</span><span class="n">Element</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">point2D_idx</span> <span class="o">=</span> <span class="n">corr</span><span class="p">.</span><span class="n">point2D_idx2</span><span class="p">;</span>
         <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">AddPoint3D</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">track</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="registernextimage">
<h3>RegisterNextImage<a class="headerlink" href="#registernextimage" title="永久链接至标题">¶</a></h3>
<p>尝试将图像注册到现有模型。</p>
<p>要求之前对 <code class="docutils literal notranslate"><span class="pre">RegisterInitialImagePair</span></code> 的调用成功。</p>
<dl class="cpp function">
<dt id="_CPPv4N17IncrementalMapper17RegisterNextImageERK7OptionsK7image_t">
<span id="_CPPv3N17IncrementalMapper17RegisterNextImageERK7OptionsK7image_t"></span><span id="_CPPv2N17IncrementalMapper17RegisterNextImageERK7OptionsK7image_t"></span><span id="IncrementalMapper::RegisterNextImage__OptionsCR.image_tC"></span>bool <code class="sig-prename descclassname"><a class="reference internal" href="#_CPPv417IncrementalMapper" title="IncrementalMapper">IncrementalMapper</a><code class="sig-prename descclassname">::</code></code><code class="sig-name descname">RegisterNextImage</code><span class="sig-paren">(</span><em class="property">const</em> <a class="reference internal" href="#_CPPv4N17IncrementalMapper7OptionsE" title="IncrementalMapper::Options">Options</a> &amp;<em>options</em>, <em class="property">const</em> image_t <em>image_id</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N17IncrementalMapper17RegisterNextImageERK7OptionsK7image_t" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">IncrementalMapper</span><span class="o">::</span><span class="n">RegisterNextImage</span><span class="p">(</span><span class="k">const</span> <span class="n">Options</span><span class="o">&amp;</span> <span class="n">options</span><span class="p">,</span>
                                          <span class="k">const</span> <span class="n">image_t</span> <span class="n">image_id</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">CHECK_NOTNULL</span><span class="p">(</span><span class="n">reconstruction_</span><span class="p">);</span>
  <span class="n">CHECK_GE</span><span class="p">(</span><span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">NumRegImages</span><span class="p">(),</span> <span class="mi">2</span><span class="p">);</span>

  <span class="n">CHECK</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">Check</span><span class="p">());</span>

   <span class="c1">// 得到图片和对应相机</span>
   <span class="n">Image</span><span class="o">&amp;</span> <span class="n">image</span> <span class="o">=</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Image</span><span class="p">(</span><span class="n">image_id</span><span class="p">);</span>
   <span class="n">Camera</span><span class="o">&amp;</span> <span class="n">camera</span> <span class="o">=</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Camera</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">CameraId</span><span class="p">());</span>

   <span class="n">CHECK</span><span class="p">(</span><span class="o">!</span><span class="n">image</span><span class="p">.</span><span class="n">IsRegistered</span><span class="p">())</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Image cannot be registered multiple times&quot;</span><span class="p">;</span>

   <span class="c1">// 该图片的尝试注册次数+1</span>
   <span class="n">num_reg_trials_</span><span class="p">[</span><span class="n">image_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

   <span class="c1">// 如果没有足够多的可见点，则注册失败</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">NumVisiblePoints3D</span><span class="p">()</span> <span class="o">&lt;</span>
         <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">abs_pose_min_num_inliers</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="c1">//////////////////////////////////////////////////////////////////////////////</span>
   <span class="c1">// 寻找2D-3D对应关系</span>
   <span class="c1">//////////////////////////////////////////////////////////////////////////////</span>

   <span class="k">const</span> <span class="kt">int</span> <span class="n">kCorrTransitivity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">point2D_t</span><span class="p">,</span> <span class="n">point3D_t</span><span class="o">&gt;&gt;</span> <span class="n">tri_corrs</span><span class="p">;</span>
   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector2d</span><span class="o">&gt;</span> <span class="n">tri_points2D</span><span class="p">;</span>
   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="o">&gt;</span> <span class="n">tri_points3D</span><span class="p">;</span>

   <span class="k">for</span> <span class="p">(</span><span class="n">point2D_t</span> <span class="n">point2D_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">point2D_idx</span> <span class="o">&lt;</span> <span class="n">image</span><span class="p">.</span><span class="n">NumPoints2D</span><span class="p">();</span>
         <span class="o">++</span><span class="n">point2D_idx</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">const</span> <span class="n">Point2D</span><span class="o">&amp;</span> <span class="n">point2D</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">Point2D</span><span class="p">(</span><span class="n">point2D_idx</span><span class="p">);</span>
      <span class="k">const</span> <span class="n">CorrespondenceGraph</span><span class="o">&amp;</span> <span class="n">correspondence_graph</span> <span class="o">=</span>
         <span class="n">database_cache_</span><span class="o">-&gt;</span><span class="n">CorrespondenceGraph</span><span class="p">();</span>

      <span class="c1">// kCorrTransitivity = 1 相当于找到对应的匹配点对</span>
      <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">CorrespondenceGraph</span><span class="o">::</span><span class="n">Correspondence</span><span class="o">&gt;</span> <span class="n">corrs</span> <span class="o">=</span>
         <span class="n">correspondence_graph</span><span class="p">.</span><span class="n">FindTransitiveCorrespondences</span><span class="p">(</span>
               <span class="n">image_id</span><span class="p">,</span> <span class="n">point2D_idx</span><span class="p">,</span> <span class="n">kCorrTransitivity</span><span class="p">);</span>

      <span class="n">std</span><span class="o">::</span><span class="n">unordered_set</span><span class="o">&lt;</span><span class="n">point3D_t</span><span class="o">&gt;</span> <span class="n">point3D_ids</span><span class="p">;</span>

      <span class="c1">// 遍历所有的特征点对</span>
      <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="nl">corr</span> <span class="p">:</span> <span class="n">corrs</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">const</span> <span class="n">Image</span><span class="o">&amp;</span> <span class="n">corr_image</span> <span class="o">=</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Image</span><span class="p">(</span><span class="n">corr</span><span class="p">.</span><span class="n">image_id</span><span class="p">);</span>

         <span class="c1">// 如果该对应图像没有被注册，则跳过</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">corr_image</span><span class="p">.</span><span class="n">IsRegistered</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
         <span class="p">}</span>

         <span class="k">const</span> <span class="n">Point2D</span><span class="o">&amp;</span> <span class="n">corr_point2D</span> <span class="o">=</span> <span class="n">corr_image</span><span class="p">.</span><span class="n">Point2D</span><span class="p">(</span><span class="n">corr</span><span class="p">.</span><span class="n">point2D_idx</span><span class="p">);</span>

         <span class="c1">// 如果匹配点没有重建好的3D点，则跳过</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">corr_point2D</span><span class="p">.</span><span class="n">HasPoint3D</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
         <span class="p">}</span>

         <span class="c1">// 避免重复的匹配关系</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">point3D_ids</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">corr_point2D</span><span class="p">.</span><span class="n">Point3DId</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
         <span class="p">}</span>

         <span class="k">const</span> <span class="n">Camera</span><span class="o">&amp;</span> <span class="n">corr_camera</span> <span class="o">=</span>
            <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Camera</span><span class="p">(</span><span class="n">corr_image</span><span class="p">.</span><span class="n">CameraId</span><span class="p">());</span>

         <span class="c1">// 避免与伪造的相机参数对应的图像</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">corr_camera</span><span class="p">.</span><span class="n">HasBogusParams</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">min_focal_length_ratio</span><span class="p">,</span>
                                     <span class="n">options</span><span class="p">.</span><span class="n">max_focal_length_ratio</span><span class="p">,</span>
                                     <span class="n">options</span><span class="p">.</span><span class="n">max_extra_param</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
         <span class="p">}</span>

         <span class="k">const</span> <span class="n">Point3D</span><span class="o">&amp;</span> <span class="n">point3D</span> <span class="o">=</span>
            <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Point3D</span><span class="p">(</span><span class="n">corr_point2D</span><span class="p">.</span><span class="n">Point3DId</span><span class="p">());</span>

         <span class="c1">// 图像2d点和对应匹配3d点关联</span>
         <span class="n">tri_corrs</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">point2D_idx</span><span class="p">,</span> <span class="n">corr_point2D</span><span class="p">.</span><span class="n">Point3DId</span><span class="p">());</span>
         <span class="n">point3D_ids</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">corr_point2D</span><span class="p">.</span><span class="n">Point3DId</span><span class="p">());</span>
         <span class="n">tri_points2D</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">point2D</span><span class="p">.</span><span class="n">XY</span><span class="p">());</span>
         <span class="n">tri_points3D</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">point3D</span><span class="p">.</span><span class="n">XYZ</span><span class="p">());</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="c1">// 仅当存在带有伪造相机参数的图像时，“ next_image.num_tri_obs”和“ tri_corrs_point2D_idxs.size（）”的大小才能不同，</span>
   <span class="c1">// 因此跳过了一些2D-3D对应关系。</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">tri_points2D</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;</span>
         <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">abs_pose_min_num_inliers</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="c1">//////////////////////////////////////////////////////////////////////////////</span>
   <span class="c1">// 2D-3D 估计</span>
   <span class="c1">//////////////////////////////////////////////////////////////////////////////</span>

   <span class="c1">// 如果未指定焦距（手动或通过EXIF）并且先前尚未从其他图像进行估计（当多个图像共享相同的相机参数时），则仅优化/估计焦距。</span>

   <span class="n">AbsolutePoseEstimationOptions</span> <span class="n">abs_pose_options</span><span class="p">;</span>
   <span class="n">abs_pose_options</span><span class="p">.</span><span class="n">num_threads</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">num_threads</span><span class="p">;</span>
   <span class="n">abs_pose_options</span><span class="p">.</span><span class="n">num_focal_length_samples</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
   <span class="n">abs_pose_options</span><span class="p">.</span><span class="n">min_focal_length_ratio</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">min_focal_length_ratio</span><span class="p">;</span>
   <span class="n">abs_pose_options</span><span class="p">.</span><span class="n">max_focal_length_ratio</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">max_focal_length_ratio</span><span class="p">;</span>
   <span class="n">abs_pose_options</span><span class="p">.</span><span class="n">ransac_options</span><span class="p">.</span><span class="n">max_error</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">abs_pose_max_error</span><span class="p">;</span>
   <span class="n">abs_pose_options</span><span class="p">.</span><span class="n">ransac_options</span><span class="p">.</span><span class="n">min_inlier_ratio</span> <span class="o">=</span>
         <span class="n">options</span><span class="p">.</span><span class="n">abs_pose_min_inlier_ratio</span><span class="p">;</span>
   <span class="c1">// 使用高可信度来避免提前终止P3P RANSAC————太早终止可能会导致注册错误。</span>
   <span class="n">abs_pose_options</span><span class="p">.</span><span class="n">ransac_options</span><span class="p">.</span><span class="n">min_num_trials</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
   <span class="n">abs_pose_options</span><span class="p">.</span><span class="n">ransac_options</span><span class="p">.</span><span class="n">max_num_trials</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
   <span class="n">abs_pose_options</span><span class="p">.</span><span class="n">ransac_options</span><span class="p">.</span><span class="n">confidence</span> <span class="o">=</span> <span class="mf">0.99999</span><span class="p">;</span>

   <span class="n">AbsolutePoseRefinementOptions</span> <span class="n">abs_pose_refinement_options</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">num_reg_images_per_camera_</span><span class="p">[</span><span class="n">image</span><span class="p">.</span><span class="n">CameraId</span><span class="p">()]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 相机已经因为另外的图像而优化过。</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">camera</span><span class="p">.</span><span class="n">HasBogusParams</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">min_focal_length_ratio</span><span class="p">,</span>
                                 <span class="n">options</span><span class="p">.</span><span class="n">max_focal_length_ratio</span><span class="p">,</span>
                                 <span class="n">options</span><span class="p">.</span><span class="n">max_extra_param</span><span class="p">))</span> <span class="p">{</span>
         <span class="c1">// 先前优化的相机具有伪造的参数，因此重置参数并尝试重新建立图像。</span>
         <span class="n">camera</span><span class="p">.</span><span class="n">SetParams</span><span class="p">(</span><span class="n">database_cache_</span><span class="o">-&gt;</span><span class="n">Camera</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">CameraId</span><span class="p">()).</span><span class="n">Params</span><span class="p">());</span>
         <span class="n">abs_pose_options</span><span class="p">.</span><span class="n">estimate_focal_length</span> <span class="o">=</span> <span class="o">!</span><span class="n">camera</span><span class="p">.</span><span class="n">HasPriorFocalLength</span><span class="p">();</span>
         <span class="n">abs_pose_refinement_options</span><span class="p">.</span><span class="n">refine_focal_length</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
         <span class="n">abs_pose_refinement_options</span><span class="p">.</span><span class="n">refine_extra_params</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="n">abs_pose_options</span><span class="p">.</span><span class="n">estimate_focal_length</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
         <span class="n">abs_pose_refinement_options</span><span class="p">.</span><span class="n">refine_focal_length</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
         <span class="n">abs_pose_refinement_options</span><span class="p">.</span><span class="n">refine_extra_params</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

      <span class="c1">// 相机未优化过。 之前可能已经更改了相机参数，但已过滤了图像，因此重置相机参数并尝试重新估计。</span>
      <span class="n">camera</span><span class="p">.</span><span class="n">SetParams</span><span class="p">(</span><span class="n">database_cache_</span><span class="o">-&gt;</span><span class="n">Camera</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">CameraId</span><span class="p">()).</span><span class="n">Params</span><span class="p">());</span>
      <span class="n">abs_pose_options</span><span class="p">.</span><span class="n">estimate_focal_length</span> <span class="o">=</span> <span class="o">!</span><span class="n">camera</span><span class="p">.</span><span class="n">HasPriorFocalLength</span><span class="p">();</span>
      <span class="n">abs_pose_refinement_options</span><span class="p">.</span><span class="n">refine_focal_length</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">abs_pose_refinement_options</span><span class="p">.</span><span class="n">refine_extra_params</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span><span class="p">.</span><span class="n">abs_pose_refine_focal_length</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">abs_pose_options</span><span class="p">.</span><span class="n">estimate_focal_length</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="n">abs_pose_refinement_options</span><span class="p">.</span><span class="n">refine_focal_length</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span><span class="p">.</span><span class="n">abs_pose_refine_extra_params</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">abs_pose_refinement_options</span><span class="p">.</span><span class="n">refine_extra_params</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="kt">size_t</span> <span class="n">num_inliers</span><span class="p">;</span>
   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="n">inlier_mask</span><span class="p">;</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EstimateAbsolutePose</span><span class="p">(</span><span class="n">abs_pose_options</span><span class="p">,</span> <span class="n">tri_points2D</span><span class="p">,</span> <span class="n">tri_points3D</span><span class="p">,</span>
                              <span class="o">&amp;</span><span class="n">image</span><span class="p">.</span><span class="n">Qvec</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">image</span><span class="p">.</span><span class="n">Tvec</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">camera</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_inliers</span><span class="p">,</span>
                              <span class="o">&amp;</span><span class="n">inlier_mask</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
   <span class="p">}</span>

   <span class="k">if</span> <span class="p">(</span><span class="n">num_inliers</span> <span class="o">&lt;</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">abs_pose_min_num_inliers</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
   <span class="p">}</span>

  <span class="c1">//////////////////////////////////////////////////////////////////////////////</span>
  <span class="c1">// 位姿BA优化</span>
  <span class="c1">//////////////////////////////////////////////////////////////////////////////</span>

   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">RefineAbsolutePose</span><span class="p">(</span><span class="n">abs_pose_refinement_options</span><span class="p">,</span> <span class="n">inlier_mask</span><span class="p">,</span>
                           <span class="n">tri_points2D</span><span class="p">,</span> <span class="n">tri_points3D</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">image</span><span class="p">.</span><span class="n">Qvec</span><span class="p">(),</span>
                           <span class="o">&amp;</span><span class="n">image</span><span class="p">.</span><span class="n">Tvec</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">camera</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
   <span class="p">}</span>

  <span class="c1">//////////////////////////////////////////////////////////////////////////////</span>
  <span class="c1">// Continue tracks</span>
  <span class="c1">//////////////////////////////////////////////////////////////////////////////</span>

   <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">RegisterImage</span><span class="p">(</span><span class="n">image_id</span><span class="p">);</span>
   <span class="n">RegisterImageEvent</span><span class="p">(</span><span class="n">image_id</span><span class="p">);</span>

   <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">inlier_mask</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">inlier_mask</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
         <span class="k">const</span> <span class="n">point2D_t</span> <span class="n">point2D_idx</span> <span class="o">=</span> <span class="n">tri_corrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">first</span><span class="p">;</span>
         <span class="k">const</span> <span class="n">Point2D</span><span class="o">&amp;</span> <span class="n">point2D</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">Point2D</span><span class="p">(</span><span class="n">point2D_idx</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">point2D</span><span class="p">.</span><span class="n">HasPoint3D</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">const</span> <span class="n">point3D_t</span> <span class="n">point3D_id</span> <span class="o">=</span> <span class="n">tri_corrs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">second</span><span class="p">;</span>
            <span class="k">const</span> <span class="n">TrackElement</span> <span class="nf">track_el</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="n">point2D_idx</span><span class="p">);</span>
            <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">AddObservation</span><span class="p">(</span><span class="n">point3D_id</span><span class="p">,</span> <span class="n">track_el</span><span class="p">);</span>
            <span class="n">triangulator_</span><span class="o">-&gt;</span><span class="n">AddModifiedPoint3D</span><span class="p">(</span><span class="n">point3D_id</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="triangulate">
<h3>Triangulate<a class="headerlink" href="#triangulate" title="永久链接至标题">¶</a></h3>
<p>👉</p>
<p><strong>TriangulateImage</strong></p>
<p>对图像进行三角测量</p>
<dl class="cpp function">
<dt id="_CPPv4N17IncrementalMapper16TriangulateImageERKN23IncrementalTriangulator7OptionsEK7image_t">
<span id="_CPPv3N17IncrementalMapper16TriangulateImageERKN23IncrementalTriangulator7OptionsEK7image_t"></span><span id="_CPPv2N17IncrementalMapper16TriangulateImageERKN23IncrementalTriangulator7OptionsEK7image_t"></span><span id="IncrementalMapper::TriangulateImage__IncrementalTriangulator::OptionsCR.image_tC"></span>size_t <code class="sig-prename descclassname"><a class="reference internal" href="#_CPPv417IncrementalMapper" title="IncrementalMapper">IncrementalMapper</a><code class="sig-prename descclassname">::</code></code><code class="sig-name descname">TriangulateImage</code><span class="sig-paren">(</span><em class="property">const</em> IncrementalTriangulator::Options &amp;<em>tri_options</em>, <em class="property">const</em> image_t <em>image_id</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N17IncrementalMapper16TriangulateImageERKN23IncrementalTriangulator7OptionsEK7image_t" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">size_t</span> <span class="n">IncrementalMapper</span><span class="o">::</span><span class="n">TriangulateImage</span><span class="p">(</span>
      <span class="k">const</span> <span class="n">IncrementalTriangulator</span><span class="o">::</span><span class="n">Options</span><span class="o">&amp;</span> <span class="n">tri_options</span><span class="p">,</span>
      <span class="k">const</span> <span class="n">image_t</span> <span class="n">image_id</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">CHECK_NOTNULL</span><span class="p">(</span><span class="n">reconstruction_</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">triangulator_</span><span class="o">-&gt;</span><span class="n">TriangulateImage</span><span class="p">(</span><span class="n">tri_options</span><span class="p">,</span> <span class="n">image_id</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Retriangulate</strong></p>
<p>重新三角测量在场景图中有共同观测结果但不会引起漂移的图像对。</p>
<p>要处理场景漂移，所采用的重投影误差阈值应相对较大。</p>
<ul class="simple">
<li><p>如果阈值太大，则非鲁棒的BA调整将失败。</p></li>
<li><p>如果阈值太小，将无法有效地解决漂移问题。</p></li>
</ul>
<dl class="cpp function">
<dt id="_CPPv4N17IncrementalMapper13RetriangulateERKN23IncrementalTriangulator7OptionsE">
<span id="_CPPv3N17IncrementalMapper13RetriangulateERKN23IncrementalTriangulator7OptionsE"></span><span id="_CPPv2N17IncrementalMapper13RetriangulateERKN23IncrementalTriangulator7OptionsE"></span><span id="IncrementalMapper::Retriangulate__IncrementalTriangulator::OptionsCR"></span>size_t <code class="sig-prename descclassname"><a class="reference internal" href="#_CPPv417IncrementalMapper" title="IncrementalMapper">IncrementalMapper</a><code class="sig-prename descclassname">::</code></code><code class="sig-name descname">Retriangulate</code><span class="sig-paren">(</span><em class="property">const</em> IncrementalTriangulator::Options &amp;<em>tri_options</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N17IncrementalMapper13RetriangulateERKN23IncrementalTriangulator7OptionsE" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">size_t</span> <span class="n">IncrementalMapper</span><span class="o">::</span><span class="n">Retriangulate</span><span class="p">(</span>
      <span class="k">const</span> <span class="n">IncrementalTriangulator</span><span class="o">::</span><span class="n">Options</span><span class="o">&amp;</span> <span class="n">tri_options</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">CHECK_NOTNULL</span><span class="p">(</span><span class="n">reconstruction_</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">triangulator_</span><span class="o">-&gt;</span><span class="n">Retriangulate</span><span class="p">(</span><span class="n">tri_options</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>CompleteTracks</strong></p>
<p>通过过渡性地遵循场景图对应关系来完成轨道。</p>
<p>BA调整后，此函数特别有效，因为许多摄像机和点的位置可能已得到改善。</p>
<p>完成轨道后，可以更好地注册新图像。</p>
<dl class="cpp function">
<dt id="_CPPv4N17IncrementalMapper14CompleteTracksERKN23IncrementalTriangulator7OptionsE">
<span id="_CPPv3N17IncrementalMapper14CompleteTracksERKN23IncrementalTriangulator7OptionsE"></span><span id="_CPPv2N17IncrementalMapper14CompleteTracksERKN23IncrementalTriangulator7OptionsE"></span><span id="IncrementalMapper::CompleteTracks__IncrementalTriangulator::OptionsCR"></span>size_t <code class="sig-prename descclassname"><a class="reference internal" href="#_CPPv417IncrementalMapper" title="IncrementalMapper">IncrementalMapper</a><code class="sig-prename descclassname">::</code></code><code class="sig-name descname">CompleteTracks</code><span class="sig-paren">(</span><em class="property">const</em> IncrementalTriangulator::Options &amp;<em>tri_options</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N17IncrementalMapper14CompleteTracksERKN23IncrementalTriangulator7OptionsE" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">size_t</span> <span class="n">IncrementalMapper</span><span class="o">::</span><span class="n">CompleteTracks</span><span class="p">(</span>
      <span class="k">const</span> <span class="n">IncrementalTriangulator</span><span class="o">::</span><span class="n">Options</span><span class="o">&amp;</span> <span class="n">tri_options</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">CHECK_NOTNULL</span><span class="p">(</span><span class="n">reconstruction_</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">triangulator_</span><span class="o">-&gt;</span><span class="n">CompleteAllTracks</span><span class="p">(</span><span class="n">tri_options</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>MergeTracks</strong></p>
<p>使用场景图对应关系来合并轨道，这在BA调整后有效，并改善了后续BA调整中的冗余性。</p>
<dl class="cpp function">
<dt id="_CPPv4N17IncrementalMapper11MergeTracksERKN23IncrementalTriangulator7OptionsE">
<span id="_CPPv3N17IncrementalMapper11MergeTracksERKN23IncrementalTriangulator7OptionsE"></span><span id="_CPPv2N17IncrementalMapper11MergeTracksERKN23IncrementalTriangulator7OptionsE"></span><span id="IncrementalMapper::MergeTracks__IncrementalTriangulator::OptionsCR"></span>size_t <code class="sig-prename descclassname"><a class="reference internal" href="#_CPPv417IncrementalMapper" title="IncrementalMapper">IncrementalMapper</a><code class="sig-prename descclassname">::</code></code><code class="sig-name descname">MergeTracks</code><span class="sig-paren">(</span><em class="property">const</em> IncrementalTriangulator::Options &amp;<em>tri_options</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N17IncrementalMapper11MergeTracksERKN23IncrementalTriangulator7OptionsE" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">size_t</span> <span class="n">IncrementalMapper</span><span class="o">::</span><span class="n">MergeTracks</span><span class="p">(</span>
      <span class="k">const</span> <span class="n">IncrementalTriangulator</span><span class="o">::</span><span class="n">Options</span><span class="o">&amp;</span> <span class="n">tri_options</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">CHECK_NOTNULL</span><span class="p">(</span><span class="n">reconstruction_</span><span class="p">);</span>
   <span class="k">return</span> <span class="n">triangulator_</span><span class="o">-&gt;</span><span class="n">MergeAllTracks</span><span class="p">(</span><span class="n">tri_options</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="adjustlocalbundle">
<h3>AdjustLocalBundle<a class="headerlink" href="#adjustlocalbundle" title="永久链接至标题">¶</a></h3>
<p>调整局部连接的图像和参考图像的点。</p>
<p>此外，优化提供的3D点。 仅优化连接到参考图像的图像。 如果提供的3D点未局部连接到参考图像，则在调整中将其观察图像设置为常数。</p>
<dl class="cpp function">
<dt id="_CPPv4N17IncrementalMapper17AdjustLocalBundleERK7OptionsRK23BundleAdjustmentOptionsRKN23IncrementalTriangulator7OptionsEK7image_tRKNSt13unordered_setI9point3D_tEE">
<span id="_CPPv3N17IncrementalMapper17AdjustLocalBundleERK7OptionsRK23BundleAdjustmentOptionsRKN23IncrementalTriangulator7OptionsEK7image_tRKNSt13unordered_setI9point3D_tEE"></span><span id="_CPPv2N17IncrementalMapper17AdjustLocalBundleERK7OptionsRK23BundleAdjustmentOptionsRKN23IncrementalTriangulator7OptionsEK7image_tRKNSt13unordered_setI9point3D_tEE"></span><span id="IncrementalMapper::AdjustLocalBundle__OptionsCR.BundleAdjustmentOptionsCR.IncrementalTriangulator::OptionsCR.image_tC.std::unordered_set:point3D_t:CR"></span><code class="sig-prename descclassname"><a class="reference internal" href="#_CPPv417IncrementalMapper" title="IncrementalMapper">IncrementalMapper</a><code class="sig-prename descclassname">::</code></code><code class="sig-name descname">AdjustLocalBundle</code><span class="sig-paren">(</span><em class="property">const</em> <a class="reference internal" href="#_CPPv4N17IncrementalMapper7OptionsE" title="IncrementalMapper::Options">Options</a> &amp;<em>options</em>, <em class="property">const</em> BundleAdjustmentOptions &amp;<em>ba_options</em>, <em class="property">const</em> IncrementalTriangulator::Options &amp;<em>tri_options</em>, <em class="property">const</em> image_t <em>image_id</em>, <em class="property">const</em> std::unordered_set&lt;point3D_t&gt; &amp;<em>point3D_ids</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv4N17IncrementalMapper17AdjustLocalBundleERK7OptionsRK23BundleAdjustmentOptionsRKN23IncrementalTriangulator7OptionsEK7image_tRKNSt13unordered_setI9point3D_tEE" title="永久链接至目标">¶</a><br /></dt>
<dd></dd></dl>

<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">IncrementalMapper</span><span class="o">::</span><span class="n">LocalBundleAdjustmentReport</span>
<span class="n">IncrementalMapper</span><span class="o">::</span><span class="n">AdjustLocalBundle</span><span class="p">(</span>
      <span class="k">const</span> <span class="n">Options</span><span class="o">&amp;</span> <span class="n">options</span><span class="p">,</span> <span class="k">const</span> <span class="n">BundleAdjustmentOptions</span><span class="o">&amp;</span> <span class="n">ba_options</span><span class="p">,</span>
      <span class="k">const</span> <span class="n">IncrementalTriangulator</span><span class="o">::</span><span class="n">Options</span><span class="o">&amp;</span> <span class="n">tri_options</span><span class="p">,</span> <span class="k">const</span> <span class="n">image_t</span> <span class="n">image_id</span><span class="p">,</span>
      <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">unordered_set</span><span class="o">&lt;</span><span class="n">point3D_t</span><span class="o">&gt;&amp;</span> <span class="n">point3D_ids</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">CHECK_NOTNULL</span><span class="p">(</span><span class="n">reconstruction_</span><span class="p">);</span>
   <span class="n">CHECK</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">Check</span><span class="p">());</span>

   <span class="n">LocalBundleAdjustmentReport</span> <span class="n">report</span><span class="p">;</span>

   <span class="c1">// 查找与给定的图像有最多公共3D点的图像</span>
   <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">image_t</span><span class="o">&gt;</span> <span class="n">local_bundle</span> <span class="o">=</span> <span class="n">FindLocalBundle</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">image_id</span><span class="p">);</span>

   <span class="c1">// 仅在有连接的图像的情况下进行BA调整</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">local_bundle</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">BundleAdjustmentConfig</span> <span class="n">ba_config</span><span class="p">;</span>
      <span class="n">ba_config</span><span class="p">.</span><span class="n">AddImage</span><span class="p">(</span><span class="n">image_id</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">image_t</span> <span class="nl">local_image_id</span> <span class="p">:</span> <span class="n">local_bundle</span><span class="p">)</span>
         <span class="n">ba_config</span><span class="p">.</span><span class="n">AddImage</span><span class="p">(</span><span class="n">local_image_id</span><span class="p">);</span>

      <span class="c1">// 如果指定了选项，则修复现有图像</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">fix_existing_images</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">image_t</span> <span class="nl">local_image_id</span> <span class="p">:</span> <span class="n">local_bundle</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">existing_image_ids_</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">local_image_id</span><span class="p">))</span>
               <span class="n">ba_config</span><span class="p">.</span><span class="n">SetConstantPose</span><span class="p">(</span><span class="n">local_image_id</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>

      <span class="c1">// 当并非所有注册的图像都在当前局部BA中时，确定要修复的摄像机。</span>
      <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">camera_t</span><span class="p">,</span> <span class="kt">size_t</span><span class="o">&gt;</span> <span class="n">num_images_per_camera</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">image_t</span> <span class="nl">image_id</span> <span class="p">:</span> <span class="n">ba_config</span><span class="p">.</span><span class="n">Images</span><span class="p">())</span> <span class="p">{</span>
         <span class="k">const</span> <span class="n">Image</span><span class="o">&amp;</span> <span class="n">image</span> <span class="o">=</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Image</span><span class="p">(</span><span class="n">image_id</span><span class="p">);</span>
         <span class="n">num_images_per_camera</span><span class="p">[</span><span class="n">image</span><span class="p">.</span><span class="n">CameraId</span><span class="p">()]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="nl">camera_id_and_num_images_pair</span> <span class="p">:</span> <span class="n">num_images_per_camera</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">const</span> <span class="kt">size_t</span> <span class="n">num_reg_images_for_camera</span> <span class="o">=</span>
             <span class="n">num_reg_images_per_camera_</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">camera_id_and_num_images_pair</span><span class="p">.</span><span class="n">first</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">camera_id_and_num_images_pair</span><span class="p">.</span><span class="n">second</span> <span class="o">&lt;</span> <span class="n">num_reg_images_for_camera</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ba_config</span><span class="p">.</span><span class="n">SetConstantCamera</span><span class="p">(</span><span class="n">camera_id_and_num_images_pair</span><span class="p">.</span><span class="n">first</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>

      <span class="c1">// 修复7自由度，以避免在BA调整中出现比例/旋转/平移漂移</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">local_bundle</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">ba_config</span><span class="p">.</span><span class="n">SetConstantPose</span><span class="p">(</span><span class="n">local_bundle</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
         <span class="n">ba_config</span><span class="p">.</span><span class="n">SetConstantTvec</span><span class="p">(</span><span class="n">image_id</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">local_bundle</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">const</span> <span class="n">image_t</span> <span class="n">image_id1</span> <span class="o">=</span> <span class="n">local_bundle</span><span class="p">[</span><span class="n">local_bundle</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
         <span class="k">const</span> <span class="n">image_t</span> <span class="n">image_id2</span> <span class="o">=</span> <span class="n">local_bundle</span><span class="p">[</span><span class="n">local_bundle</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">];</span>
         <span class="n">ba_config</span><span class="p">.</span><span class="n">SetConstantPose</span><span class="p">(</span><span class="n">image_id1</span><span class="p">);</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span><span class="p">.</span><span class="n">fix_existing_images</span> <span class="o">||</span>
             <span class="o">!</span><span class="n">existing_image_ids_</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">image_id2</span><span class="p">))</span> <span class="p">{</span>
           <span class="n">ba_config</span><span class="p">.</span><span class="n">SetConstantTvec</span><span class="p">(</span><span class="n">image_id2</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">});</span>
         <span class="p">}</span>
      <span class="p">}</span>

      <span class="c1">// Make sure, we refine all new and short-track 3D points, no matter if</span>
      <span class="c1">// they are fully contained in the local image set or not. Do not include</span>
      <span class="c1">// long track 3D points as they are usually already very stable and adding</span>
      <span class="c1">// to them to bundle adjustment and track merging/completion would slow</span>
      <span class="c1">// down the local bundle adjustment significantly.</span>

      <span class="c1">// 确保完善所有新的和短轨道的3D点，无论它们是否完全包含在局部图像集中。</span>
      <span class="c1">// 注意: 不要包括长距离3D点，因为它们通常已经非常稳定，将它们添加到BA调整中的轨道合并/完成会大大减慢局部BA调整的速度。</span>
      <span class="n">std</span><span class="o">::</span><span class="n">unordered_set</span><span class="o">&lt;</span><span class="n">point3D_t</span><span class="o">&gt;</span> <span class="n">variable_point3D_ids</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">point3D_t</span> <span class="nl">point3D_id</span> <span class="p">:</span> <span class="n">point3D_ids</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">const</span> <span class="n">Point3D</span><span class="o">&amp;</span> <span class="n">point3D</span> <span class="o">=</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">Point3D</span><span class="p">(</span><span class="n">point3D_id</span><span class="p">);</span>
         <span class="k">const</span> <span class="kt">size_t</span> <span class="n">kMaxTrackLength</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
         <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">point3D</span><span class="p">.</span><span class="n">HasError</span><span class="p">()</span> <span class="o">||</span> <span class="n">point3D</span><span class="p">.</span><span class="n">Track</span><span class="p">().</span><span class="n">Length</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">kMaxTrackLength</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ba_config</span><span class="p">.</span><span class="n">AddVariablePoint</span><span class="p">(</span><span class="n">point3D_id</span><span class="p">);</span>
            <span class="n">variable_point3D_ids</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">point3D_id</span><span class="p">);</span>
         <span class="p">}</span>
      <span class="p">}</span>

      <span class="c1">// 调整局部bundle</span>
      <span class="n">BundleAdjuster</span> <span class="n">bundle_adjuster</span><span class="p">(</span><span class="n">ba_options</span><span class="p">,</span> <span class="n">ba_config</span><span class="p">);</span>
      <span class="n">bundle_adjuster</span><span class="p">.</span><span class="n">Solve</span><span class="p">(</span><span class="n">reconstruction_</span><span class="p">);</span>

      <span class="n">report</span><span class="p">.</span><span class="n">num_adjusted_observations</span> <span class="o">=</span>
         <span class="n">bundle_adjuster</span><span class="p">.</span><span class="n">Summary</span><span class="p">().</span><span class="n">num_residuals</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

      <span class="c1">// 将完善的轨道与其他现有点合并</span>
      <span class="n">report</span><span class="p">.</span><span class="n">num_merged_observations</span> <span class="o">=</span>
         <span class="n">triangulator_</span><span class="o">-&gt;</span><span class="n">MergeTracks</span><span class="p">(</span><span class="n">tri_options</span><span class="p">,</span> <span class="n">variable_point3D_ids</span><span class="p">);</span>

      <span class="c1">// 完整的轨道可能在完善相机位姿和进行BA调整中的校准之前进行三角化会失败</span>
      <span class="c1">// 这样可以避免对某些点进行过滤，并有助于后续的图像配准</span>
      <span class="n">report</span><span class="p">.</span><span class="n">num_completed_observations</span> <span class="o">=</span>
         <span class="n">triangulator_</span><span class="o">-&gt;</span><span class="n">CompleteTracks</span><span class="p">(</span><span class="n">tri_options</span><span class="p">,</span> <span class="n">variable_point3D_ids</span><span class="p">);</span>
      <span class="n">report</span><span class="p">.</span><span class="n">num_completed_observations</span> <span class="o">+=</span>
         <span class="n">triangulator_</span><span class="o">-&gt;</span><span class="n">CompleteImage</span><span class="p">(</span><span class="n">tri_options</span><span class="p">,</span> <span class="n">image_id</span><span class="p">);</span>
   <span class="p">}</span>

   <span class="c1">// 过滤修改的图像和所有更改的3D点，以确保模型中没有异常点。</span>
   <span class="c1">// 这将导致重复工作，因为许多提供的3D点也可能包含在调整后的图像中。</span>
   <span class="n">std</span><span class="o">::</span><span class="n">unordered_set</span><span class="o">&lt;</span><span class="n">image_t</span><span class="o">&gt;</span> <span class="n">filter_image_ids</span><span class="p">;</span>
   <span class="n">filter_image_ids</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">image_id</span><span class="p">);</span>
   <span class="n">filter_image_ids</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">local_bundle</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">local_bundle</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
   <span class="n">report</span><span class="p">.</span><span class="n">num_filtered_observations</span> <span class="o">=</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">FilterPoints3DInImages</span><span class="p">(</span>
      <span class="n">options</span><span class="p">.</span><span class="n">filter_max_reproj_error</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">filter_min_tri_angle</span><span class="p">,</span>
      <span class="n">filter_image_ids</span><span class="p">);</span>
   <span class="n">report</span><span class="p">.</span><span class="n">num_filtered_observations</span> <span class="o">+=</span> <span class="n">reconstruction_</span><span class="o">-&gt;</span><span class="n">FilterPoints3D</span><span class="p">(</span>
      <span class="n">options</span><span class="p">.</span><span class="n">filter_max_reproj_error</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">filter_min_tri_angle</span><span class="p">,</span>
      <span class="n">point3D_ids</span><span class="p">);</span>

   <span class="k">return</span> <span class="n">report</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition attention">
<p class="admonition-title">注意</p>
<p>没看懂， 有空再看。</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../../../../theiasfm.html" class="btn btn-neutral float-right" title="🍑 TheiaSfM" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../../../c_sfm.html" class="btn btn-neutral float-left" title="SfM Pipeline" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; 版权所有 2021, linzzz.

    </p>
  </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>